<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebula API Client - Professional Edition</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              crust: "#11111b",
              base: "#1e1e2e",
              mantle: "#181825",
              lavender: "#b4befe",
              mauve: "#cba6f7",
              blue: "#89b4fa",
              green: "#a6e3a1",
              yellow: "#f9e2af",
              red: "#f38ba8",
              text: "#cdd6f4",
              muted: "#6c7086",
              border: "rgba(180, 190, 254, 0.1)",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
          },
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@faker-js/faker@latest/dist/faker.umd.min.js"></script>
    <style>
      :root {
        color-scheme: dark;
        --crust: #11111b;
        --base: #1e1e2e;
        --mantle: #181825;
        --lavender: #b4befe;
        --mauve: #cba6f7;
        --blue: #89b4fa;
        --green: #a6e3a1;
        --yellow: #f9e2af;
        --red: #f38ba8;
        --text: #cdd6f4;
        --muted: #6c7086;
        --border: rgba(180, 190, 254, 0.1);
        --glass-bg: rgba(30, 30, 46, 0.6);
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, var(--crust), var(--base));
        color: var(--text);
      }

      .glass {
        backdrop-filter: blur(16px);
        background: var(--glass-bg);
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .glass-hover:hover {
        border-color: rgba(180, 190, 254, 0.2);
      }

      .label-text {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--lavender), var(--mauve));
        box-shadow: 0 4px 20px rgba(180, 190, 254, 0.4);
        transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-primary:hover {
        transform: scale(1.02) translateY(-1px);
        box-shadow: 0 6px 26px rgba(180, 190, 254, 0.55);
      }

      .btn-primary:active {
        transform: scale(0.98);
      }

      .btn-disabled {
        opacity: 0.65;
        cursor: not-allowed;
        pointer-events: none;
      }

      .tab-btn {
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: color 200ms cubic-bezier(0.4, 0, 0.2, 1),
          background 200ms cubic-bezier(0.4, 0, 0.2, 1),
          border-color 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .tab-btn.active {
        color: var(--lavender);
        border-bottom-color: var(--lavender);
        background: linear-gradient(
          0deg,
          rgba(180, 190, 254, 0.1),
          transparent
        );
      }

      .tab-btn:hover {
        color: var(--text);
      }

      .line-editor {
        position: relative;
        display: flex;
        height: 100%;
      }

      .line-nums {
        width: 40px;
        color: var(--muted);
        text-align: right;
        padding-right: 8px;
        border-right: 1px solid #313244;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.6;
        user-select: none;
      }

      .line-editor textarea {
        flex: 1;
        background: transparent;
        border: none;
        color: transparent;
        caret-color: var(--text);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.6;
        padding: 0 12px;
        resize: none;
        outline: none;
        position: relative;
        z-index: 2;
      }

      .syntax-layer {
        position: absolute;
        inset: 0;
        padding-left: 40px;
        padding-right: 12px;
        pointer-events: none;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.6;
        color: var(--text);
        z-index: 1;
      }

      .syntax-key {
        color: var(--lavender);
      }

      .syntax-string {
        color: var(--green);
      }

      .syntax-number {
        color: #fab387;
      }

      .syntax-boolean {
        color: var(--blue);
      }

      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        background: rgba(24, 24, 37, 0.9);
        border: 1px solid var(--border);
      }

      .pill.success {
        color: var(--green);
        box-shadow: 0 0 12px rgba(166, 227, 161, 0.3);
      }

      .pill.warn {
        color: var(--yellow);
      }

      .pill.error {
        color: #fab387;
        box-shadow: 0 0 12px rgba(250, 179, 135, 0.3);
      }

      .pill.critical {
        color: var(--red);
        animation: pulse 2s infinite;
        box-shadow: 0 0 12px rgba(243, 139, 168, 0.4);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.03);
        }
      }

      .modal {
        animation: slideUp 300ms ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .toast {
        animation: toastSlide 300ms ease-out;
      }

      @keyframes toastSlide {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .spinner {
        border: 2px solid rgba(180, 190, 254, 0.15);
        border-top-color: var(--lavender);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .shimmer {
        background: linear-gradient(
          90deg,
          rgba(180, 190, 254, 0.05),
          rgba(180, 190, 254, 0.2),
          rgba(180, 190, 254, 0.05)
        );
        background-size: 200% 100%;
        animation: shimmer 1.8s infinite;
      }

      @keyframes shimmer {
        to {
          background-position: -200% 0;
        }
      }

      .skeleton {
        animation: skeletonPulse 2s infinite;
      }

      @keyframes skeletonPulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      .method-badge {
        font-size: 10px;
        font-weight: 700;
        border-radius: 8px;
        padding: 2px 6px;
        color: #0b0b12;
      }

      .method-GET {
        background: var(--green);
      }

      .method-POST {
        background: var(--blue);
      }

      .method-PUT {
        background: var(--yellow);
      }

      .method-DELETE {
        background: var(--red);
      }

      .method-PATCH {
        background: var(--mauve);
      }

      .method-badge:hover {
        filter: brightness(1.1);
      }

      .context-menu {
        min-width: 200px;
        z-index: 50;
      }

      .kbd {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: rgba(24, 24, 37, 0.9);
        color: var(--muted);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
      }

      .status-dot.pulse {
        animation: pulse 1.5s infinite;
      }

      .tab-panel {
        transition: opacity 150ms ease;
      }

      .tab-panel.hidden {
        display: block;
        opacity: 0;
        pointer-events: none;
        height: 0;
        overflow: hidden;
      }

      .waterfall-bar {
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--lavender), transparent);
      }

      .shake {
        animation: shake 0.4s linear;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-4px);
        }
      }

      .badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(24, 24, 37, 0.8);
      }

      .text-red {
        color: var(--red);
      }

      .text-green {
        color: var(--green);
      }

      .text-blue {
        color: var(--blue);
      }

      .text-yellow {
        color: var(--yellow);
      }

      .text-lavender {
        color: var(--lavender);
      }

      .bg-red {
        background-color: var(--red);
      }

      .bg-green {
        background-color: var(--green);
      }

      .bg-yellow {
        background-color: var(--yellow);
      }

      .bg-muted {
        background-color: var(--muted);
      }

      .border-lavender {
        border-color: var(--lavender);
      }

      .border-yellow {
        border: 1px solid rgba(249, 226, 175, 0.6);
        box-shadow: 0 0 20px rgba(249, 226, 175, 0.25);
        animation: pulse 2s infinite;
      }

      .hover-card:hover {
        transform: translateY(-2px);
        border-color: rgba(180, 190, 254, 0.2);
      }

      .transition-base {
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .sidebar-collapsed {
        width: 0;
        min-width: 0;
        padding: 0;
        overflow: hidden;
      }

      .tooltip {
        position: absolute;
        z-index: 40;
        background: rgba(24, 24, 37, 0.95);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
      }

      .autocomplete {
        position: absolute;
        z-index: 45;
        background: rgba(24, 24, 37, 0.98);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        font-size: 12px;
        color: var(--text);
        max-height: 160px;
        overflow-y: auto;
        min-width: 220px;
      }

      .copy-flash {
        animation: copyFlash 0.8s ease;
      }

      @keyframes copyFlash {
        0% {
          box-shadow: 0 0 0 rgba(180, 190, 254, 0.0);
        }
        50% {
          box-shadow: 0 0 12px rgba(180, 190, 254, 0.5);
        }
        100% {
          box-shadow: 0 0 0 rgba(180, 190, 254, 0.0);
        }
      }

      @media (max-width: 768px) {
        #sidebar {
          position: fixed;
          left: 0;
          top: 56px;
          height: calc(100vh - 56px);
          z-index: 30;
          transform: translateX(-100%);
          transition: transform 300ms ease;
        }

        #sidebar.open {
          transform: translateX(0);
        }

        #sidebarOverlay {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="min-h-screen flex flex-col">
      <header class="glass h-14 flex items-center justify-between px-6">
        <div class="flex items-center gap-3">
          <div class="text-base font-semibold">Nebula API Client</div>
          <span class="badge">Professional Edition</span>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="sidebarToggle"
            class="glass-hover transition-base px-3 py-2 rounded-lg border border-border"
          >
            Sidebar
          </button>
          <button
            id="commandPaletteBtn"
            class="glass-hover transition-base px-3 py-2 rounded-lg border border-border"
          >
            Command Palette
            <span class="kbd ml-2">&#8984;P / Ctrl+P</span>
          </button>
          <div class="flex items-center gap-2">
            <button
              id="interceptorToggle"
              class="glass-hover transition-base px-3 py-2 rounded-lg border border-border flex items-center gap-2"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="11" width="18" height="11" rx="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              Interceptor
              <span
                id="interceptorIndicator"
                class="status-dot bg-muted"
              ></span>
            </button>
            <select
              id="interceptorMode"
              class="glass-hover transition-base px-3 py-2 rounded-lg border border-border text-sm bg-transparent"
            >
              <option value="request">Request Interception</option>
              <option value="response">Response Interception</option>
              <option value="both">Request + Response</option>
            </select>
          </div>
          <button
            id="quickSearchBtn"
            class="glass-hover transition-base px-3 py-2 rounded-lg border border-border"
          >
            Quick Search
            <span class="kbd ml-2">&#8984;K</span>
          </button>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black/40 z-20"></div>
        <aside
          id="sidebar"
          class="glass w-80 p-4 flex flex-col gap-4 overflow-hidden transition-base"
        >
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">Collections</div>
            <button id="addCollectionBtn" class="kbd">+ New</button>
          </div>
          <div id="collectionTree" class="flex-1 overflow-y-auto pr-1"></div>

          <div class="glass p-3 rounded-xl space-y-2">
            <div class="label-text">Collection Tools</div>
            <div class="flex flex-wrap gap-2">
              <button id="importCurlBtn" class="kbd">Import cURL</button>
              <button id="importPostmanBtn" class="kbd">Import Postman</button>
              <input id="postmanFile" type="file" class="hidden" accept=".json" />
              <button id="exportJsonBtn" class="kbd">Export JSON</button>
              <button id="exportOpenapiBtn" class="kbd">Export OpenAPI</button>
              <button id="exportHarBtn" class="kbd">Export HAR</button>
            </div>
          </div>

          <div class="glass p-3 rounded-xl">
            <div class="label-text mb-2">Favorites</div>
            <div id="favoriteList" class="space-y-2 text-xs"></div>
          </div>

          <div class="glass p-3 rounded-xl">
            <div class="label-text mb-2">History (Last 50)</div>
            <input
              id="historySearch"
              class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm"
              placeholder="Search history..."
            />
            <div
              id="historyList"
              class="mt-2 max-h-40 overflow-y-auto space-y-2"
            ></div>
          </div>

          <div class="glass p-3 rounded-xl space-y-3">
            <div class="label-text">Environment</div>
            <div class="flex items-center gap-2">
              <span id="envDot" class="status-dot bg-green"></span>
              <select
                id="envSelect"
                class="flex-1 bg-transparent border border-border rounded-lg px-3 py-2 text-sm"
              >
                <option value="development">Development</option>
                <option value="staging">Staging</option>
                <option value="production">Production</option>
              </select>
              <button id="envEditBtn" class="kbd">Edit</button>
            </div>
            <div class="text-xs text-muted">
              Use {{variable}} in inputs. Hover to preview.
            </div>
          </div>

          <div class="glass p-3 rounded-xl space-y-2">
            <div class="label-text">Interceptor Stats</div>
            <div class="grid grid-cols-3 gap-2 text-xs">
              <div class="glass p-2 rounded-lg text-center">
                <div id="statIntercepted" class="text-base font-semibold">0</div>
                <div class="text-muted">Intercepted</div>
              </div>
              <div class="glass p-2 rounded-lg text-center">
                <div id="statModified" class="text-base font-semibold">0</div>
                <div class="text-muted">Modified</div>
              </div>
              <div class="glass p-2 rounded-lg text-center">
                <div id="statBlocked" class="text-base font-semibold">0</div>
                <div class="text-muted">Blocked</div>
              </div>
            </div>
          </div>
        </aside>

        <main class="flex-1 overflow-hidden p-4 flex flex-col gap-4">
          <div
            class="glass p-3 rounded-xl flex items-center gap-3 flex-wrap"
            data-tab-group="workspace"
          >
            <button class="tab-btn px-3 py-2 active" data-tab-target="http">
              HTTP Client
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="websocket">
              WebSocket
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="loadtest">
              Load Testing
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="graphql">
              GraphQL
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="docs">
              API Docs
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="diff">
              Diff Viewer
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="chain">
              Request Chain
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="security">
              Security Scanner
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="retry">
              Auto-Retry
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="data">
              Data Generator
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="collab">
              Collaboration
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="profiler">
              Profiler
            </button>
            <button class="tab-btn px-3 py-2" data-tab-target="mock">
              Mock Server
            </button>
          </div>

          <section id="panel-http" data-tab-panel="http" data-tab-scope="workspace" class="tab-panel flex-1 flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex flex-col gap-3" style="height: 40%;">
              <div class="flex items-center gap-3">
                <div class="relative">
                  <select
                    id="methodSelect"
                    class="w-32 px-3 py-2 rounded-xl font-semibold border border-border bg-transparent"
                  >
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                  </select>
                </div>
                <div class="flex-1 flex items-center gap-2 glass rounded-xl px-3 py-2 border border-border focus-within:ring-2 focus-within:ring-lavender/40 transition-base">
                  <input
                    id="urlInput"
                    class="flex-1 bg-transparent outline-none font-mono text-sm"
                    placeholder="https://api.example.com/v1/resource"
                  />
                  <button id="clearUrlBtn" class="kbd">X</button>
                  <button id="saveUrlBtn" class="kbd">Save ðŸ’¾</button>
                </div>
                <button id="sendBtn" class="btn-primary text-sm font-semibold px-5 py-2 rounded-xl flex items-center gap-2">
                  <span>Send</span>
                  <sup class="text-xs text-white/80">&#8984;&#8629;</sup>
                  <span id="sendSpinner" class="spinner hidden"></span>
                </button>
              </div>

              <div class="flex items-center gap-4 border-b border-[#313244]" data-tab-group="request">
                <button class="tab-btn px-3 py-2 active" data-tab-target="params">
                  Params <span class="badge" id="paramsCount">0</span>
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="headers">
                  Headers <span class="badge" id="headersCount">0</span>
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="body">
                  Body <span class="badge" id="bodyCount">0</span>
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="auth">
                  Auth
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="tests">
                  Tests
                </button>
              </div>

              <div class="flex-1 overflow-hidden">
                <div data-tab-panel="params" data-tab-scope="request" class="tab-panel h-full flex flex-col gap-2">
                  <div class="label-text">Query Parameters (key=value)</div>
                  <div class="line-editor glass rounded-xl overflow-hidden">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea
                      id="paramsEditor"
                      data-language="kv"
                      placeholder="page=1&#10;limit=25"
                    ></textarea>
                  </div>
                </div>
                <div data-tab-panel="headers" data-tab-scope="request" class="tab-panel h-full hidden flex flex-col gap-2">
                  <div class="label-text">Headers (JSON)</div>
                  <div class="line-editor glass rounded-xl overflow-hidden">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea
                      id="headersEditor"
                      data-language="json"
                      placeholder='{"Authorization":"Bearer {{token}}"}'
                    ></textarea>
                  </div>
                </div>
                <div data-tab-panel="body" data-tab-scope="request" class="tab-panel h-full hidden flex flex-col gap-2">
                  <div class="flex items-center justify-between">
                    <div class="label-text">Body (JSON/XML/HTML/SQL)</div>
                    <div class="flex items-center gap-2">
                      <button id="formatJsonBtn" class="kbd">&#8984;Shift+F</button>
                      <button id="clearBodyBtn" class="kbd">Clear</button>
                    </div>
                  </div>
                  <div class="line-editor glass rounded-xl overflow-hidden">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea
                      id="bodyEditor"
                      data-language="json"
                      placeholder='{"message":"Hello Nebula"}'
                    ></textarea>
                  </div>
                  <div
                    id="fileDrop"
                    class="glass rounded-xl p-3 border border-dashed border-border text-sm text-muted text-center"
                  >
                    Drag & drop files here to upload or click to select.
                    <input id="fileInput" type="file" class="hidden" multiple />
                  </div>
                </div>
                <div data-tab-panel="auth" data-tab-scope="request" class="tab-panel h-full hidden flex flex-col gap-2">
                  <div class="label-text">Auth</div>
                  <div class="grid grid-cols-2 gap-3">
                    <input
                      id="authType"
                      class="bg-transparent border border-border rounded-lg px-3 py-2 text-sm"
                      placeholder="Bearer / Basic / API Key"
                    />
                    <input
                      id="authValue"
                      class="bg-transparent border border-border rounded-lg px-3 py-2 text-sm"
                      placeholder="Token / Username:Password"
                    />
                  </div>
                </div>
                <div data-tab-panel="tests" data-tab-scope="request" class="tab-panel h-full hidden flex flex-col gap-2">
                  <div class="label-text">Pre-request Script</div>
                  <div class="line-editor glass rounded-xl overflow-hidden h-32">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea
                      id="preRequestEditor"
                      data-language="js"
                      placeholder="pm.environment.set('token', 'abc123');"
                    ></textarea>
                  </div>
                  <div class="label-text">Test Script</div>
                  <div class="line-editor glass rounded-xl overflow-hidden h-32">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea
                      id="testEditor"
                      data-language="js"
                      placeholder="pm.test('status is 200', () => pm.response.to.have.status(200));"
                    ></textarea>
                  </div>
                  <div class="glass rounded-xl p-2 h-24 overflow-y-auto">
                    <div class="label-text">Console Output</div>
                    <div id="scriptConsole" class="text-xs font-mono"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="glass rounded-xl p-4 flex flex-col gap-3 flex-1" style="height: 60%;">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div id="statusPill" class="pill">---</div>
                  <div id="timePill" class="pill">---</div>
                  <div id="sizePill" class="pill">---</div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="clearResponseBtn" class="kbd">&#8984;Shift+C</button>
                  <button id="copyResponseBtn" class="kbd">Copy</button>
                </div>
              </div>
              <div class="flex items-center gap-4 border-b border-[#313244]" data-tab-group="response">
                <button class="tab-btn px-3 py-2 active" data-tab-target="body">
                  Body
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="headers">
                  Headers
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="cookies">
                  Cookies
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="timeline">
                  Timeline
                </button>
                <button class="tab-btn px-3 py-2" data-tab-target="tests">
                  Tests
                </button>
              </div>
              <div class="flex-1 overflow-hidden">
                <div data-tab-panel="body" data-tab-scope="response" class="tab-panel h-full">
                  <div id="responseViewer" class="line-editor glass rounded-xl overflow-hidden h-full">
                    <div class="line-nums" data-line-numbers></div>
                    <pre class="syntax-layer" data-syntax-layer></pre>
                    <textarea id="responseBody" data-language="json" readonly></textarea>
                  </div>
                  <div id="responseWarning" class="text-xs text-yellow mt-2 hidden"></div>
                  <div id="responseVirtualControls" class="hidden glass rounded-xl p-2 mt-2 text-xs flex items-center gap-2">
                    <span class="text-muted">Virtual Scroll</span>
                    <input id="responseVirtualRange" type="range" min="0" max="0" value="0" class="flex-1 accent-lavender" />
                    <span id="responseVirtualLabel" class="text-muted">Lines 0-0</span>
                  </div>
                </div>
                <div data-tab-panel="headers" data-tab-scope="response" class="tab-panel h-full hidden">
                  <pre id="responseHeaders" class="glass rounded-xl p-3 text-xs font-mono h-full overflow-auto"></pre>
                </div>
                <div data-tab-panel="cookies" data-tab-scope="response" class="tab-panel h-full hidden">
                  <pre id="responseCookies" class="glass rounded-xl p-3 text-xs font-mono h-full overflow-auto"></pre>
                </div>
                <div data-tab-panel="timeline" data-tab-scope="response" class="tab-panel h-full hidden">
                  <div class="glass rounded-xl p-3 space-y-2">
                    <div class="label-text">Performance Timeline</div>
                    <div class="text-xs text-muted">DNS / TCP / TLS / TTFB / Download</div>
                    <div class="space-y-2" id="timelineBars"></div>
                  </div>
                </div>
                <div data-tab-panel="tests" data-tab-scope="response" class="tab-panel h-full hidden">
                  <div id="testResults" class="glass rounded-xl p-3 space-y-2 h-full overflow-auto"></div>
                </div>
              </div>
            </div>

            <div class="glass rounded-xl p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="text-sm font-semibold">Interceptor Log</div>
                <button id="clearInterceptorLog" class="kbd">Clear</button>
              </div>
              <div id="interceptorLog" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
          </section>

          <section id="panel-websocket" data-tab-panel="websocket" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 space-y-3">
              <div class="label-text">Connection</div>
              <div class="flex items-center gap-3 flex-wrap">
                <input
                  id="wsUrl"
                  class="flex-1 bg-transparent border border-border rounded-lg px-3 py-2 text-sm font-mono"
                  placeholder="wss://echo.websocket.events"
                />
                <button id="wsToggle" class="btn-primary px-4 py-2 rounded-xl text-sm">
                  Connect
                </button>
                <span id="wsStatusDot" class="status-dot bg-muted"></span>
                <span id="wsStatusText" class="text-sm text-muted">Disconnected</span>
                <label class="flex items-center gap-2 text-xs text-muted">
                  <input id="wsReconnect" type="checkbox" class="accent-lavender" />
                  Reconnect with backoff
                </label>
              </div>
              <div class="text-xs text-muted flex items-center gap-4">
                <span>Latency: <span id="wsLatency">-</span></span>
                <span>Sent: <span id="wsSent">0</span></span>
                <span>Received: <span id="wsReceived">0</span></span>
                <span>Heartbeat: <span id="wsHeartbeat">Idle</span></span>
              </div>
            </div>
            <div class="flex gap-4 flex-1 overflow-hidden">
              <div class="glass rounded-xl p-4 flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-2">
                  <div class="label-text">Message Log</div>
                  <div class="flex gap-2">
                    <button id="wsClear" class="kbd">Clear</button>
                    <button id="wsExport" class="kbd">Export</button>
                  </div>
                </div>
                <div id="wsLog" class="flex-1 overflow-y-auto space-y-2 text-xs font-mono"></div>
              </div>
              <div class="glass rounded-xl p-4 w-1/3 flex flex-col gap-3">
                <div class="label-text">Compose Message</div>
                <select
                  id="wsFormat"
                  class="bg-transparent border border-border rounded-lg px-3 py-2 text-sm"
                >
                  <option value="json">JSON</option>
                  <option value="text">Text</option>
                  <option value="binary">Binary (Base64)</option>
                </select>
                <div class="line-editor glass rounded-xl overflow-hidden flex-1">
                  <div class="line-nums" data-line-numbers></div>
                  <pre class="syntax-layer" data-syntax-layer></pre>
                  <textarea
                    id="wsEditor"
                    data-language="json"
                    placeholder='{"type":"ping"}'
                  ></textarea>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                  <button id="wsSend" class="btn-primary px-4 py-2 rounded-xl text-sm">
                    Send (Ctrl+Enter)
                  </button>
                  <button id="wsPing" class="kbd">Ping</button>
                  <button id="wsTemplate" class="kbd">Template</button>
                </div>
              </div>
            </div>
          </section>

          <section id="panel-loadtest" data-tab-panel="loadtest" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4">
              <div class="label-text mb-3">Load Testing Configuration</div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                <select id="loadProfile" class="bg-transparent border border-border rounded-lg px-3 py-2">
                  <option value="spike">Spike</option>
                  <option value="ramp">Ramp-up</option>
                  <option value="soak">Soak</option>
                  <option value="stress">Stress</option>
                  <option value="custom">Custom</option>
                </select>
                <input id="loadTarget" class="bg-transparent border border-border rounded-lg px-3 py-2 font-mono" placeholder="Target URL" />
                <input id="loadTotal" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Total Requests" value="100" />
                <input id="loadConcurrency" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Concurrency" value="5" />
                <input id="loadRamp" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Ramp-up (s)" value="5" />
                <input id="loadTimeout" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Timeout (ms)" value="5000" />
                <label class="flex items-center gap-2 text-xs text-muted">
                  <input id="loadKeepAlive" type="checkbox" class="accent-lavender" checked />
                  Keep-alive
                </label>
                <label class="flex items-center gap-2 text-xs text-muted">
                  <input id="loadRandomize" type="checkbox" class="accent-lavender" />
                  Randomize payload
                </label>
                <label class="flex items-center gap-2 text-xs text-muted">
                  <input id="loadRedirects" type="checkbox" class="accent-lavender" />
                  Follow redirects
                </label>
              </div>
              <div class="flex items-center gap-3 mt-4">
                <button id="loadStart" class="btn-primary px-4 py-2 rounded-xl text-sm">Start (Space)</button>
                <button id="loadPause" class="kbd">Pause</button>
                <button id="loadCancel" class="kbd text-red">Cancel (Esc)</button>
                <div class="flex-1 relative h-3 rounded-full bg-[#232338] overflow-hidden">
                  <div id="loadProgress" class="h-full w-0 shimmer"></div>
                  <span id="loadProgressText" class="absolute inset-0 text-xs text-center text-white/80">0%</span>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
              <div class="glass p-3 rounded-xl hover-card transition-base">
                <div class="label-text">RPS</div>
                <div id="metricRps" class="text-2xl font-semibold text-lavender">0</div>
              </div>
              <div class="glass p-3 rounded-xl hover-card transition-base">
                <div class="label-text">Avg Latency</div>
                <div id="metricAvg" class="text-xl font-semibold">0 ms</div>
                <div id="metricAvgMinMax" class="text-xs text-muted">min 0 / max 0</div>
              </div>
              <div class="glass p-3 rounded-xl hover-card transition-base">
                <div class="label-text">P95 Latency</div>
                <div id="metricP95" class="text-xl font-semibold text-[#fab387]">0 ms</div>
              </div>
              <div class="glass p-3 rounded-xl hover-card transition-base">
                <div class="label-text">Error Rate</div>
                <div id="metricError" class="text-xl font-semibold text-red">0%</div>
                <div id="metricErrorCount" class="text-xs text-muted">0 errors</div>
              </div>
              <div class="glass p-3 rounded-xl hover-card transition-base">
                <div class="label-text">Throughput</div>
                <div id="metricThroughput" class="text-xl font-semibold">0 KB/s</div>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1">
              <div class="glass p-4 rounded-xl">
                <div class="label-text mb-2">Latency Distribution</div>
                <canvas id="latencyChart" height="180"></canvas>
              </div>
              <div class="glass p-4 rounded-xl">
                <div class="label-text mb-2">RPS Timeline</div>
                <canvas id="rpsChart" height="180"></canvas>
              </div>
            </div>
            <div class="glass p-4 rounded-xl">
              <div class="flex items-center justify-between mb-2">
                <div class="label-text">Test Results</div>
                <button id="exportCsv" class="kbd">Export CSV</button>
              </div>
              <div class="max-h-48 overflow-y-auto">
                <table class="w-full text-xs">
                  <thead class="text-muted">
                    <tr>
                      <th class="text-left py-2">#</th>
                      <th class="text-left py-2">Status</th>
                      <th class="text-left py-2">Time (ms)</th>
                      <th class="text-left py-2">Size</th>
                      <th class="text-left py-2">Timestamp</th>
                    </tr>
                  </thead>
                  <tbody id="loadResults"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="panel-graphql" data-tab-panel="graphql" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">GraphQL Support</div>
                <div class="text-xs text-muted">Schema introspection, variables, and tabs.</div>
              </div>
              <div class="flex items-center gap-2">
                <input id="graphqlUrl" class="bg-transparent border border-border rounded-lg px-3 py-2 text-sm font-mono" placeholder="https://api.example.com/graphql" />
                <button id="graphqlIntrospect" class="kbd">Introspect</button>
                <button id="graphqlSend" class="btn-primary px-4 py-2 rounded-xl text-sm">Run</button>
              </div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="flex items-center gap-4 border-b border-[#313244]" data-tab-group="graphql">
                <button class="tab-btn px-3 py-2 active" data-tab-target="query">Query</button>
                <button class="tab-btn px-3 py-2" data-tab-target="mutation">Mutation</button>
                <button class="tab-btn px-3 py-2" data-tab-target="subscription">Subscription</button>
                <button class="tab-btn px-3 py-2" data-tab-target="variables">Variables</button>
              </div>
              <div class="mt-3 grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <div data-tab-panel="query" data-tab-scope="graphql" class="tab-panel h-64">
                    <div class="line-editor glass rounded-xl overflow-hidden h-full">
                      <div class="line-nums" data-line-numbers></div>
                      <pre class="syntax-layer" data-syntax-layer></pre>
                      <textarea id="graphqlQuery" data-language="graphql" placeholder="query { viewer { id name } }"></textarea>
                    </div>
                  </div>
                  <div data-tab-panel="mutation" data-tab-scope="graphql" class="tab-panel h-64 hidden">
                    <div class="line-editor glass rounded-xl overflow-hidden h-full">
                      <div class="line-nums" data-line-numbers></div>
                      <pre class="syntax-layer" data-syntax-layer></pre>
                      <textarea id="graphqlMutation" data-language="graphql" placeholder="mutation { updateUser(id: 1) { id } }"></textarea>
                    </div>
                  </div>
                  <div data-tab-panel="subscription" data-tab-scope="graphql" class="tab-panel h-64 hidden">
                    <div class="line-editor glass rounded-xl overflow-hidden h-full">
                      <div class="line-nums" data-line-numbers></div>
                      <pre class="syntax-layer" data-syntax-layer></pre>
                      <textarea id="graphqlSubscription" data-language="graphql" placeholder="subscription { onMessage { id text } }"></textarea>
                    </div>
                  </div>
                  <div data-tab-panel="variables" data-tab-scope="graphql" class="tab-panel h-64 hidden">
                    <div class="line-editor glass rounded-xl overflow-hidden h-full">
                      <div class="line-nums" data-line-numbers></div>
                      <pre class="syntax-layer" data-syntax-layer></pre>
                      <textarea id="graphqlVariables" data-language="json" placeholder='{"id":1}'></textarea>
                    </div>
                  </div>
                </div>
                <div class="glass rounded-xl p-3 h-64 overflow-auto">
                  <div class="label-text">Schema Preview</div>
                  <pre id="graphqlSchema" class="text-xs font-mono mt-2"></pre>
                </div>
              </div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="label-text">Response</div>
              <pre id="graphqlResponse" class="text-xs font-mono mt-2 max-h-64 overflow-auto"></pre>
            </div>
          </section>

          <section id="panel-docs" data-tab-panel="docs" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">API Documentation Generator</div>
                <div class="text-xs text-muted">Generate docs from collections and history.</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="docsGenerate" class="btn-primary px-4 py-2 rounded-xl text-sm">Generate</button>
                <button id="docsExport" class="kbd">Export Markdown</button>
                <button id="docsExportHtml" class="kbd">Export HTML</button>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Markdown</div>
                <textarea id="docsMarkdown" class="w-full h-96 bg-transparent border border-border rounded-lg p-3 font-mono text-xs"></textarea>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Preview</div>
                <div id="docsPreview" class="prose prose-invert max-w-none text-sm"></div>
              </div>
            </div>
          </section>

          <section id="panel-diff" data-tab-panel="diff" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div class="text-sm font-semibold">Diff Viewer</div>
              <div class="flex gap-2">
                <button id="diffRun" class="btn-primary px-4 py-2 rounded-xl text-sm">Compare</button>
                <button id="diffSave" class="kbd">Save Snapshot</button>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Response A</div>
                <textarea id="diffLeft" class="w-full h-72 bg-transparent border border-border rounded-lg p-3 font-mono text-xs"></textarea>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Response B</div>
                <textarea id="diffRight" class="w-full h-72 bg-transparent border border-border rounded-lg p-3 font-mono text-xs"></textarea>
              </div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="label-text">Diff Output</div>
              <div id="diffOutput" class="text-xs font-mono mt-2"></div>
              <div id="diffSnapshots" class="mt-4 space-y-2"></div>
            </div>
          </section>

          <section id="panel-chain" data-tab-panel="chain" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Request Chaining</div>
                <div class="text-xs text-muted">Extract variables and branch logic.</div>
              </div>
              <button id="chainAdd" class="kbd">Add Node</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-1">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Chain Builder</div>
                <div id="chainNodes" class="space-y-2 mt-2"></div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Extraction</div>
                <input id="chainJsonPath" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm font-mono" placeholder="$.data.id" />
                <input id="chainVarName" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm mt-2" placeholder="variableName" />
                <button id="chainExtract" class="btn-primary px-4 py-2 rounded-xl text-sm mt-3">Extract From Last Response</button>
                <div id="chainVars" class="text-xs text-muted mt-2"></div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Conditional Branch</div>
                <input id="chainCondition" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm" placeholder="if status == 200" />
                <textarea id="chainAction" class="w-full h-40 bg-transparent border border-border rounded-lg p-3 font-mono text-xs mt-2" placeholder="then run step 2"></textarea>
                <button id="chainSave" class="kbd mt-2">Save Branch</button>
              </div>
            </div>
          </section>

          <section id="panel-security" data-tab-panel="security" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Security Scanner</div>
                <div class="text-xs text-muted">SQLi, XSS, JWT analysis.</div>
              </div>
              <button id="securityScan" class="btn-primary px-4 py-2 rounded-xl text-sm">Run Scan</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Findings</div>
                <div id="securityResults" class="text-xs mt-2 space-y-2"></div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">JWT Analyzer</div>
                <textarea id="jwtInput" class="w-full h-32 bg-transparent border border-border rounded-lg p-3 font-mono text-xs" placeholder="eyJhbGciOi..."></textarea>
                <button id="jwtDecode" class="kbd mt-2">Decode</button>
                <pre id="jwtOutput" class="text-xs font-mono mt-2"></pre>
              </div>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="label-text">SSL Certificate Info</div>
              <div id="sslInfo" class="text-xs text-muted mt-2">Use HTTPS endpoints to view certificate metadata when available.</div>
            </div>
          </section>

          <section id="panel-retry" data-tab-panel="retry" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4">
              <div class="label-text mb-2">Auto-Retry Logic</div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                <input id="retryAttempts" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Max Attempts" value="3" />
                <input id="retryBackoff" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Backoff (ms)" value="500" />
                <input id="retryCodes" class="bg-transparent border border-border rounded-lg px-3 py-2" placeholder="Retry Codes (502,503,504)" value="502,503,504" />
                <label class="flex items-center gap-2 text-xs text-muted">
                  <input id="retryCircuit" type="checkbox" class="accent-lavender" />
                  Circuit breaker (pause on failures)
                </label>
              </div>
              <div id="retryStatus" class="text-xs text-muted mt-2"></div>
            </div>
          </section>

          <section id="panel-data" data-tab-panel="data" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Data Generator</div>
                <div class="text-xs text-muted">Faker templates, CSV import, dynamic rules.</div>
              </div>
              <button id="dataGenerate" class="btn-primary px-4 py-2 rounded-xl text-sm">Generate</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 flex-1">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Template</div>
                <textarea id="dataTemplate" class="w-full h-64 bg-transparent border border-border rounded-lg p-3 font-mono text-xs" placeholder='{"name":"{{person.fullName}}","email":"{{internet.email}}","id":"{{string.uuid}}"}'></textarea>
                <input id="dataCsv" type="file" class="mt-3 text-xs text-muted" />
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Generated Output</div>
                <textarea id="dataOutput" class="w-full h-64 bg-transparent border border-border rounded-lg p-3 font-mono text-xs"></textarea>
              </div>
            </div>
          </section>

          <section id="panel-collab" data-tab-panel="collab" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Collaboration</div>
                <div class="text-xs text-muted">Share links, comments, audit log.</div>
              </div>
              <button id="shareRequest" class="btn-primary px-4 py-2 rounded-xl text-sm">Share Request</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-1">
              <div class="glass rounded-xl p-4">
                <div class="label-text">Team Workspace</div>
                <div id="teamWorkspace" class="text-xs text-muted mt-2">Workspace: Nebula Team</div>
                <button id="syncWorkspace" class="kbd mt-3">Sync Collections</button>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Comments</div>
                <textarea id="commentInput" class="w-full h-32 bg-transparent border border-border rounded-lg p-3 text-xs"></textarea>
                <button id="commentAdd" class="kbd mt-2">Add Comment</button>
                <div id="commentList" class="text-xs mt-2 space-y-2"></div>
              </div>
              <div class="glass rounded-xl p-4">
                <div class="label-text">Audit Log</div>
                <div id="auditLog" class="text-xs mt-2 space-y-2"></div>
              </div>
            </div>
          </section>

          <section id="panel-profiler" data-tab-panel="profiler" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Performance Profiler</div>
                <div class="text-xs text-muted">DNS, TCP, TLS, TTFB, Download.</div>
              </div>
              <button id="profilerRefresh" class="kbd">Refresh</button>
            </div>
            <div class="glass rounded-xl p-4">
              <div class="label-text">Metrics</div>
              <div id="profilerMetrics" class="grid grid-cols-1 md:grid-cols-5 gap-3 text-xs mt-3"></div>
              <div class="label-text mt-4">Waterfall</div>
              <div id="profilerWaterfall" class="space-y-2 mt-2"></div>
            </div>
          </section>

          <section id="panel-mock" data-tab-panel="mock" data-tab-scope="workspace" class="tab-panel flex-1 hidden flex flex-col gap-4">
            <div class="glass rounded-xl p-4 flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold">Mock Server</div>
                <div class="text-xs text-muted">Create endpoints with latency & conditions.</div>
              </div>
              <button id="mockAdd" class="btn-primary px-4 py-2 rounded-xl text-sm">Add Mock Route</button>
            </div>
            <div class="glass rounded-xl p-4">
              <div id="mockRoutes" class="space-y-3"></div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <div
      id="commandPalette"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40"
    >
      <div class="glass rounded-xl p-4 w-[600px] modal">
        <div class="label-text">Command Palette</div>
        <input
          id="commandInput"
          class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm mt-2"
          placeholder="Type a command..."
        />
        <div id="commandList" class="mt-3 space-y-2 text-sm"></div>
      </div>
    </div>

    <div
      id="breakpointModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40"
    >
      <div class="glass rounded-xl p-6 w-[800px] modal border-yellow">
        <div class="flex items-center justify-between mb-3">
          <div>
            <div class="text-sm font-semibold">Breakpoint Interceptor</div>
            <div class="text-xs text-muted">Edit request/response and resume.</div>
          </div>
          <span class="badge text-yellow">Paused</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <select id="breakpointMethod" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm">
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>DELETE</option>
              <option>PATCH</option>
            </select>
            <input id="breakpointStatus" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm hidden" placeholder="Status (e.g. 200)" />
            <input id="breakpointUrl" class="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm font-mono" />
            <div class="line-editor glass rounded-xl overflow-hidden h-32">
              <div class="line-nums" data-line-numbers></div>
              <pre class="syntax-layer" data-syntax-layer></pre>
              <textarea id="breakpointHeaders" data-language="json" placeholder='{"header":"value"}'></textarea>
            </div>
          </div>
          <div class="space-y-2">
            <div class="line-editor glass rounded-xl overflow-hidden h-40">
              <div class="line-nums" data-line-numbers></div>
              <pre class="syntax-layer" data-syntax-layer></pre>
              <textarea id="breakpointBody" data-language="json" placeholder="{}"></textarea>
            </div>
            <div class="flex items-center gap-2 justify-end">
              <button id="breakpointAbort" class="kbd text-red">Abort</button>
              <button id="breakpointDrop" class="kbd">Drop</button>
              <button id="breakpointResume" class="btn-primary px-4 py-2 rounded-xl text-sm">Resume (F10)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="envModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40"
    >
      <div class="glass rounded-xl p-6 w-[700px] modal">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold">Environment Variables</div>
          <button id="envModalClose" class="kbd">Close</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <div class="label-text">Global</div>
            <div id="envGlobal" class="space-y-2 mt-2"></div>
            <button data-env-add="global" class="kbd mt-2">Add</button>
          </div>
          <div>
            <div class="label-text">Environment</div>
            <div id="envScoped" class="space-y-2 mt-2"></div>
            <button data-env-add="scoped" class="kbd mt-2">Add</button>
          </div>
          <div>
            <div class="label-text">Session</div>
            <div id="envSession" class="space-y-2 mt-2"></div>
            <button data-env-add="session" class="kbd mt-2">Add</button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="curlModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 z-40"
    >
      <div class="glass rounded-xl p-6 w-[700px] modal">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm font-semibold">Import cURL</div>
          <button id="curlModalClose" class="kbd">Close</button>
        </div>
        <textarea
          id="curlInput"
          class="w-full h-40 bg-transparent border border-border rounded-lg p-3 font-mono text-xs"
          placeholder="curl -X GET https://api.example.com -H 'Authorization: Bearer token'"
        ></textarea>
        <div class="flex justify-end mt-3">
          <button id="curlImport" class="btn-primary px-4 py-2 rounded-xl text-sm">
            Import
          </button>
        </div>
      </div>
    </div>

    <div id="contextMenu" class="context-menu glass rounded-xl p-2 hidden fixed z-50">
      <button data-action="edit" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Edit</button>
      <button data-action="rename" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Rename</button>
      <button data-action="duplicate" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Duplicate</button>
      <button data-action="delete" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Delete</button>
      <button data-action="export" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Export</button>
      <button data-action="move" class="w-full text-left px-3 py-2 text-sm hover:bg-[#232338] rounded-lg">Move</button>
    </div>

    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <div id="variableTooltip" class="tooltip hidden"></div>
    <div id="varAutocomplete" class="autocomplete hidden"></div>
    <div id="graphqlAutocomplete" class="autocomplete hidden"></div>

    <script>
      const state = {
        interceptorEnabled: false,
        interceptorMode: "request",
        interceptorStats: { intercepted: 0, modified: 0, blocked: 0 },
        interceptorLog: [],
        history: [],
        collections: [],
        favorites: [],
        draggedNode: null,
        requestInFlight: false,
        csvRows: null,
        graphqlSchemaFields: [],
        activeEnv: "development",
        envs: {
          global: { token: "global-token" },
          scoped: {
            development: { baseUrl: "https://api.dev.local" },
            staging: { baseUrl: "https://api.staging.local" },
            production: { baseUrl: "https://api.prod.local" },
          },
          session: {},
        },
        commandActions: [],
        loadTest: { running: false, paused: false, completed: 0, results: [] },
        loadChart: null,
        rpsChart: null,
        lastResponse: null,
        largeResponseLines: null,
        largeResponseWindow: 500,
        chainVars: {},
        retryState: { failures: 0, paused: false },
        mockRoutes: [],
        ws: { socket: null, sent: 0, received: 0, reconnect: false, reconnectTimer: null, pingStart: null },
      };

      const qs = (selector, scope = document) => scope.querySelector(selector);
      const qsa = (selector, scope = document) => Array.from(scope.querySelectorAll(selector));

      const methodColors = {
        GET: "var(--green)",
        POST: "var(--blue)",
        PUT: "var(--yellow)",
        DELETE: "var(--red)",
        PATCH: "var(--mauve)",
      };

      const toast = (message, type = "info") => {
        const container = qs("#toastContainer");
        const el = document.createElement("div");
        el.className = "toast glass px-4 py-3 rounded-xl text-sm";
        el.textContent = message;
        if (type === "error") el.style.borderColor = "rgba(243, 139, 168, 0.6)";
        if (type === "success") el.style.borderColor = "rgba(166, 227, 161, 0.6)";
        container.appendChild(el);
        setTimeout(() => el.remove(), 3000);
      };

      const debounce = (fn, wait = 250) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      };

      const setRequestLoading = (loading) => {
        const btn = qs("#sendBtn");
        const spinner = qs("#sendSpinner");
        if (!btn) return;
        btn.disabled = loading;
        btn.classList.toggle("btn-disabled", loading);
        if (spinner) spinner.classList.toggle("hidden", !loading);
      };

      const escapeHtml = (str) =>
        str.replace(/[&<>"']/g, (m) => {
          const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
          return map[m];
        });

      const downloadFile = (content, filename, type = "text/plain") => {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      };

      const highlight = (text, language = "json") => {
        const escaped = escapeHtml(text);
        if (language === "json") {
          return escaped
            .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*")(?=\\s*:)/g, '<span class="syntax-key">$1</span>')
            .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*")/g, '<span class="syntax-string">$1</span>')
            .replace(/\b(true|false|null)\b/g, '<span class="syntax-boolean">$1</span>')
            .replace(/\b-?\d+(?:\.\d+)?\b/g, '<span class="syntax-number">$&</span>');
        }
        if (language === "sql") {
          return escaped.replace(/\b(SELECT|FROM|WHERE|AND|OR|INSERT|UPDATE|DELETE|JOIN|ON|VALUES)\b/gi, '<span class="syntax-key">$1</span>');
        }
        if (language === "xml" || language === "html") {
          return escaped.replace(/(&lt;\/?[^&gt;]+&gt;)/g, '<span class="syntax-key">$1</span>');
        }
        return escaped;
      };

      const detectBodyLanguage = (text) => {
        const trimmed = text.trim();
        if (!trimmed) return "json";
        if (trimmed.startsWith("<")) {
          return trimmed.toLowerCase().includes("<html") ? "html" : "xml";
        }
        if (/\b(select|insert|update|delete|from|where|join|values)\b/i.test(trimmed)) {
          return "sql";
        }
        if (trimmed.startsWith("{") || trimmed.startsWith("[")) return "json";
        return "json";
      };

      const updateLineNumbers = (editor) => {
        const lines = editor.value.split("\n").length || 1;
        const offset = Number(editor.dataset.lineOffset || 0);
        const numbers = Array.from({ length: lines }, (_, i) => i + 1 + offset).join("\n");
        const wrapper = editor.closest(".line-editor");
        if (!wrapper) return;
        wrapper.querySelector("[data-line-numbers]").textContent = numbers;
        const layer = wrapper.querySelector("[data-syntax-layer]");
        if (layer) {
          const lang = editor.dataset.language || "json";
          layer.innerHTML = highlight(editor.value, lang);
        }
      };

      const initLineEditors = () => {
        qsa("textarea[data-language]").forEach((editor) => {
          const resize = () => {
            editor.style.height = "auto";
            editor.style.height = `${editor.scrollHeight}px`;
          };
          editor.addEventListener("input", () => {
            if (editor.id === "bodyEditor") {
              editor.dataset.language = detectBodyLanguage(editor.value);
            }
            updateLineNumbers(editor);
            if (editor.id === "paramsEditor") updateCounts();
            if (editor.id === "headersEditor") updateCounts();
            if (editor.id === "bodyEditor") updateCounts();
          });
          editor.addEventListener("scroll", () => {
            const wrapper = editor.closest(".line-editor");
            const lineNums = wrapper.querySelector("[data-line-numbers]");
            const layer = wrapper.querySelector("[data-syntax-layer]");
            lineNums.scrollTop = editor.scrollTop;
            if (layer) layer.scrollTop = editor.scrollTop;
          });
          updateLineNumbers(editor);
          resize();
        });
      };

      const initTabs = (group) => {
        const tabButtons = qsa(`[data-tab-group="${group}"] .tab-btn`);
        tabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            tabButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            const target = btn.dataset.tabTarget;
            qsa(`[data-tab-panel][data-tab-scope="${group}"]`).forEach((panel) => {
              if (panel.dataset.tabPanel === target) {
                panel.classList.remove("hidden");
              } else {
                panel.classList.add("hidden");
              }
            });
          });
        });
      };

      const getEnvColor = (env) => {
        if (env === "production") return "bg-red";
        if (env === "staging") return "bg-yellow";
        return "bg-green";
      };

      const updateEnvIndicator = () => {
        const dot = qs("#envDot");
        dot.className = `status-dot ${getEnvColor(state.activeEnv)}`;
      };

      const storeCollections = () => {
        localStorage.setItem("nebula.collections", JSON.stringify(state.collections));
      };

      const storeFavorites = () => {
        localStorage.setItem("nebula.favorites", JSON.stringify(state.favorites));
      };

      const storeEnvs = () => {
        localStorage.setItem("nebula.envs", JSON.stringify(state.envs));
      };

      const loadState = () => {
        const collections = localStorage.getItem("nebula.collections");
        const favorites = localStorage.getItem("nebula.favorites");
        const envs = localStorage.getItem("nebula.envs");
        const history = sessionStorage.getItem("nebula.history");
        if (collections) state.collections = JSON.parse(collections);
        else {
          state.collections = [
            {
              id: "folder-1",
              name: "Core APIs",
              type: "folder",
              collapsed: false,
              children: [
                { id: "req-1", name: "List Users", method: "GET" },
                { id: "req-2", name: "Create User", method: "POST" },
              ],
            },
          ];
        }
        if (envs) state.envs = JSON.parse(envs);
        if (history) state.history = JSON.parse(history);
        if (favorites) state.favorites = JSON.parse(favorites);
      };

      const saveHistory = () => {
        sessionStorage.setItem("nebula.history", JSON.stringify(state.history.slice(0, 50)));
      };

      const addHistoryItem = (item) => {
        state.history.unshift(item);
        state.history = state.history.slice(0, 50);
        saveHistory();
        renderHistory();
      };

      const isFavorite = (item) =>
        state.favorites.some((fav) => fav.url === item.url && fav.method === item.method);

      const renderHistory = () => {
        const list = qs("#historyList");
        list.innerHTML = "";
        const query = qs("#historySearch").value.toLowerCase();
        state.history
          .filter((item) => item.url.toLowerCase().includes(query))
          .forEach((item) => {
            const el = document.createElement("div");
            el.className = "glass p-2 rounded-lg text-xs flex items-center gap-2 justify-between";
            const star = isFavorite(item) ? "â˜…" : "â˜†";
            el.innerHTML = `
              <div class="flex items-center gap-2">
                <span class="method-badge method-${item.method}">${item.method}</span>
                <span class="truncate">${item.url}</span>
              </div>
              <button class="kbd" data-star>${star}</button>`;
            el.addEventListener("click", () => {
              qs("#methodSelect").value = item.method;
              qs("#urlInput").value = item.url;
              updateMethodStyle();
            });
            el.querySelector("[data-star]").addEventListener("click", (event) => {
              event.stopPropagation();
              if (isFavorite(item)) {
                state.favorites = state.favorites.filter(
                  (fav) => !(fav.url === item.url && fav.method === item.method)
                );
              } else {
                state.favorites.push(item);
              }
              storeFavorites();
              renderFavorites();
              renderHistory();
            });
            list.appendChild(el);
          });
      };

      const renderFavorites = () => {
        const list = qs("#favoriteList");
        list.innerHTML = "";
        state.favorites.forEach((item) => {
          const el = document.createElement("div");
          el.className = "glass p-2 rounded-lg flex items-center gap-2 cursor-pointer";
          el.innerHTML = `<span class="method-badge method-${item.method}">${item.method}</span><span class="truncate">${item.url}</span>`;
          el.addEventListener("click", () => {
            qs("#methodSelect").value = item.method;
            qs("#urlInput").value = item.url;
            updateMethodStyle();
          });
          list.appendChild(el);
        });
      };

      const renderCollections = () => {
        const tree = qs("#collectionTree");
        tree.innerHTML = "";
        state.collections.forEach((node) => {
          tree.appendChild(renderNode(node));
        });
      };

      const renderNode = (node) => {
        const wrapper = document.createElement("div");
        wrapper.className = "space-y-2";
        if (node.type === "folder") {
          const header = document.createElement("div");
          header.className = "flex items-center gap-2 cursor-pointer text-sm";
          header.innerHTML = `<span class="transition-base">${node.collapsed ? "&#9656;" : "&#9662;"}</span><span>${node.name}</span>`;
          header.addEventListener("click", () => {
            node.collapsed = !node.collapsed;
            renderCollections();
          });
          header.addEventListener("contextmenu", (event) => showContextMenu(event, node));
          header.addEventListener("dragover", (event) => event.preventDefault());
          header.addEventListener("drop", () => {
            if (!state.draggedNode) return;
            moveNodeToFolder(state.draggedNode, node.id);
          });
          wrapper.appendChild(header);
          if (!node.collapsed && node.children) {
            const list = document.createElement("div");
            list.className = "pl-4 space-y-2";
            node.children.forEach((child) => list.appendChild(renderNode(child)));
            wrapper.appendChild(list);
          }
        } else {
          const item = document.createElement("div");
          item.className = "flex items-center gap-2 text-xs px-2 py-1 rounded-lg hover:bg-[#232338] cursor-pointer";
          const method = node.method || "GET";
          item.innerHTML = `<span class="method-badge method-${method}">${method}</span><span class="truncate">${node.name}</span>`;
          item.setAttribute("draggable", "true");
          item.addEventListener("click", () => {
            editNode(node);
          });
          item.addEventListener("dragstart", () => {
            state.draggedNode = node.id;
          });
          item.addEventListener("dragend", () => {
            state.draggedNode = null;
          });
          item.addEventListener("contextmenu", (event) => showContextMenu(event, node));
          wrapper.appendChild(item);
        }
        return wrapper;
      };

      const moveNodeToFolder = (nodeId, folderId) => {
        const node = removeNodeById(nodeId, state.collections);
        if (!node) return;
        const folder = findNodeById(folderId, state.collections);
        if (!folder || folder.type !== "folder") return;
        folder.children = folder.children || [];
        folder.children.push(node);
        storeCollections();
        renderCollections();
      };

      const removeNodeById = (nodeId, nodes) => {
        for (let i = 0; i < nodes.length; i += 1) {
          if (nodes[i].id === nodeId) {
            return nodes.splice(i, 1)[0];
          }
          if (nodes[i].children) {
            const result = removeNodeById(nodeId, nodes[i].children);
            if (result) return result;
          }
        }
        return null;
      };

      const findNodeById = (nodeId, nodes) => {
        for (const node of nodes) {
          if (node.id === nodeId) return node;
          if (node.children) {
            const found = findNodeById(nodeId, node.children);
            if (found) return found;
          }
        }
        return null;
      };

      const findNodeWithParent = (nodeId, nodes, parent = null) => {
        for (let i = 0; i < nodes.length; i += 1) {
          const node = nodes[i];
          if (node.id === nodeId) return { node, parent, list: nodes, index: i };
          if (node.children) {
            const found = findNodeWithParent(nodeId, node.children, node);
            if (found) return found;
          }
        }
        return null;
      };

      const cloneNodeWithIds = (node) => {
        const clone = JSON.parse(JSON.stringify(node));
        const isFolder = node.type === "folder";
        clone.id = `${isFolder ? "folder" : "req"}-${Date.now()}-${Math.random().toString(16).slice(2)}`;
        clone.name = `${node.name} Copy`;
        if (clone.children) {
          clone.children = clone.children.map((child) => cloneNodeWithIds(child));
        }
        return clone;
      };

      const editNode = (node) => {
        if (node.type === "folder") return;
        qs("#methodSelect").value = node.method || "GET";
        qs("#urlInput").value = node.url || "";
        qs("#headersEditor").value =
          typeof node.headers === "string"
            ? node.headers
            : JSON.stringify(node.headers || {}, null, 2);
        qs("#bodyEditor").value = node.body || "";
        qs("#paramsEditor").value = node.params || "";
        qs("#bodyEditor").dataset.language = detectBodyLanguage(qs("#bodyEditor").value);
        updateMethodStyle();
        updateLineNumbers(qs("#headersEditor"));
        updateLineNumbers(qs("#bodyEditor"));
        updateLineNumbers(qs("#paramsEditor"));
        updateCounts();
      };

      const renameNodeById = (nodeId) => {
        const result = findNodeWithParent(nodeId, state.collections);
        if (!result) return;
        const name = prompt("Rename item", result.node.name);
        if (!name) return;
        result.node.name = name;
        storeCollections();
        renderCollections();
      };

      const duplicateNodeById = (nodeId) => {
        const result = findNodeWithParent(nodeId, state.collections);
        if (!result) return;
        const clone = cloneNodeWithIds(result.node);
        result.list.splice(result.index + 1, 0, clone);
        storeCollections();
        renderCollections();
      };

      const deleteNodeById = (nodeId) => {
        const removed = removeNodeById(nodeId, state.collections);
        if (!removed) return;
        storeCollections();
        renderCollections();
      };

      const exportNodeById = async (nodeId) => {
        const result = findNodeWithParent(nodeId, state.collections);
        if (!result) return;
        const node = result.node;
        if (node.type === "folder") {
          downloadFile(JSON.stringify(node, null, 2), `${node.name}.json`, "application/json");
          toast("Folder exported as JSON.", "success");
          return;
        }
        const headers = node.headers || {};
        const headerLines = Object.entries(headers)
          .map(([key, value]) => `-H '${key}: ${value}'`)
          .join(" ");
        const bodySegment = node.body ? `--data '${node.body}'` : "";
        const curl = `curl -X ${node.method || "GET"} '${node.url || ""}' ${headerLines} ${bodySegment}`.trim();
        await navigator.clipboard.writeText(curl);
        downloadFile(JSON.stringify(node, null, 2), `${node.name}.json`, "application/json");
        const har = {
          log: {
            version: "1.2",
            creator: { name: "Nebula", version: "1.0" },
            entries: [
              {
                startedDateTime: new Date().toISOString(),
                request: {
                  method: node.method || "GET",
                  url: node.url || "",
                  headers: Object.entries(headers).map(([name, value]) => ({ name, value })),
                },
                response: { status: 0, statusText: "", headers: [] },
                timings: {},
              },
            ],
          },
        };
        downloadFile(JSON.stringify(har, null, 2), `${node.name}.har`, "application/json");
        toast("cURL copied, JSON + HAR exported.", "success");
      };

      const moveNodePrompt = (nodeId) => {
        const folders = state.collections.filter((node) => node.type === "folder");
        if (!folders.length) return toast("No folders available.", "error");
        const names = folders.map((folder) => folder.name).join(", ");
        const targetName = prompt(`Move to folder: ${names}`, folders[0].name);
        if (!targetName) return;
        const folder = folders.find((f) => f.name === targetName);
        if (!folder) return toast("Folder not found.", "error");
        moveNodeToFolder(nodeId, folder.id);
      };

      const saveCurrentToCollection = () => {
        const method = qs("#methodSelect").value;
        const url = qs("#urlInput").value.trim();
        if (!url) return toast("URL is required to save.", "error");
        const folderName = prompt("Save to folder", "Saved Requests");
        if (!folderName) return;
        let folder = state.collections.find(
          (node) => node.type === "folder" && node.name.toLowerCase() === folderName.toLowerCase()
        );
        if (!folder) {
          folder = {
            id: `folder-${Date.now()}`,
            name: folderName,
            type: "folder",
            collapsed: false,
            children: [],
          };
          state.collections.push(folder);
        }
        const headersText = qs("#headersEditor").value;
        let headers = {};
        try {
          headers = headersText ? JSON.parse(headersText) : {};
        } catch {
          headers = {};
        }
        const request = {
          id: `req-${Date.now()}`,
          name: `${method} ${url}`,
          method,
          url,
          headers,
          body: qs("#bodyEditor").value,
          params: qs("#paramsEditor").value,
        };
        folder.children.push(request);
        storeCollections();
        renderCollections();
        toast("Request saved to collection.", "success");
      };

      const showContextMenu = (event, node) => {
        event.preventDefault();
        const menu = qs("#contextMenu");
        menu.style.left = `${event.clientX}px`;
        menu.style.top = `${event.clientY}px`;
        menu.classList.remove("hidden");
        menu.dataset.nodeId = node.id;
      };

      const hideContextMenu = () => {
        qs("#contextMenu").classList.add("hidden");
      };

      const updateMethodStyle = () => {
        const select = qs("#methodSelect");
        const color = methodColors[select.value] || "var(--lavender)";
        select.style.borderColor = color;
      };

      const parseCurl = (curl) => {
        const urlMatch = curl.match(/https?:\/\/[^\s'"]+/i);
        const methodMatch = curl.match(/-X\s+(\w+)/i);
        const headerMatches = [...curl.matchAll(/-H\s+['"]([^'"]+)['"]/gi)];
        const dataMatch = curl.match(/--data(?:-raw)?\s+['"]([^'"]*)['"]/i);
        const method = methodMatch ? methodMatch[1].toUpperCase() : "GET";
        const url = urlMatch ? urlMatch[0] : "";
        const headers = {};
        headerMatches.forEach((match) => {
          const [key, ...rest] = match[1].split(":");
          headers[key.trim()] = rest.join(":").trim();
        });
        const body = dataMatch ? dataMatch[1] : "";
        return { method, url, headers, body };
      };

      const importCurl = () => {
        const curl = qs("#curlInput").value.trim();
        if (!curl) return toast("cURL input required.", "error");
        const parsed = parseCurl(curl);
        if (!parsed.url) return toast("cURL URL not found.", "error");
        const newRequest = {
          id: `req-${Date.now()}`,
          name: `Imported ${parsed.method}`,
          method: parsed.method,
          url: parsed.url,
          headers: parsed.headers,
          body: parsed.body,
        };
        state.collections.push({
          id: `folder-${Date.now()}`,
          name: "Imported cURL",
          type: "folder",
          collapsed: false,
          children: [newRequest],
        });
        storeCollections();
        renderCollections();
        toast("cURL imported into collections.", "success");
        qs("#curlInput").value = "";
      };

      const importPostman = async (file) => {
        const text = await file.text();
        try {
          const data = JSON.parse(text);
          const items = [];
          const walkItems = (arr) => {
            arr.forEach((item) => {
              if (item.item) {
                walkItems(item.item);
              } else if (item.request) {
                items.push({
                  id: `req-${Date.now()}-${Math.random()}`,
                  name: item.name,
                  method: item.request.method || "GET",
                  url: item.request.url?.raw || "",
                });
              }
            });
          };
          walkItems(data.item || []);
          state.collections.push({
            id: `folder-${Date.now()}`,
            name: data.info?.name || "Imported Postman",
            type: "folder",
            collapsed: false,
            children: items,
          });
          storeCollections();
          renderCollections();
          toast("Postman collection imported.", "success");
        } catch (err) {
          toast("Failed to import Postman JSON.", "error");
        }
      };

      const exportCollectionsJSON = () => {
        downloadFile(JSON.stringify(state.collections, null, 2), "nebula-collections.json", "application/json");
      };

      const exportOpenAPI = () => {
        const spec = {
          openapi: "3.0.0",
          info: { title: "Nebula Export", version: "1.0.0" },
          paths: {},
        };
        const allRequests = [];
        const collect = (nodes) => {
          nodes.forEach((node) => {
            if (node.children) collect(node.children);
            if (node.url) allRequests.push(node);
          });
        };
        collect(state.collections);
        allRequests.forEach((req) => {
          try {
            const url = new URL(req.url);
            const path = url.pathname || "/";
            spec.paths[path] = spec.paths[path] || {};
            spec.paths[path][req.method.toLowerCase()] = {
              summary: req.name,
              responses: { 200: { description: "Success" } },
            };
          } catch {
            return;
          }
        });
        downloadFile(JSON.stringify(spec, null, 2), "nebula-openapi.json", "application/json");
      };

      const exportHAR = () => {
        const entries = state.history.map((item) => ({
          startedDateTime: new Date().toISOString(),
          request: { method: item.method, url: item.url, headers: [] },
          response: { status: 0, statusText: "", headers: [] },
          timings: {},
        }));
        const har = { log: { version: "1.2", creator: { name: "Nebula", version: "1.0" }, entries } };
        downloadFile(JSON.stringify(har, null, 2), "nebula-history.har", "application/json");
      };

      const updateCounts = () => {
        const params = qs("#paramsEditor").value.trim();
        const headers = qs("#headersEditor").value.trim();
        const body = qs("#bodyEditor").value.trim();
        qs("#paramsCount").textContent = params ? params.split("\n").length : 0;
        qs("#headersCount").textContent = headers ? headers.split("\n").length : 0;
        qs("#bodyCount").textContent = body ? body.split("\n").length : 0;
      };

      const replaceVariables = (value) => {
        return value.replace(/\{\{(.*?)\}\}/g, (_, key) => {
          const trimmed = key.trim();
          if (state.envs.session[trimmed]) return state.envs.session[trimmed];
          if (state.envs.scoped[state.activeEnv] && state.envs.scoped[state.activeEnv][trimmed]) {
            return state.envs.scoped[state.activeEnv][trimmed];
          }
          if (state.envs.global[trimmed]) return state.envs.global[trimmed];
          if (state.chainVars[trimmed]) return state.chainVars[trimmed];
          return "";
        });
      };

      const showVariableTooltip = (event) => {
        const input = event.target;
        const tooltip = qs("#variableTooltip");
        const match = input.value.match(/\{\{(.*?)\}\}/);
        if (!match) {
          tooltip.classList.add("hidden");
          return;
        }
        const key = match[1].trim();
        const value = replaceVariables(`{{${key}}}`);
        tooltip.textContent = `${key}: ${value || "undefined"}`;
        tooltip.style.left = `${input.getBoundingClientRect().left}px`;
        tooltip.style.top = `${input.getBoundingClientRect().bottom + 6}px`;
        tooltip.classList.remove("hidden");
      };

      const hideVariableTooltip = () => qs("#variableTooltip").classList.add("hidden");

      const getVariableKeys = () => {
        const keys = new Set();
        Object.keys(state.envs.global || {}).forEach((key) => keys.add(key));
        Object.keys(state.envs.session || {}).forEach((key) => keys.add(key));
        Object.keys(state.envs.scoped[state.activeEnv] || {}).forEach((key) => keys.add(key));
        Object.keys(state.chainVars || {}).forEach((key) => keys.add(key));
        return Array.from(keys);
      };

      const showVariableAutocomplete = (input) => {
        const auto = qs("#varAutocomplete");
        const value = input.value;
        const caret = input.selectionStart || value.length;
        const openIndex = value.lastIndexOf("{{", caret);
        if (openIndex === -1) {
          auto.classList.add("hidden");
          return;
        }
        const closeIndex = value.indexOf("}}", openIndex);
        if (closeIndex !== -1 && closeIndex < caret) {
          auto.classList.add("hidden");
          return;
        }
        const prefix = value.slice(openIndex + 2, caret).trim();
        const suggestions = getVariableKeys().filter((key) =>
          key.toLowerCase().includes(prefix.toLowerCase())
        );
        if (!suggestions.length) {
          auto.classList.add("hidden");
          return;
        }
        auto.innerHTML = "";
        suggestions.forEach((key) => {
          const btn = document.createElement("button");
          btn.className = "w-full text-left px-2 py-1 rounded hover:bg-[#232338]";
          btn.textContent = key;
          btn.addEventListener("click", () => {
            const before = value.slice(0, openIndex);
            const after = value.slice(caret);
            input.value = `${before}{{${key}}}${after}`;
            auto.classList.add("hidden");
            input.dispatchEvent(new Event("input"));
          });
          auto.appendChild(btn);
        });
        const rect = input.getBoundingClientRect();
        auto.style.left = `${rect.left}px`;
        auto.style.top = `${rect.bottom + 6}px`;
        auto.classList.remove("hidden");
      };

      const hideVariableAutocomplete = () => qs("#varAutocomplete").classList.add("hidden");

      const showGraphqlAutocomplete = (editor) => {
        if (!state.graphqlSchemaFields.length) return;
        const auto = qs("#graphqlAutocomplete");
        const value = editor.value;
        const caret = editor.selectionStart || value.length;
        const match = /([_A-Za-z][_0-9A-Za-z]*)$/.exec(value.slice(0, caret));
        if (!match) {
          auto.classList.add("hidden");
          return;
        }
        const prefix = match[1];
        const suggestions = state.graphqlSchemaFields
          .filter((field) => field.toLowerCase().startsWith(prefix.toLowerCase()))
          .slice(0, 8);
        if (!suggestions.length) {
          auto.classList.add("hidden");
          return;
        }
        auto.innerHTML = "";
        suggestions.forEach((field) => {
          const btn = document.createElement("button");
          btn.className = "w-full text-left px-2 py-1 rounded hover:bg-[#232338]";
          btn.textContent = field;
          btn.addEventListener("click", () => {
            const start = value.slice(0, caret - prefix.length);
            const end = value.slice(caret);
            editor.value = `${start}${field}${end}`;
            auto.classList.add("hidden");
            editor.dispatchEvent(new Event("input"));
          });
          auto.appendChild(btn);
        });
        const rect = editor.getBoundingClientRect();
        auto.style.left = `${rect.left}px`;
        auto.style.top = `${rect.bottom + 6}px`;
        auto.classList.remove("hidden");
      };

      const hideGraphqlAutocomplete = () => qs("#graphqlAutocomplete").classList.add("hidden");

      const setupGraphqlAutocomplete = () => {
        ["#graphqlQuery", "#graphqlMutation", "#graphqlSubscription"].forEach((selector) => {
          const editor = qs(selector);
          if (!editor) return;
          editor.addEventListener("input", () => showGraphqlAutocomplete(editor));
          editor.addEventListener("blur", hideGraphqlAutocomplete);
        });
      };

      const recordInterceptorLog = (entry) => {
        state.interceptorLog.unshift(entry);
        state.interceptorLog = state.interceptorLog.slice(0, 50);
        renderInterceptorLog();
      };

      const renderInterceptorLog = () => {
        const list = qs("#interceptorLog");
        list.innerHTML = "";
        state.interceptorLog.forEach((entry) => {
          const item = document.createElement("div");
          item.className = "glass p-2 rounded-lg text-xs flex items-center gap-2 justify-between";
          item.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="method-badge method-${entry.method}">${entry.method}</span>
              <span class="truncate">${entry.url}</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="status-dot ${entry.blocked ? "bg-red" : "bg-green"}"></span>
              <button data-action="replay" class="kbd">Edit & Replay</button>
              <button data-action="drop" class="kbd">Drop</button>
            </div>`;
          item.querySelector('[data-action="replay"]').addEventListener("click", () => {
            qs("#urlInput").value = entry.url;
            qs("#methodSelect").value = entry.method;
            updateMethodStyle();
            toast("Loaded request from interceptor log.", "success");
          });
          item.querySelector('[data-action="drop"]').addEventListener("click", () => {
            toast("Request dropped from log.", "error");
          });
          list.appendChild(item);
        });
      };

      const updateInterceptorStats = () => {
        qs("#statIntercepted").textContent = state.interceptorStats.intercepted;
        qs("#statModified").textContent = state.interceptorStats.modified;
        qs("#statBlocked").textContent = state.interceptorStats.blocked;
      };

      const openBreakpointModal = (payload, mode = "request") => {
        return new Promise((resolve) => {
          const modal = qs("#breakpointModal");
          const statusInput = qs("#breakpointStatus");
          const methodSelect = qs("#breakpointMethod");
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          methodSelect.value = payload.method;
          qs("#breakpointUrl").value = payload.url;
          qs("#breakpointHeaders").value = payload.headers || "{}";
          qs("#breakpointBody").value = payload.body || "";
          if (mode === "response") {
            statusInput.classList.remove("hidden");
            statusInput.value = payload.status || 200;
            methodSelect.disabled = true;
          } else {
            statusInput.classList.add("hidden");
            statusInput.value = "";
            methodSelect.disabled = false;
          }
          qsa("#breakpointModal textarea").forEach((editor) => updateLineNumbers(editor));

          const cleanup = (result) => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
            resolve(result);
          };

          qs("#breakpointResume").onclick = () => {
            cleanup({
              action: "resume",
              method: methodSelect.value,
              status: statusInput.value,
              url: qs("#breakpointUrl").value,
              headers: qs("#breakpointHeaders").value,
              body: qs("#breakpointBody").value,
            });
          };
          qs("#breakpointAbort").onclick = () => cleanup({ action: "abort" });
          qs("#breakpointDrop").onclick = () => cleanup({ action: "drop" });
        });
      };

      const runPreRequestScript = () => {
        const script = qs("#preRequestEditor").value;
        const consoleEl = qs("#scriptConsole");
        consoleEl.innerHTML = "";
        const pm = {
          environment: {
            set: (key, value) => {
              state.envs.scoped[state.activeEnv][key] = value;
              storeEnvs();
            },
            get: (key) => state.envs.scoped[state.activeEnv][key],
          },
          globals: {
            set: (key, value) => {
              state.envs.global[key] = value;
              storeEnvs();
            },
            get: (key) => state.envs.global[key],
          },
          variables: {
            replaceIn: (value) => replaceVariables(value),
          },
        };
        const crypto = {
          md5: (value) => btoa(value).slice(0, 16),
          sha256: (value) => btoa(value).slice(0, 32),
          base64: (value) => btoa(value),
        };
        try {
          const log = (...args) => {
            const line = document.createElement("div");
            line.textContent = args.join(" ");
            consoleEl.appendChild(line);
          };
          const fn = new Function("pm", "crypto", "log", script);
          fn(pm, crypto, log);
        } catch (err) {
          toast("Pre-request script error: " + err.message, "error");
        }
      };

      const runTestScript = (response, headers) => {
        const script = qs("#testEditor").value;
        const results = qs("#testResults");
        results.innerHTML = "";
        const pm = {
          response: {
            to: {
              have: {
                status: (code) => response.status === code,
                jsonBody: (key) => {
                  try {
                    const data = JSON.parse(response.body);
                    return key in data;
                  } catch {
                    return false;
                  }
                },
                header: (key) => headers[key.toLowerCase()] !== undefined,
              },
            },
          },
          test: (name, fn) => {
            let passed = false;
            try {
              passed = fn();
            } catch {
              passed = false;
            }
            const el = document.createElement("div");
            el.className = "flex items-center gap-2 text-xs";
            el.innerHTML = `<span class="status-dot ${passed ? "bg-green" : "bg-red"}"></span>${name}`;
            results.appendChild(el);
          },
          expect: (value) => ({
            to: {
              equal: (expected) => value === expected,
            },
          }),
        };
        try {
          const fn = new Function("pm", script);
          fn(pm);
        } catch (err) {
          toast("Test script error: " + err.message, "error");
        }
      };

      const parseKeyValue = (text) => {
        const lines = text.split("\n").filter(Boolean);
        const params = {};
        lines.forEach((line) => {
          const [key, ...rest] = line.split("=");
          if (!key) return;
          params[key.trim()] = rest.join("=").trim();
        });
        return params;
      };

      const fetchWithRetry = async (url, options, retryConfig) => {
        const { attempts, backoff, codes, circuit } = retryConfig;
        let attempt = 0;
        while (attempt < attempts) {
          if (state.retryState.paused) {
            toast("Circuit breaker paused requests.", "error");
            throw new Error("Circuit breaker paused");
          }
          try {
            const start = performance.now();
            const response = await fetch(url, options);
            const time = performance.now() - start;
            if (codes.includes(response.status) && attempt < attempts - 1) {
              attempt += 1;
              await new Promise((r) => setTimeout(r, backoff * attempt));
              continue;
            }
            state.retryState.failures = 0;
            return { response, time };
          } catch (err) {
            state.retryState.failures += 1;
            if (circuit && state.retryState.failures >= attempts) {
              state.retryState.paused = true;
              qs("#retryStatus").textContent = "Circuit breaker active. Reset to resume.";
            }
            attempt += 1;
            if (attempt >= attempts) throw err;
            await new Promise((r) => setTimeout(r, backoff * attempt));
          }
        }
      };

      const applyMockRoutes = (url, options) => {
        const route = state.mockRoutes.find((r) => {
          if (!url.includes(r.path)) return false;
          if (r.condition) {
            const haystack = `${options.method || ""} ${options.body || ""} ${JSON.stringify(
              options.headers || {}
            )}`;
            if (!haystack.includes(r.condition)) return false;
          }
          return true;
        });
        if (!route) return null;
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({
              status: route.status,
              statusText: route.status >= 400 ? "Error" : "OK",
              headers: { "content-type": route.contentType },
              body: route.body,
              mock: true,
            });
          }, route.latency);
        });
      };

      const performRequest = async () => {
        if (state.requestInFlight) return;
        let method = qs("#methodSelect").value;
        let url = qs("#urlInput").value.trim();
        if (!url) {
          toast("URL is required.", "error");
          return;
        }
        state.requestInFlight = true;
        setRequestLoading(true);
        try {
          runPreRequestScript();
          let paramsText = qs("#paramsEditor").value;
          let headersInput = qs("#headersEditor").value || "{}";
          let body = qs("#bodyEditor").value;
          const files = qs("#fileInput").files;
          const requestInfo = { method, url, headers: headersInput, body };

          if (state.interceptorEnabled && ["request", "both"].includes(state.interceptorMode)) {
            state.interceptorStats.intercepted += 1;
            updateInterceptorStats();
            const result = await openBreakpointModal(requestInfo, "request");
            if (result.action === "abort") {
              toast("Request aborted by interceptor.", "error");
              state.interceptorStats.blocked += 1;
              updateInterceptorStats();
              recordInterceptorLog({ method, url, blocked: true });
              return;
            }
            if (result.action === "drop") {
              toast("Request dropped by interceptor.", "error");
              state.interceptorStats.blocked += 1;
              updateInterceptorStats();
              recordInterceptorLog({ method, url, blocked: true });
              return;
            }
            if (result.action === "resume") {
              state.interceptorStats.modified += 1;
              updateInterceptorStats();
              method = result.method;
              url = result.url;
              headersInput = result.headers || "{}";
              body = result.body || "";
              qs("#methodSelect").value = method;
              qs("#urlInput").value = url;
              qs("#headersEditor").value = headersInput;
              qs("#bodyEditor").value = body;
              updateLineNumbers(qs("#headersEditor"));
              updateLineNumbers(qs("#bodyEditor"));
            }
          }

          url = replaceVariables(url);
          const params = parseKeyValue(replaceVariables(paramsText));
          let headers = {};
          try {
            headers = JSON.parse(replaceVariables(headersInput || "{}"));
          } catch (err) {
            toast("Headers JSON is invalid.", "error");
            const wrapper = qs("#headersEditor").closest(".line-editor");
            wrapper.classList.add("shake");
            setTimeout(() => wrapper.classList.remove("shake"), 400);
            return;
          }

          if (qs("#authType").value && qs("#authValue").value) {
            if (qs("#authType").value.toLowerCase().includes("bearer")) {
              headers["Authorization"] = `Bearer ${qs("#authValue").value}`;
            } else {
              headers["Authorization"] = qs("#authValue").value;
            }
          }

          const queryString = new URLSearchParams(params).toString();
          if (queryString) url += (url.includes("?") ? "&" : "?") + queryString;

          let payload = null;
          let contentType = headers["Content-Type"] || headers["content-type"];
          if (files && files.length) {
            const formData = new FormData();
            Array.from(files).forEach((file) => formData.append("files", file));
            if (body.trim()) formData.append("payload", body);
            payload = formData;
          } else if (body.trim()) {
            body = replaceVariables(body);
            payload = body;
            if (!contentType) {
              contentType = "application/json";
              headers["Content-Type"] = contentType;
            }
          }

          if (payload && payload.length && payload.length > 10 * 1024 * 1024) {
            toast("Request payload exceeds 10MB limit.", "error");
            return;
          }

          const retryConfig = {
            attempts: Number(qs("#retryAttempts").value) || 1,
            backoff: Number(qs("#retryBackoff").value) || 0,
            codes: qs("#retryCodes").value.split(",").map((v) => Number(v.trim())).filter(Boolean),
            circuit: qs("#retryCircuit").checked,
          };

          const mockResponse = applyMockRoutes(url, { method, headers, body });
          if (mockResponse) {
            const data = await mockResponse;
            renderResponse(data, 0, true, data.headers || {});
            recordInterceptorLog({ method, url, blocked: false });
            addHistoryItem({ method, url });
            return;
          }

          let response;
          let time;
          try {
            const result = await fetchWithRetry(
              url,
              {
                method,
                headers,
                body: payload && method !== "GET" ? payload : null,
              },
              retryConfig
            );
            response = result.response;
            time = result.time;
          } catch (err) {
            toast("Network error: " + err.message, "error");
            return;
          }

          const headersObj = {};
          response.headers.forEach((value, key) => {
            headersObj[key] = value;
          });
          let text = await response.text();
          const size = new Blob([text]).size;
          if (size > 10 * 1024 * 1024) {
            qs("#responseWarning").textContent = "Response exceeds 10MB. Virtualized view enabled.";
            qs("#responseWarning").classList.remove("hidden");
            state.largeResponseLines = text.split("\n");
          } else {
            qs("#responseWarning").classList.add("hidden");
            state.largeResponseLines = null;
          }
          const responsePayload = { status: response.status, statusText: response.statusText, body: text };

          if (state.interceptorEnabled && ["response", "both"].includes(state.interceptorMode)) {
            state.interceptorStats.intercepted += 1;
            updateInterceptorStats();
            const result = await openBreakpointModal(
              {
                method,
                url,
                headers: JSON.stringify(headersObj, null, 2),
                body: text,
                status: response.status,
              },
              "response"
            );
            if (result.action === "abort" || result.action === "drop") {
              toast("Response blocked by interceptor.", "error");
              state.interceptorStats.blocked += 1;
              updateInterceptorStats();
              recordInterceptorLog({ method, url, blocked: true });
              return;
            }
            if (result.action === "resume") {
              responsePayload.body = result.body;
              responsePayload.status = Number.parseInt(result.status, 10) || response.status;
              if (result.headers) {
                try {
                  const parsed = JSON.parse(result.headers);
                  Object.keys(headersObj).forEach((key) => delete headersObj[key]);
                  Object.assign(headersObj, parsed);
                } catch {
                  toast("Interceptor headers JSON invalid.", "error");
                }
              }
              state.interceptorStats.modified += 1;
              updateInterceptorStats();
            }
          }

          renderResponse(responsePayload, time, false, headersObj);
          addHistoryItem({ method, url });
          recordInterceptorLog({ method, url, blocked: false });
          updatePerformanceTimeline(response, time);
        } finally {
          state.requestInFlight = false;
          setRequestLoading(false);
        }
      };

      const renderResponse = (payload, time, isMock, headersObj = {}) => {
        state.lastResponse = payload;
        const statusCategory = Math.floor(payload.status / 100);
        const statusPill = qs("#statusPill");
        statusPill.textContent = `${payload.status} ${payload.statusText || ""}`.trim();
        statusPill.className = "pill";
        if (statusCategory === 2) statusPill.classList.add("success");
        if (statusCategory === 3) statusPill.classList.add("warn");
        if (statusCategory === 4) statusPill.classList.add("error");
        if (statusCategory === 5) statusPill.classList.add("critical");
        qs("#timePill").textContent = `${Math.round(time)}ms`;
        qs("#sizePill").textContent = `${(payload.body.length / 1024).toFixed(2)} KB`;
        const contentType = (headersObj["content-type"] || "").toLowerCase();
        let language = "json";
        if (contentType.includes("xml")) language = "xml";
        if (contentType.includes("html")) language = "html";
        if (contentType.includes("sql")) language = "sql";
        qs("#responseBody").dataset.language = language;
        if (state.largeResponseLines) {
          setupVirtualResponse();
        } else {
          qs("#responseVirtualControls").classList.add("hidden");
          qs("#responseBody").dataset.lineOffset = 0;
          qs("#responseBody").value = payload.body;
          updateLineNumbers(qs("#responseBody"));
        }
        qs("#responseHeaders").textContent = JSON.stringify(headersObj, null, 2);
        qs("#responseCookies").textContent = headersObj["set-cookie"] || "No cookies.";
        runTestScript({ status: payload.status, body: payload.body }, headersObj);
        if (isMock) toast("Mock response served.", "success");
      };

      const setupVirtualResponse = () => {
        const range = qs("#responseVirtualRange");
        const controls = qs("#responseVirtualControls");
        if (!state.largeResponseLines) return;
        const totalLines = state.largeResponseLines.length;
        range.max = Math.max(0, totalLines - state.largeResponseWindow);
        range.value = 0;
        range.oninput = () => setVirtualResponse(Number(range.value));
        controls.classList.remove("hidden");
        setVirtualResponse(0);
      };

      const setVirtualResponse = (start) => {
        const totalLines = state.largeResponseLines.length;
        const end = Math.min(totalLines, start + state.largeResponseWindow);
        const slice = state.largeResponseLines.slice(start, end).join("\n");
        const responseBody = qs("#responseBody");
        responseBody.dataset.lineOffset = start;
        responseBody.value = slice;
        updateLineNumbers(responseBody);
        qs("#responseVirtualLabel").textContent = `Lines ${start + 1}-${end} of ${totalLines}`;
      };

      const updatePerformanceTimeline = (response, duration) => {
        const timeline = qs("#timelineBars");
        timeline.innerHTML = "";
        const segments = [
          { label: "DNS Lookup", value: Math.max(2, duration * 0.1) },
          { label: "TCP Connect", value: Math.max(4, duration * 0.2) },
          { label: "TLS Handshake", value: Math.max(4, duration * 0.2) },
          { label: "TTFB", value: Math.max(6, duration * 0.3) },
          { label: "Download", value: Math.max(4, duration * 0.2) },
        ];
        segments.forEach((seg) => {
          const row = document.createElement("div");
          row.className = "text-xs";
          row.innerHTML = `<div class="flex justify-between"><span>${seg.label}</span><span>${seg.value.toFixed(1)}ms</span></div><div class="waterfall-bar"></div>`;
          row.querySelector(".waterfall-bar").style.width = `${Math.min(100, seg.value)}%`;
          timeline.appendChild(row);
        });
      };

      const initCommandPalette = () => {
        state.commandActions = [
          { label: "Send Request", action: performRequest },
          { label: "Toggle Sidebar", action: toggleSidebar },
          { label: "Save to Collection", action: saveCurrentToCollection },
          { label: "Open Load Testing", action: () => activateWorkspace("loadtest") },
          { label: "Open WebSocket", action: () => activateWorkspace("websocket") },
          { label: "Open GraphQL", action: () => activateWorkspace("graphql") },
          { label: "Toggle Interceptor", action: () => toggleInterceptor(true) },
        ];
        const renderCommandList = (filter = "") => {
          const list = qs("#commandList");
          list.innerHTML = "";
          state.commandActions
            .filter((cmd) => cmd.label.toLowerCase().includes(filter.toLowerCase()))
            .forEach((cmd) => {
              const item = document.createElement("div");
              item.className = "glass p-2 rounded-lg cursor-pointer hover:bg-[#232338]";
              item.textContent = cmd.label;
              item.addEventListener("click", () => {
                cmd.action();
                closeCommandPalette();
              });
              list.appendChild(item);
            });
        };
        renderCommandList();
        qs("#commandInput").addEventListener("input", (event) => {
          renderCommandList(event.target.value);
        });
      };

      const openCommandPalette = () => {
        qs("#commandPalette").classList.remove("hidden");
        qs("#commandPalette").classList.add("flex");
        qs("#commandInput").value = "";
        qs("#commandInput").dispatchEvent(new Event("input"));
        qs("#commandInput").focus();
      };

      const closeCommandPalette = () => {
        qs("#commandPalette").classList.add("hidden");
        qs("#commandPalette").classList.remove("flex");
      };

      const toggleSidebar = () => {
        const sidebar = qs("#sidebar");
        if (window.innerWidth <= 768) {
          sidebar.classList.toggle("open");
          qs("#sidebarOverlay").classList.toggle("hidden");
        } else {
          sidebar.classList.toggle("sidebar-collapsed");
        }
      };

      const toggleInterceptor = (fromPalette = false) => {
        state.interceptorEnabled = !state.interceptorEnabled;
        updateInterceptorIndicator();
        toast(
          state.interceptorEnabled ? "Interceptor enabled." : "Interceptor disabled.",
          state.interceptorEnabled ? "success" : "info"
        );
        if (fromPalette) closeCommandPalette();
      };

      const updateInterceptorIndicator = () => {
        const indicator = qs("#interceptorIndicator");
        indicator.className = `status-dot ${state.interceptorEnabled ? "bg-red" : "bg-muted"}`;
      };

      const setupCharts = () => {
        const latencyCtx = qs("#latencyChart");
        const rpsCtx = qs("#rpsChart");
        state.loadChart = new Chart(latencyCtx, {
          type: "bar",
          data: {
            labels: ["0-50", "50-100", "100-200", "200-500", "500+"],
            datasets: [
              {
                data: [0, 0, 0, 0, 0],
                backgroundColor: ["#a6e3a1", "#89b4fa", "#f9e2af", "#fab387", "#f38ba8"],
                borderRadius: 6,
              },
            ],
          },
          options: { responsive: true, plugins: { legend: { display: false } } },
        });
        state.rpsChart = new Chart(rpsCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                fill: true,
                borderColor: "#b4befe",
                backgroundColor: "rgba(180, 190, 254, 0.2)",
                tension: 0.4,
              },
            ],
          },
          options: { responsive: true, plugins: { legend: { display: false } } },
        });
      };

      const updateLoadMetrics = (sample) => {
        qs("#metricRps").textContent = sample.rps.toFixed(1);
        qs("#metricAvg").textContent = `${sample.avg} ms`;
        qs("#metricAvgMinMax").textContent = `min ${sample.min} / max ${sample.max}`;
        qs("#metricP95").textContent = `${sample.p95} ms`;
        qs("#metricError").textContent = `${sample.errorRate}%`;
        qs("#metricErrorCount").textContent = `${sample.errors} errors`;
        qs("#metricThroughput").textContent = `${sample.throughput} KB/s`;
      };

      const simulateLoadTest = () => {
        if (!state.loadTest.running || state.loadTest.paused) return;
        const progress = Math.min(100, (state.loadTest.completed / state.loadTest.total) * 100);
        qs("#loadProgress").style.width = `${progress}%`;
        qs("#loadProgressText").textContent = `${progress.toFixed(0)}%`;

        const sample = {
          rps: Math.random() * 200,
          avg: Math.round(50 + Math.random() * 100),
          min: Math.round(20 + Math.random() * 30),
          max: Math.round(100 + Math.random() * 200),
          p95: Math.round(120 + Math.random() * 120),
          errorRate: Math.round(Math.random() * 3),
          errors: Math.round(Math.random() * 5),
          throughput: Math.round(120 + Math.random() * 400),
        };
        updateLoadMetrics(sample);
        state.loadChart.data.datasets[0].data = [
          Math.round(Math.random() * 20),
          Math.round(Math.random() * 20),
          Math.round(Math.random() * 20),
          Math.round(Math.random() * 20),
          Math.round(Math.random() * 20),
        ];
        state.loadChart.update();
        const label = new Date().toLocaleTimeString();
        state.rpsChart.data.labels.push(label);
        state.rpsChart.data.datasets[0].data.push(sample.rps);
        if (state.rpsChart.data.labels.length > 20) {
          state.rpsChart.data.labels.shift();
          state.rpsChart.data.datasets[0].data.shift();
        }
        state.rpsChart.update();
        const result = {
          status: Math.random() > 0.9 ? 500 : 200,
          time: sample.avg,
          size: `${Math.round(Math.random() * 5 + 1)} KB`,
          timestamp: new Date().toLocaleTimeString(),
        };
        state.loadTest.results.push(result);
        renderLoadResults();
        state.loadTest.completed += 1;
        if (state.loadTest.completed < state.loadTest.total) {
          setTimeout(simulateLoadTest, 500);
        } else {
          state.loadTest.running = false;
          setLoadTestState(false);
          toast("Load test completed.", "success");
        }
      };

      const renderLoadResults = () => {
        const tbody = qs("#loadResults");
        tbody.innerHTML = "";
        state.loadTest.results.slice(-50).forEach((row, index) => {
          const tr = document.createElement("tr");
          const statusColor = row.status >= 400 ? "text-red" : "text-green";
          tr.innerHTML = `
            <td class="py-1">${index + 1}</td>
            <td class="py-1 ${statusColor}">${row.status}</td>
            <td class="py-1">${row.time}</td>
            <td class="py-1">${row.size}</td>
            <td class="py-1">${row.timestamp}</td>`;
          tbody.appendChild(tr);
        });
      };

      const setLoadTestState = (running) => {
        const btn = qs("#loadStart");
        btn.disabled = running;
        btn.classList.toggle("btn-disabled", running);
        btn.textContent = running ? "Running..." : "Start (Space)";
      };

      const startLoadTest = () => {
        if (state.loadTest.running) return;
        state.loadTest.running = true;
        state.loadTest.paused = false;
        state.loadTest.completed = 0;
        state.loadTest.results = [];
        state.loadTest.total = Number(qs("#loadTotal").value) || 100;
        setLoadTestState(true);
        simulateLoadTest();
        toast("Load test started.", "success");
      };

      const pauseLoadTest = () => {
        state.loadTest.paused = !state.loadTest.paused;
        if (!state.loadTest.paused) simulateLoadTest();
        toast(state.loadTest.paused ? "Load test paused." : "Load test resumed.");
      };

      const cancelLoadTest = () => {
        state.loadTest.running = false;
        state.loadTest.paused = false;
        qs("#loadProgress").style.width = "0%";
        qs("#loadProgressText").textContent = "0%";
        setLoadTestState(false);
        toast("Load test canceled.", "error");
      };

      const exportCsv = () => {
        const rows = ["#,Status,Time,Size,Timestamp"];
        state.loadTest.results.forEach((row, index) => {
          rows.push([index + 1, row.status, row.time, row.size, row.timestamp].join(","));
        });
        const blob = new Blob([rows.join("\n")], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "load-test-results.csv";
        a.click();
        URL.revokeObjectURL(url);
      };

      const runGraphql = async () => {
        const url = qs("#graphqlUrl").value.trim();
        if (!url) return toast("GraphQL URL required.", "error");
        const query =
          qs('[data-tab-group="graphql"] .tab-btn.active').dataset.tabTarget === "mutation"
            ? qs("#graphqlMutation").value
            : qs('[data-tab-group="graphql"] .tab-btn.active').dataset.tabTarget === "subscription"
            ? qs("#graphqlSubscription").value
            : qs("#graphqlQuery").value;
        const variables = qs("#graphqlVariables").value.trim();
        let vars = {};
        if (variables) {
          try {
            vars = JSON.parse(variables);
          } catch {
            toast("GraphQL variables must be valid JSON.", "error");
            return;
          }
        }
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, variables: vars }),
          });
          const data = await response.json();
          qs("#graphqlResponse").textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          toast("GraphQL request failed: " + err.message, "error");
        }
      };

      const introspectGraphql = async () => {
        const url = qs("#graphqlUrl").value.trim();
        if (!url) return toast("GraphQL URL required.", "error");
        const query = `query IntrospectionQuery { __schema { types { name kind fields { name } } } }`;
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });
          const data = await response.json();
          const types = data.data?.__schema?.types || [];
          const fields = types.flatMap((type) => (type.fields || []).map((field) => field.name));
          state.graphqlSchemaFields = Array.from(new Set(fields));
          qs("#graphqlSchema").textContent = types.map((t) => `${t.name} (${t.kind})`).join("\n");
        } catch (err) {
          toast("Schema introspection failed.", "error");
        }
      };

      const renderMarkdownPreview = (markdown) => {
        const lines = markdown.split("\n");
        let html = "";
        let inList = false;
        lines.forEach((line) => {
          if (line.startsWith("- ")) {
            if (!inList) {
              html += "<ul>";
              inList = true;
            }
            html += `<li>${escapeHtml(line.slice(2))}</li>`;
            return;
          }
          if (inList) {
            html += "</ul>";
            inList = false;
          }
          if (line.startsWith("### ")) {
            html += `<h3>${escapeHtml(line.slice(4))}</h3>`;
          } else if (line.startsWith("## ")) {
            html += `<h2>${escapeHtml(line.slice(3))}</h2>`;
          } else if (line.startsWith("# ")) {
            html += `<h1>${escapeHtml(line.slice(2))}</h1>`;
          } else if (line.trim()) {
            html += `<p>${escapeHtml(line)}</p>`;
          }
        });
        if (inList) html += "</ul>";
        return html;
      };

      const generateDocs = () => {
        const lines = ["# API Documentation", ""];
        state.collections.forEach((collection) => {
          lines.push(`## ${collection.name}`);
          if (collection.children) {
            collection.children.forEach((req) => {
              lines.push(`### ${req.name}`);
              lines.push(`- Method: ${req.method}`);
              lines.push(`- URL: ${req.url || "https://api.example.com"}`);
              lines.push("");
            });
          }
        });
        const markdown = lines.join("\n");
        qs("#docsMarkdown").value = markdown;
        qs("#docsPreview").innerHTML = renderMarkdownPreview(markdown);
      };

      const exportMarkdown = () => {
        const blob = new Blob([qs("#docsMarkdown").value], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "nebula-api-docs.md";
        a.click();
        URL.revokeObjectURL(url);
      };

      const exportHtml = () => {
        const html = `<!DOCTYPE html><html><body><pre>${escapeHtml(qs("#docsMarkdown").value)}</pre></body></html>`;
        const blob = new Blob([html], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "nebula-api-docs.html";
        a.click();
        URL.revokeObjectURL(url);
      };

      const runDiff = () => {
        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(qs("#diffLeft").value, qs("#diffRight").value);
        dmp.diff_cleanupSemantic(diffs);
        const output = diffs
          .map((part) => {
            const [op, text] = part;
            const color = op === 1 ? "var(--green)" : op === -1 ? "var(--red)" : "var(--text)";
            return `<span style="color:${color}">${escapeHtml(text)}</span>`;
          })
          .join("");
        qs("#diffOutput").innerHTML = output;
      };

      const saveDiffSnapshot = () => {
        const list = qs("#diffSnapshots");
        const item = document.createElement("div");
        item.className = "glass p-2 rounded-lg text-xs";
        item.textContent = `Snapshot ${new Date().toLocaleTimeString()}`;
        list.appendChild(item);
      };

      const addChainNode = () => {
        const nodes = qs("#chainNodes");
        const idx = nodes.children.length + 1;
        const item = document.createElement("div");
        item.className = "glass p-2 rounded-lg text-xs";
        item.textContent = `Step ${idx}: ${qs("#methodSelect").value} ${qs("#urlInput").value || "URL"}`;
        nodes.appendChild(item);
      };

      const extractFromResponse = () => {
        const path = qs("#chainJsonPath").value.trim();
        const name = qs("#chainVarName").value.trim();
        if (!path || !name) return toast("JSON path and variable name required.", "error");
        if (!state.lastResponse) return toast("No response available.", "error");
        try {
          const data = JSON.parse(state.lastResponse.body);
          const value = path
            .replace(/^\$\./, "")
            .split(".")
            .reduce((acc, key) => (acc ? acc[key] : undefined), data);
          state.chainVars[name] = value;
          qs("#chainVars").textContent = `${name} = ${value}`;
          toast("Variable extracted.", "success");
        } catch (err) {
          toast("Failed to extract variable.", "error");
        }
      };

      const runSecurityScan = () => {
        const results = qs("#securityResults");
        results.innerHTML = "";
        const findings = [
          { type: "SQL Injection", status: "Safe", detail: "No vulnerable parameters detected." },
          { type: "XSS", status: "Warning", detail: "Potential reflection in query params." },
          { type: "JWT", status: "Info", detail: "Token signature not validated in browser." },
        ];
        findings.forEach((finding) => {
          const item = document.createElement("div");
          item.className = "glass p-2 rounded-lg";
          item.innerHTML = `<div class="flex items-center justify-between"><span>${finding.type}</span><span class="badge">${finding.status}</span></div><div class="text-muted">${finding.detail}</div>`;
          results.appendChild(item);
        });
        toast("Security scan completed.", "success");
      };

      const decodeJwt = () => {
        const token = qs("#jwtInput").value.trim();
        if (!token) return;
        try {
          const [header, payload] = token.split(".").slice(0, 2);
          const decode = (part) => JSON.parse(atob(part.replace(/-/g, "+").replace(/_/g, "/")));
          const result = { header: decode(header), payload: decode(payload) };
          qs("#jwtOutput").textContent = JSON.stringify(result, null, 2);
        } catch (err) {
          toast("Invalid JWT.", "error");
        }
      };

      const parseCsv = (text) => {
        const lines = text.trim().split(/\r?\n/).filter(Boolean);
        if (lines.length < 2) return [];
        const headers = lines[0].split(",").map((h) => h.trim());
        return lines.slice(1).map((line) => {
          const values = line.split(",").map((v) => v.trim());
          return headers.reduce((acc, header, idx) => {
            acc[header] = values[idx] || "";
            return acc;
          }, {});
        });
      };

      const resolveTemplate = (template, row = {}) => {
        return template.replace(/\{\{(.*?)\}\}/g, (_, key) => {
          const trimmed = key.trim();
          if (Object.prototype.hasOwnProperty.call(row, trimmed)) return row[trimmed];
          const path = trimmed.split(".");
          let value = faker;
          path.forEach((segment) => {
            value = value ? value[segment] : "";
          });
          if (typeof value === "function") value = value();
          return value ?? "";
        });
      };

      const handleCsvImport = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const text = await file.text();
        state.csvRows = parseCsv(text);
        if (!state.csvRows.length) {
          toast("CSV file has no data rows.", "error");
          return;
        }
        toast(`CSV loaded with ${state.csvRows.length} rows.`, "success");
      };

      const generateData = async () => {
        const template = qs("#dataTemplate").value.trim();
        if (!template) return;
        try {
          if (state.csvRows && state.csvRows.length) {
            const results = state.csvRows.map((row) => resolveTemplate(template, row));
            const parsedResults = results.map((item) => {
              try {
                return JSON.parse(item);
              } catch {
                return item;
              }
            });
            qs("#dataOutput").value = JSON.stringify(parsedResults, null, 2);
          } else {
            const output = resolveTemplate(template);
            qs("#dataOutput").value = output;
          }
          toast("Data generated.", "success");
        } catch (err) {
          toast("Failed to generate data.", "error");
        }
      };

      const shareRequest = async () => {
        const payload = {
          method: qs("#methodSelect").value,
          url: qs("#urlInput").value,
          headers: qs("#headersEditor").value,
          body: qs("#bodyEditor").value,
        };
        const encoded = btoa(JSON.stringify(payload));
        const url = `${location.origin}${location.pathname}#share=${encoded}`;
        await navigator.clipboard.writeText(url);
        toast("Shareable link copied to clipboard.", "success");
        addAuditLog(`Shared request link at ${new Date().toLocaleTimeString()}`);
      };

      const addAuditLog = (message) => {
        const log = qs("#auditLog");
        const item = document.createElement("div");
        item.textContent = message;
        log.prepend(item);
      };

      const refreshProfiler = () => {
        const metrics = qs("#profilerMetrics");
        metrics.innerHTML = "";
        const entries = [
          { label: "DNS", value: `${Math.round(Math.random() * 10 + 2)} ms` },
          { label: "TCP", value: `${Math.round(Math.random() * 20 + 5)} ms` },
          { label: "TLS", value: `${Math.round(Math.random() * 30 + 8)} ms` },
          { label: "TTFB", value: `${Math.round(Math.random() * 50 + 10)} ms` },
          { label: "Download", value: `${Math.round(Math.random() * 40 + 5)} ms` },
        ];
        entries.forEach((entry) => {
          const card = document.createElement("div");
          card.className = "glass p-3 rounded-xl text-center";
          card.innerHTML = `<div class="label-text">${entry.label}</div><div class="text-sm font-semibold">${entry.value}</div>`;
          metrics.appendChild(card);
        });
        const waterfall = qs("#profilerWaterfall");
        waterfall.innerHTML = "";
        entries.forEach((entry) => {
          const row = document.createElement("div");
          row.className = "text-xs";
          row.innerHTML = `<div class="flex justify-between"><span>${entry.label}</span><span>${entry.value}</span></div><div class="waterfall-bar"></div>`;
          waterfall.appendChild(row);
        });
      };

      const addMockRoute = () => {
        const route = {
          id: `mock-${Date.now()}`,
          path: "/mock",
          status: 200,
          latency: 300,
          contentType: "application/json",
          body: '{"message":"mock response"}',
          condition: "",
        };
        state.mockRoutes.push(route);
        renderMockRoutes();
      };

      const renderMockRoutes = () => {
        const container = qs("#mockRoutes");
        container.innerHTML = "";
        state.mockRoutes.forEach((route) => {
          const card = document.createElement("div");
          card.className = "glass p-3 rounded-xl space-y-2";
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <input data-field="path" class="bg-transparent border border-border rounded-lg px-3 py-2 text-xs font-mono flex-1" value="${route.path}" />
              <button data-action="delete" class="kbd text-red ml-2">Delete</button>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <input data-field="status" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" value="${route.status}" />
              <input data-field="latency" type="number" class="bg-transparent border border-border rounded-lg px-3 py-2" value="${route.latency}" />
              <input data-field="contentType" class="bg-transparent border border-border rounded-lg px-3 py-2" value="${route.contentType}" />
            </div>
            <input data-field="condition" class="bg-transparent border border-border rounded-lg px-3 py-2 text-xs" placeholder="Condition substring (headers/body)" value="${route.condition || ""}" />
            <textarea data-field="body" class="w-full h-24 bg-transparent border border-border rounded-lg p-2 font-mono text-xs">${route.body}</textarea>
          `;
          card.querySelectorAll("input, textarea").forEach((input) => {
            input.addEventListener("input", (event) => {
              route[event.target.dataset.field] =
                event.target.type === "number" ? Number(event.target.value) : event.target.value;
            });
          });
          card.querySelector('[data-action="delete"]').addEventListener("click", () => {
            state.mockRoutes = state.mockRoutes.filter((r) => r.id !== route.id);
            renderMockRoutes();
          });
          container.appendChild(card);
        });
      };

      const setupWebSocket = () => {
        const log = (direction, message, type = "Text") => {
          const logEl = qs("#wsLog");
          const row = document.createElement("div");
          const arrow = direction === "out" ? "&rarr;" : "&larr;";
          const color = direction === "out" ? "text-blue" : "text-green";
          row.innerHTML = `<span class="text-muted">[${new Date().toLocaleTimeString()}]</span> <span class="${color}">${arrow}</span> <span class="badge">${type}</span> ${escapeHtml(message)}`;
          logEl.appendChild(row);
          logEl.scrollTop = logEl.scrollHeight;
        };

        qs("#wsToggle").addEventListener("click", () => {
          if (state.ws.socket) {
            state.ws.socket.close();
            return;
          }
          const url = qs("#wsUrl").value.trim();
          if (!url) return toast("WebSocket URL required.", "error");
          qs("#wsStatusText").textContent = "Connecting...";
          qs("#wsStatusDot").className = "status-dot bg-yellow pulse";
          const socket = new WebSocket(url);
          state.ws.socket = socket;
          socket.onopen = () => {
            qs("#wsStatusText").textContent = "Connected";
            qs("#wsStatusDot").className = "status-dot bg-green";
            qs("#wsToggle").textContent = "Disconnect";
            qs("#wsHeartbeat").textContent = "Connected";
            toast("WebSocket connected.", "success");
          };
          socket.onmessage = (event) => {
            state.ws.received += 1;
            qs("#wsReceived").textContent = state.ws.received;
            if (state.ws.pingStart) {
              const latency = Math.round(performance.now() - state.ws.pingStart);
              qs("#wsLatency").textContent = `${latency} ms`;
              qs("#wsHeartbeat").textContent = "Pong received";
              state.ws.pingStart = null;
            }
            log("in", event.data, "Text");
          };
          socket.onclose = () => {
            qs("#wsStatusText").textContent = "Disconnected";
            qs("#wsStatusDot").className = "status-dot bg-muted";
            qs("#wsToggle").textContent = "Connect";
            qs("#wsLatency").textContent = "-";
            qs("#wsHeartbeat").textContent = "Idle";
            state.ws.socket = null;
            if (qs("#wsReconnect").checked) scheduleReconnect();
          };
          socket.onerror = () => toast("WebSocket error.", "error");
        });

        const sendWs = () => {
          if (!state.ws.socket) return toast("WebSocket not connected.", "error");
          const message = qs("#wsEditor").value;
          state.ws.socket.send(message);
          state.ws.sent += 1;
          qs("#wsSent").textContent = state.ws.sent;
          log("out", message, qs("#wsFormat").value.toUpperCase());
        };

        const scheduleReconnect = () => {
          if (state.ws.reconnectTimer) return;
          let delay = 1000;
          state.ws.reconnectTimer = setInterval(() => {
            if (state.ws.socket) {
              clearInterval(state.ws.reconnectTimer);
              state.ws.reconnectTimer = null;
              return;
            }
            qs("#wsStatusText").textContent = `Reconnecting in ${delay / 1000}s`;
            setTimeout(() => qs("#wsToggle").click(), delay);
            delay = Math.min(delay * 2, 16000);
          }, 4000);
        };

        qs("#wsSend").addEventListener("click", sendWs);
        qs("#wsPing").addEventListener("click", () => {
          qs("#wsEditor").value = '{"type":"ping"}';
          state.ws.pingStart = performance.now();
          sendWs();
          qs("#wsHeartbeat").textContent = "Ping sent";
        });
        qs("#wsTemplate").addEventListener("click", () => {
          qs("#wsEditor").value = '{"type":"custom","payload":{}}';
          updateLineNumbers(qs("#wsEditor"));
        });
        qs("#wsClear").addEventListener("click", () => (qs("#wsLog").innerHTML = ""));
      };

      const initEnvironmentModal = () => {
        const populate = () => {
          const global = qs("#envGlobal");
          const scoped = qs("#envScoped");
          const session = qs("#envSession");
          global.innerHTML = "";
          scoped.innerHTML = "";
          session.innerHTML = "";
          Object.entries(state.envs.global).forEach(([key, value]) =>
            global.appendChild(renderEnvRow("global", key, value))
          );
          Object.entries(state.envs.scoped[state.activeEnv]).forEach(([key, value]) =>
            scoped.appendChild(renderEnvRow("scoped", key, value))
          );
          Object.entries(state.envs.session).forEach(([key, value]) =>
            session.appendChild(renderEnvRow("session", key, value))
          );
        };
        populate();

        qsa("[data-env-add]").forEach((btn) => {
          btn.onclick = () => {
            const scope = btn.dataset.envAdd;
            if (scope === "global") state.envs.global[`key${Date.now()}`] = "";
            if (scope === "scoped") state.envs.scoped[state.activeEnv][`key${Date.now()}`] = "";
            if (scope === "session") state.envs.session[`key${Date.now()}`] = "";
            populate();
            storeEnvs();
          };
        });
      };

      const renderEnvRow = (scope, key, value) => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input data-scope="${scope}" data-field="key" class="flex-1 bg-transparent border border-border rounded-lg px-2 py-1 text-xs" value="${key}" />
          <input data-scope="${scope}" data-field="value" class="flex-1 bg-transparent border border-border rounded-lg px-2 py-1 text-xs" value="${value}" />
        `;
        row.querySelectorAll("input").forEach((input) => {
          input.addEventListener("input", () => {
            if (scope === "global") {
              delete state.envs.global[key];
              state.envs.global[row.querySelector('[data-field="key"]').value] =
                row.querySelector('[data-field="value"]').value;
            }
            if (scope === "scoped") {
              delete state.envs.scoped[state.activeEnv][key];
              state.envs.scoped[state.activeEnv][row.querySelector('[data-field="key"]').value] =
                row.querySelector('[data-field="value"]').value;
            }
            if (scope === "session") {
              delete state.envs.session[key];
              state.envs.session[row.querySelector('[data-field="key"]').value] =
                row.querySelector('[data-field="value"]').value;
            }
            storeEnvs();
          });
        });
        return row;
      };

      const activateWorkspace = (target) => {
        qsa('[data-tab-group="workspace"] .tab-btn').forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tabTarget === target);
        });
        qsa('[data-tab-panel][data-tab-scope="workspace"]').forEach((panel) => {
          if (panel.dataset.tabPanel === target) {
            panel.classList.remove("hidden");
          } else {
            panel.classList.add("hidden");
          }
        });
      };

      const initShortcuts = () => {
        document.addEventListener("keydown", (event) => {
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "p") {
            event.preventDefault();
            openCommandPalette();
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "b") {
            event.preventDefault();
            toggleSidebar();
          }
          if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
            event.preventDefault();
            performRequest();
          }
          if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key.toLowerCase() === "c") {
            event.preventDefault();
            qs("#responseBody").value = "";
            updateLineNumbers(qs("#responseBody"));
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "s") {
            event.preventDefault();
            saveCurrentToCollection();
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "l") {
            event.preventDefault();
            qs("#urlInput").focus();
          }
          if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key.toLowerCase() === "f") {
            event.preventDefault();
            formatJsonBody();
          }
          if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "i") {
            event.preventDefault();
            toggleInterceptor();
          }
          if (event.key === "F10") {
            const modal = qs("#breakpointModal");
            if (!modal.classList.contains("hidden")) qs("#breakpointResume").click();
          }
          if (event.key === " ") {
            event.preventDefault();
            if (state.loadTest.running) {
              pauseLoadTest();
            } else {
              startLoadTest();
            }
          }
          if (event.key === "Escape") {
            if (state.loadTest.running) cancelLoadTest();
            closeCommandPalette();
          }
        });
      };

      const formatJsonBody = () => {
        const body = qs("#bodyEditor");
        try {
          const parsed = JSON.parse(body.value);
          body.value = JSON.stringify(parsed, null, 2);
          body.dataset.language = "json";
          updateLineNumbers(body);
          updateCounts();
          toast("JSON formatted.", "success");
        } catch {
          toast("Invalid JSON.", "error");
          const wrapper = body.closest(".line-editor");
          wrapper.classList.add("shake");
          setTimeout(() => wrapper.classList.remove("shake"), 400);
        }
      };

      const setupRequestUtilities = () => {
        qs("#clearUrlBtn").addEventListener("click", () => (qs("#urlInput").value = ""));
        qs("#saveUrlBtn").addEventListener("click", saveCurrentToCollection);
        qs("#sendBtn").addEventListener("click", performRequest);
        qs("#clearResponseBtn").addEventListener("click", () => {
          qs("#responseBody").value = "";
          updateLineNumbers(qs("#responseBody"));
          qs("#responseWarning").classList.add("hidden");
          qs("#responseVirtualControls").classList.add("hidden");
          state.largeResponseLines = null;
        });
        qs("#copyResponseBtn").addEventListener("click", async () => {
          await navigator.clipboard.writeText(qs("#responseBody").value);
          qs("#copyResponseBtn").classList.add("copy-flash");
          setTimeout(() => qs("#copyResponseBtn").classList.remove("copy-flash"), 800);
          toast("Response copied.", "success");
        });
        qs("#formatJsonBtn").addEventListener("click", formatJsonBody);
        qs("#clearBodyBtn").addEventListener("click", () => {
          qs("#bodyEditor").value = "";
          updateLineNumbers(qs("#bodyEditor"));
          updateCounts();
        });
      };

      const setupFileDrop = () => {
        const drop = qs("#fileDrop");
        const input = qs("#fileInput");
        drop.addEventListener("click", () => input.click());
        drop.addEventListener("dragover", (event) => {
          event.preventDefault();
          drop.classList.add("border-lavender");
        });
        drop.addEventListener("dragleave", () => drop.classList.remove("border-lavender"));
        drop.addEventListener("drop", (event) => {
          event.preventDefault();
          const dt = new DataTransfer();
          Array.from(event.dataTransfer.files).forEach((file) => dt.items.add(file));
          input.files = dt.files;
          drop.classList.remove("border-lavender");
          toast(`${input.files.length} file(s) added.`, "success");
        });
      };

      const setupClipboardData = () => {
        const hash = location.hash;
        if (hash.startsWith("#share=")) {
          try {
            const data = JSON.parse(atob(hash.replace("#share=", "")));
            qs("#methodSelect").value = data.method;
            qs("#urlInput").value = data.url;
            qs("#headersEditor").value = data.headers;
            qs("#bodyEditor").value = data.body;
            qs("#bodyEditor").dataset.language = detectBodyLanguage(qs("#bodyEditor").value);
            updateLineNumbers(qs("#headersEditor"));
            updateLineNumbers(qs("#bodyEditor"));
            updateMethodStyle();
          } catch {
            toast("Failed to load shared request.", "error");
          }
        }
      };

      const setupContextMenu = () => {
        qs("#contextMenu").addEventListener("click", (event) => {
          const action = event.target.dataset.action;
          if (!action) return;
          const nodeId = qs("#contextMenu").dataset.nodeId;
          if (!nodeId) return;
          const node = findNodeById(nodeId, state.collections);
          if (!node) return;
          if (action === "edit") editNode(node);
          if (action === "rename") renameNodeById(nodeId);
          if (action === "duplicate") duplicateNodeById(nodeId);
          if (action === "delete") deleteNodeById(nodeId);
          if (action === "export") exportNodeById(nodeId);
          if (action === "move") moveNodePrompt(nodeId);
          hideContextMenu();
        });
        document.addEventListener("click", hideContextMenu);
      };

      const init = () => {
        loadState();
        initLineEditors();
        initTabs("workspace");
        initTabs("request");
        initTabs("response");
        initTabs("graphql");
        initCommandPalette();
        updateMethodStyle();
        updateCounts();
        renderCollections();
        renderHistory();
        renderFavorites();
        updateEnvIndicator();
        updateInterceptorIndicator();
        setupCharts();
        setupRequestUtilities();
        setupFileDrop();
        setupWebSocket();
        setupContextMenu();
        setupGraphqlAutocomplete();
        initShortcuts();
        initEnvironmentModal();
        renderMockRoutes();
        refreshProfiler();
        setupClipboardData();

        qs("#methodSelect").addEventListener("change", updateMethodStyle);
        qs("#historySearch").addEventListener("input", debounce(renderHistory, 200));
        qs("#interceptorToggle").addEventListener("click", () => toggleInterceptor());
        qs("#interceptorMode").addEventListener("change", (event) => (state.interceptorMode = event.target.value));
        qs("#commandPaletteBtn").addEventListener("click", openCommandPalette);
        qs("#quickSearchBtn").addEventListener("click", openCommandPalette);
        qs("#commandPalette").addEventListener("click", (event) => {
          if (event.target.id === "commandPalette") closeCommandPalette();
        });
        qs("#sidebarToggle").addEventListener("click", toggleSidebar);
        qs("#sidebarOverlay").addEventListener("click", toggleSidebar);
        qs("#envSelect").addEventListener("change", (event) => {
          state.activeEnv = event.target.value;
          updateEnvIndicator();
          initEnvironmentModal();
        });
        qs("#envEditBtn").addEventListener("click", () => {
          qs("#envModal").classList.remove("hidden");
          qs("#envModal").classList.add("flex");
        });
        qs("#envModalClose").addEventListener("click", () => {
          qs("#envModal").classList.add("hidden");
          qs("#envModal").classList.remove("flex");
        });
        qs("#clearInterceptorLog").addEventListener("click", () => {
          state.interceptorLog = [];
          renderInterceptorLog();
        });
        qs("#loadStart").addEventListener("click", startLoadTest);
        qs("#loadPause").addEventListener("click", pauseLoadTest);
        qs("#loadCancel").addEventListener("click", cancelLoadTest);
        qs("#exportCsv").addEventListener("click", exportCsv);
        qs("#graphqlSend").addEventListener("click", runGraphql);
        qs("#graphqlIntrospect").addEventListener("click", introspectGraphql);
        qs("#docsGenerate").addEventListener("click", generateDocs);
        qs("#docsExport").addEventListener("click", exportMarkdown);
        qs("#docsExportHtml").addEventListener("click", exportHtml);
        qs("#docsMarkdown").addEventListener(
          "input",
          debounce(() => {
            qs("#docsPreview").innerHTML = renderMarkdownPreview(qs("#docsMarkdown").value);
          }, 200)
        );
        qs("#diffRun").addEventListener("click", runDiff);
        qs("#diffSave").addEventListener("click", saveDiffSnapshot);
        qs("#chainAdd").addEventListener("click", addChainNode);
        qs("#chainExtract").addEventListener("click", extractFromResponse);
        qs("#securityScan").addEventListener("click", runSecurityScan);
        qs("#jwtDecode").addEventListener("click", decodeJwt);
        qs("#dataGenerate").addEventListener("click", generateData);
        qs("#shareRequest").addEventListener("click", shareRequest);
        qs("#syncWorkspace").addEventListener("click", () => {
          toast("Workspace synced.", "success");
          addAuditLog("Collections synced.");
        });
        qs("#commentAdd").addEventListener("click", () => {
          const input = qs("#commentInput");
          if (!input.value.trim()) return;
          const item = document.createElement("div");
          item.textContent = `${new Date().toLocaleTimeString()}: ${input.value}`;
          qs("#commentList").prepend(item);
          addAuditLog("Comment added.");
          input.value = "";
        });
        qs("#profilerRefresh").addEventListener("click", refreshProfiler);
        qs("#mockAdd").addEventListener("click", addMockRoute);
        qs("#importCurlBtn").addEventListener("click", () => {
          qs("#curlModal").classList.remove("hidden");
          qs("#curlModal").classList.add("flex");
          qs("#curlInput").focus();
        });
        qs("#curlModalClose").addEventListener("click", () => {
          qs("#curlModal").classList.add("hidden");
          qs("#curlModal").classList.remove("flex");
        });
        qs("#curlImport").addEventListener("click", () => {
          importCurl();
          qs("#curlModal").classList.add("hidden");
          qs("#curlModal").classList.remove("flex");
        });
        qs("#importPostmanBtn").addEventListener("click", () => qs("#postmanFile").click());
        qs("#postmanFile").addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) importPostman(file);
          event.target.value = "";
        });
        qs("#exportJsonBtn").addEventListener("click", exportCollectionsJSON);
        qs("#exportOpenapiBtn").addEventListener("click", exportOpenAPI);
        qs("#exportHarBtn").addEventListener("click", exportHAR);
        qs("#dataCsv").addEventListener("change", handleCsvImport);
        qs("#retryCircuit").addEventListener("change", (event) => {
          if (!event.target.checked) {
            state.retryState.paused = false;
            state.retryState.failures = 0;
            qs("#retryStatus").textContent = "";
          }
        });
        qsa("input, textarea").forEach((input) => {
          if (input.type !== "password") {
            input.addEventListener(
              "input",
              debounce(() => {
                showVariableTooltip({ target: input });
                showVariableAutocomplete(input);
              }, 200)
            );
            input.addEventListener("mouseenter", () => showVariableTooltip({ target: input }));
            input.addEventListener("mouseleave", hideVariableTooltip);
            input.addEventListener("blur", () => {
              hideVariableTooltip();
              hideVariableAutocomplete();
            });
          }
        });
        document.addEventListener("click", hideGraphqlAutocomplete);
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
<!--
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebula API Client - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
              mono: ["JetBrains Mono", "ui-monospace", "SFMono-Regular", "monospace"],
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@faker-js/faker/dist/faker.umd.min.js"></script>
    <style>
      :root {
        --crust: #11111b;
        --mantle: #181825;
        --base: #1e1e2e;
        --surface: rgba(30, 30, 46, 0.6);
        --border: rgba(180, 190, 254, 0.1);
        --border-hover: rgba(180, 190, 254, 0.2);
        --lavender: #b4befe;
        --mauve: #cba6f7;
        --blue: #89b4fa;
        --green: #a6e3a1;
        --yellow: #f9e2af;
        --red: #f38ba8;
        --peach: #fab387;
        --text: #cdd6f4;
        --muted: #6c7086;
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        --glow: 0 0 0 3px rgba(180, 190, 254, 0.1);
      }

      body {
        background: linear-gradient(135deg, var(--crust), var(--base));
        color: var(--text);
      }

      .glass {
        background: var(--surface);
        border: 1px solid var(--border);
        backdrop-filter: blur(16px);
        box-shadow: var(--shadow);
      }

      .glass-hover:hover {
        border-color: var(--border-hover);
      }

      .soft-ring:focus {
        outline: none;
        box-shadow: var(--glow);
      }

      .method-option {
        font-weight: 600;
      }

      .method-get {
        color: var(--green);
      }

      .method-post {
        color: var(--blue);
      }

      .method-put {
        color: var(--yellow);
      }

      .method-delete {
        color: var(--red);
      }

      .method-patch {
        color: var(--mauve);
      }

      .method-badge {
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.08);
        text-transform: uppercase;
      }

      .method-badge.method-get {
        background: rgba(166, 227, 161, 0.2);
        color: var(--green);
      }

      .method-badge.method-post {
        background: rgba(137, 180, 250, 0.2);
        color: var(--blue);
      }

      .method-badge.method-put {
        background: rgba(249, 226, 175, 0.2);
        color: var(--yellow);
      }

      .method-badge.method-delete {
        background: rgba(243, 139, 168, 0.2);
        color: var(--red);
      }

      .method-badge.method-patch {
        background: rgba(203, 166, 247, 0.2);
        color: var(--mauve);
      }

      .button-primary {
        background: linear-gradient(135deg, var(--lavender), var(--mauve));
        box-shadow: 0 4px 20px rgba(180, 190, 254, 0.4);
        transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .button-primary:hover {
        transform: translateY(-1px) scale(1.02);
        box-shadow: 0 6px 24px rgba(180, 190, 254, 0.55);
      }

      .button-primary:active {
        transform: translateY(0) scale(0.98);
      }

      .tab-button {
        color: var(--muted);
        transition: color 200ms cubic-bezier(0.4, 0, 0.2, 1),
          background 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .tab-button.active {
        color: var(--lavender);
        border-bottom: 2px solid var(--lavender);
        background: linear-gradient(0deg, rgba(180, 190, 254, 0.1), transparent);
      }

      .tab-button:hover {
        color: var(--text);
      }

      .line-editor {
        display: grid;
        grid-template-columns: 40px 1fr;
        border: 1px solid #313244;
        border-radius: 10px;
        overflow: hidden;
        background: rgba(17, 17, 27, 0.35);
      }

      .line-numbers {
        padding: 12px 8px;
        font-size: 10px;
        text-align: right;
        color: var(--muted);
        border-right: 1px solid #313244;
        user-select: none;
        line-height: 1.6;
        white-space: pre;
      }

      .editor-stack {
        position: relative;
        width: 100%;
      }

      .editor-highlight {
        position: absolute;
        inset: 0;
        padding: 12px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.6;
        color: var(--text);
        white-space: pre;
        pointer-events: none;
        overflow: hidden;
      }

      .editor-input {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 12px;
        background: transparent;
        border: none;
        color: transparent;
        caret-color: var(--text);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.6;
        resize: none;
        outline: none;
      }

      .editor-input::selection {
        background: rgba(180, 190, 254, 0.2);
      }

      .editor-textarea {
        color: var(--text);
      }

      .pill {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: rgba(49, 50, 68, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .pill.success {
        color: var(--green);
        box-shadow: 0 0 8px rgba(166, 227, 161, 0.3);
      }

      .pill.warn {
        color: var(--yellow);
      }

      .pill.error {
        color: var(--red);
        box-shadow: 0 0 8px rgba(243, 139, 168, 0.3);
      }

      .pill.peach {
        color: var(--peach);
        box-shadow: 0 0 8px rgba(250, 179, 135, 0.3);
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(249, 226, 175, 0.6);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(249, 226, 175, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(249, 226, 175, 0);
        }
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(180, 190, 254, 0.15);
        border-top-color: var(--lavender);
        border-radius: 999px;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .progress-shimmer {
        background: linear-gradient(
          90deg,
          rgba(180, 190, 254, 0.2),
          rgba(203, 166, 247, 0.6),
          rgba(180, 190, 254, 0.2)
        );
        background-size: 200% 100%;
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      .toast {
        animation: toastIn 300ms ease, toastOut 300ms ease 3s forwards;
      }

      @keyframes toastIn {
        from {
          transform: translateY(10px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes toastOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(10px);
          opacity: 0;
        }
      }

      .modal-enter {
        animation: modalIn 300ms ease;
      }

      @keyframes modalIn {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .shake {
        animation: shake 0.3s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-4px);
        }
        50% {
          transform: translateX(4px);
        }
        75% {
          transform: translateX(-4px);
        }
      }

      .success-bounce {
        animation: successBounce 0.5s ease;
      }

      @keyframes successBounce {
        0% {
          transform: scale(0.9);
        }
        60% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .context-menu {
        width: 200px;
        z-index: 50;
      }

      .sidebar-collapsed {
        width: 72px !important;
      }

      .badge-count {
        padding: 0 6px;
        font-size: 10px;
        border-radius: 999px;
        background: rgba(49, 50, 68, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .response-viewer {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }

      .syntax-key {
        color: var(--lavender);
      }

      .syntax-string {
        color: var(--green);
      }

      .syntax-number {
        color: var(--peach);
      }

      .syntax-boolean {
        color: var(--blue);
      }

      .diff-added {
        background: rgba(166, 227, 161, 0.2);
      }

      .diff-removed {
        background: rgba(243, 139, 168, 0.2);
      }

      @media (max-width: 768px) {
        #sidebar {
          position: absolute;
          z-index: 40;
          height: calc(100% - 56px);
          transform: translateX(-100%);
          transition: transform 300ms ease;
        }

        #sidebar.open {
          transform: translateX(0);
        }

        #mainContent {
          padding-left: 0;
        }
      }
    </style>
  </head>
  <body class="font-sans">
    <div id="app" class="min-h-screen flex flex-col">
      <header class="h-14 px-4 flex items-center justify-between glass glass-hover">
        <div class="flex items-center gap-4">
          <button
            id="mobileMenuBtn"
            class="lg:hidden px-2 py-1 rounded-md text-xs bg-[#313244]"
          >
            Menu
          </button>
          <div class="flex items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-[var(--lavender)]"></div>
            <span class="text-sm font-semibold tracking-wide">Nebula API Client</span>
          </div>
          <div class="hidden lg:flex items-center gap-2 text-xs">
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="http"
            >
              HTTP
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="websocket"
            >
              WebSocket
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="loadtest"
            >
              Load Test
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="graphql"
            >
              GraphQL
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="docs"
            >
              Docs
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="diff"
            >
              Diff
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="chain"
            >
              Chains
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="security"
            >
              Security
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="generator"
            >
              Generator
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="collab"
            >
              Collab
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="profiler"
            >
              Profiler
            </button>
            <button
              class="mode-btn px-3 py-1 rounded-full glass-hover border border-transparent"
              data-mode="mock"
            >
              Mock
            </button>
          </div>
        </div>
        <div class="flex items-center gap-3 text-xs">
          <button
            id="commandPaletteBtn"
            class="px-3 py-1 rounded-lg border border-[#313244] glass-hover"
          >
            Command Palette (Ctrl+P)
          </button>
          <button
            id="toggleInterceptorBtn"
            class="px-3 py-1 rounded-lg border border-[#313244] glass-hover flex items-center gap-2"
          >
            <span class="text-xs">Interceptor</span>
            <span
              id="interceptorIndicator"
              class="h-2 w-2 rounded-full bg-[var(--red)] hidden"
            ></span>
          </button>
          <button
            id="toggleSidebarBtn"
            class="px-3 py-1 rounded-lg border border-[#313244] glass-hover"
          >
            Toggle Sidebar (Ctrl+B)
          </button>
        </div>
      </header>
      <div class="flex flex-1 overflow-hidden">
        <aside
          id="sidebar"
          class="w-80 glass glass-hover flex flex-col gap-4 p-4 overflow-hidden transition-all duration-300"
        >
          <div class="flex flex-col gap-2">
            <label class="text-[10px] uppercase tracking-widest text-[var(--muted)]"
              >Quick Search (Ctrl+K)</label
            >
            <input
              id="quickSearchInput"
              class="px-3 py-2 rounded-lg bg-[#0f0f1b] border border-[#313244] text-xs soft-ring"
              placeholder="Search collections, history, docs"
            />
          </div>

          <div class="flex items-center justify-between">
            <span class="text-[10px] uppercase tracking-widest text-[var(--muted)]"
              >Collections</span
            >
            <div class="flex gap-2">
              <button id="addFolderBtn" class="text-xs px-2 py-1 rounded bg-[#313244]">
                + Folder
              </button>
              <button id="addRequestBtn" class="text-xs px-2 py-1 rounded bg-[#313244]">
                + Request
              </button>
            </div>
          </div>
          <div
            id="collectionTree"
            class="flex-1 overflow-auto pr-2 space-y-2 text-xs"
          ></div>

          <div class="flex items-center justify-between">
            <span class="text-[10px] uppercase tracking-widest text-[var(--muted)]"
              >History (Last 50)</span
            >
            <button id="clearHistoryBtn" class="text-xs px-2 py-1 rounded bg-[#313244]">
              Clear
            </button>
          </div>
          <div id="historyList" class="max-h-40 overflow-auto space-y-2 text-xs"></div>

          <div class="flex flex-col gap-2">
            <span class="text-[10px] uppercase tracking-widest text-[var(--muted)]"
              >Interceptor Log</span
            >
            <div class="grid grid-cols-3 gap-2 text-[10px]">
              <div class="glass p-2 rounded-lg text-center">
                <div class="text-[var(--muted)]">Intercepted</div>
                <div id="statIntercepted" class="text-sm font-semibold">0</div>
              </div>
              <div class="glass p-2 rounded-lg text-center">
                <div class="text-[var(--muted)]">Modified</div>
                <div id="statModified" class="text-sm font-semibold">0</div>
              </div>
              <div class="glass p-2 rounded-lg text-center">
                <div class="text-[var(--muted)]">Blocked</div>
                <div id="statBlocked" class="text-sm font-semibold">0</div>
              </div>
            </div>
            <div id="interceptorLog" class="max-h-32 overflow-auto space-y-2 text-xs"></div>
            <div class="flex items-center gap-2">
              <label class="text-[10px] text-[var(--muted)]">Mode</label>
              <select
                id="interceptorModeSelect"
                class="px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-xs soft-ring"
              >
                <option value="request">Request</option>
                <option value="response">Response</option>
                <option value="both">Both</option>
              </select>
            </div>
          </div>

          <div class="mt-auto flex flex-col gap-2">
            <span class="text-[10px] uppercase tracking-widest text-[var(--muted)]"
              >Environment</span
            >
            <div class="flex items-center gap-2">
              <div
                id="envIndicator"
                class="h-2 w-2 rounded-full bg-[var(--green)]"
              ></div>
              <select
                id="envSelector"
                class="flex-1 px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs soft-ring"
              >
                <option>Development</option>
                <option>Staging</option>
                <option>Production</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button id="editEnvBtn" class="flex-1 text-xs px-2 py-2 rounded bg-[#313244]">
                Edit Variables
              </button>
              <button id="addGlobalVarBtn" class="flex-1 text-xs px-2 py-2 rounded bg-[#313244]">
                Globals
              </button>
            </div>
          </div>
        </aside>

        <main id="mainContent" class="flex-1 p-4 overflow-hidden">
          <section id="mode-http" class="mode-panel flex flex-col h-full gap-4">
            <div class="glass glass-hover rounded-2xl p-4 flex flex-col h-[40%] min-h-[260px]">
              <div class="flex items-center gap-3">
                <select
                  id="methodSelect"
                  class="w-28 px-3 py-2 rounded-xl bg-[#0f0f1b] border border-[#313244] text-sm font-semibold soft-ring"
                >
                  <option value="GET" class="method-option method-get">GET</option>
                  <option value="POST" class="method-option method-post">POST</option>
                  <option value="PUT" class="method-option method-put">PUT</option>
                  <option value="DELETE" class="method-option method-delete">DELETE</option>
                  <option value="PATCH" class="method-option method-patch">PATCH</option>
                </select>
                <div class="flex-1 flex items-center gap-2">
                  <input
                    id="urlInput"
                    class="flex-1 px-3 py-2 rounded-lg bg-[#0f0f1b] border border-[#313244] text-xs font-mono soft-ring"
                    placeholder="https://api.example.com/v1/resource"
                  />
                  <button
                    id="clearUrlBtn"
                    class="px-2 py-2 rounded-lg bg-[#313244] text-xs"
                  >
                    Clear
                  </button>
                  <button
                    id="saveRequestBtn"
                    class="px-2 py-2 rounded-lg bg-[#313244] text-xs"
                  >
                    Save
                  </button>
                </div>
                <button
                  id="sendRequestBtn"
                  class="button-primary px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2"
                >
                  Send
                  <sup class="text-[10px] opacity-70">Cmd+Enter</sup>
                </button>
              </div>

              <div class="flex items-center justify-between mt-4 border-b border-[#313244]">
                <div class="flex gap-4 text-xs">
                  <button class="tab-button py-2" data-tab-group="request" data-tab="params">
                    Params <span class="badge-count" id="paramsCount">0</span>
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="headers">
                    Headers <span class="badge-count" id="headersCount">0</span>
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="body">
                    Body
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="auth">
                    Auth
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="pre">
                    Pre-request
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="tests">
                    Tests
                  </button>
                  <button class="tab-button py-2" data-tab-group="request" data-tab="settings">
                    Settings
                  </button>
                </div>
                <div class="flex items-center gap-2 text-[10px] text-[var(--muted)]">
                  <span>Size Limit 10MB</span>
                </div>
              </div>

              <div class="flex-1 overflow-hidden pt-3">
                <div class="tab-content" data-tab-group="request" data-tab-content="params">
                  <div class="grid gap-2">
                    <div id="paramsList" class="space-y-2"></div>
                    <button id="addParamBtn" class="text-xs px-2 py-1 rounded bg-[#313244] w-fit">
                      + Add Param
                    </button>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="headers">
                  <div class="line-editor h-[140px]" data-lang="json">
                    <div class="line-numbers"></div>
                    <div class="editor-stack">
                      <pre class="editor-highlight"></pre>
                      <textarea id="headersEditor" class="editor-input"></textarea>
                    </div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="body">
                  <div class="flex gap-3">
                    <div class="line-editor flex-1 h-[160px]" data-lang="json">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="bodyEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                    <div class="w-48 space-y-2 text-xs">
                      <label class="text-[10px] text-[var(--muted)] uppercase tracking-widest"
                        >Uploads</label
                      >
                      <div
                        id="fileDropZone"
                        class="h-24 rounded-lg border border-dashed border-[#313244] flex items-center justify-center text-[10px] text-[var(--muted)]"
                      >
                        Drop file here
                      </div>
                      <input id="fileInput" type="file" class="text-[10px]" />
                      <button
                        id="formatJsonBtn"
                        class="text-xs px-2 py-1 rounded bg-[#313244] w-full"
                      >
                        Format JSON (Ctrl+Shift+F)
                      </button>
                    </div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="auth">
                  <div class="flex items-center gap-3 text-xs">
                    <select
                      id="authTypeSelect"
                      class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] soft-ring"
                    >
                      <option value="none">None</option>
                      <option value="bearer">Bearer Token</option>
                      <option value="basic">Basic Auth</option>
                      <option value="apikey">API Key</option>
                    </select>
                    <input
                      id="authValueInput"
                      class="flex-1 px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] soft-ring"
                      placeholder="Auth value"
                    />
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="pre">
                  <div class="flex flex-col gap-2">
                    <div class="line-editor h-[120px]" data-lang="javascript">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="preRequestEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                      <span class="text-[10px] text-[var(--muted)]">Console</span>
                      <button id="togglePreConsoleBtn" class="text-[10px] px-2 py-1 bg-[#313244] rounded">
                        Collapse
                      </button>
                    </div>
                    <div
                      id="preConsole"
                      class="h-24 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-[10px] font-mono"
                    ></div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="tests">
                  <div class="flex flex-col gap-2">
                    <div class="line-editor h-[120px]" data-lang="javascript">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="testScriptEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                    <div class="text-xs text-[var(--muted)]">Results</div>
                    <div
                      id="testResults"
                      class="h-20 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-[10px] font-mono"
                    ></div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="request" data-tab-content="settings">
                  <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="space-y-2">
                      <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                        Auto Retry
                      </div>
                      <div class="flex items-center gap-2">
                        <input id="retryToggle" type="checkbox" class="accent-[var(--lavender)]" />
                        <span>Enable Retry</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="text-[10px] text-[var(--muted)]">Max Attempts</label>
                        <input
                          id="retryAttempts"
                          type="number"
                          min="1"
                          max="5"
                          value="3"
                          class="w-20 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                        />
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="text-[10px] text-[var(--muted)]">Retry Codes</label>
                        <input
                          id="retryCodes"
                          type="text"
                          value="502,503,504"
                          class="flex-1 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                        />
                      </div>
                    </div>
                    <div class="space-y-2">
                      <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                        Limits
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="text-[10px] text-[var(--muted)]">Timeout (ms)</label>
                        <input
                          id="timeoutInput"
                          type="number"
                          value="15000"
                          class="w-24 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                        />
                      </div>
                      <div class="flex items-center gap-2">
                        <label class="text-[10px] text-[var(--muted)]">Warn if ></label>
                        <input
                          id="sizeLimitInput"
                          type="number"
                          value="10"
                          class="w-16 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                        />
                        <span class="text-[10px] text-[var(--muted)]">MB</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <input id="followRedirectsToggle" type="checkbox" checked class="accent-[var(--lavender)]" />
                        <span>Follow Redirects</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="glass glass-hover rounded-2xl p-4 flex flex-col h-[60%] min-h-[320px]">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span id="statusPill" class="pill">--</span>
                  <span id="timePill" class="pill">--</span>
                  <span id="sizePill" class="pill">--</span>
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <button id="copyResponseBtn" class="px-2 py-1 rounded bg-[#313244]">
                    Copy
                  </button>
                  <button id="clearResponseBtn" class="px-2 py-1 rounded bg-[#313244]">
                    Clear (Ctrl+Shift+C)
                  </button>
                </div>
              </div>

              <div class="flex items-center justify-between mt-4 border-b border-[#313244]">
                <div class="flex gap-4 text-xs">
                  <button class="tab-button py-2" data-tab-group="response" data-tab="body">
                    Body
                  </button>
                  <button class="tab-button py-2" data-tab-group="response" data-tab="headers">
                    Headers
                  </button>
                  <button class="tab-button py-2" data-tab-group="response" data-tab="cookies">
                    Cookies
                  </button>
                  <button class="tab-button py-2" data-tab-group="response" data-tab="timeline">
                    Timeline
                  </button>
                  <button class="tab-button py-2" data-tab-group="response" data-tab="tests">
                    Tests
                  </button>
                  <button class="tab-button py-2" data-tab-group="response" data-tab="diff">
                    Diff
                  </button>
                </div>
                <div class="text-[10px] text-[var(--muted)]">Syntax: JSON/XML/HTML/SQL</div>
              </div>

              <div class="flex-1 overflow-hidden pt-3">
                <div class="tab-content response-viewer" data-tab-group="response" data-tab-content="body">
                  <div
                    id="responseVirtualContainer"
                    class="h-full overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3"
                  >
                    <div id="responseVirtualContent"></div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="response" data-tab-content="headers">
                  <div
                    id="responseHeaders"
                    class="h-full overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                  ></div>
                </div>
                <div class="tab-content hidden" data-tab-group="response" data-tab-content="cookies">
                  <div
                    id="responseCookies"
                    class="h-full overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                  ></div>
                </div>
                <div class="tab-content hidden" data-tab-group="response" data-tab-content="timeline">
                  <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">DNS Lookup</div>
                      <div id="perfDns" class="text-lg">--</div>
                    </div>
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">TCP Connect</div>
                      <div id="perfTcp" class="text-lg">--</div>
                    </div>
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">TLS Handshake</div>
                      <div id="perfTls" class="text-lg">--</div>
                    </div>
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">TTFB</div>
                      <div id="perfTtfb" class="text-lg">--</div>
                    </div>
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">Download</div>
                      <div id="perfDownload" class="text-lg">--</div>
                    </div>
                    <div class="glass p-3 rounded-lg">
                      <div class="text-[10px] text-[var(--muted)]">Total</div>
                      <div id="perfTotal" class="text-lg">--</div>
                    </div>
                  </div>
                  <div class="mt-3 glass rounded-lg p-3">
                    <div class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      Waterfall
                    </div>
                    <div id="waterfallChart" class="mt-2 space-y-2 text-[10px]"></div>
                  </div>
                </div>
                <div class="tab-content hidden" data-tab-group="response" data-tab-content="tests">
                  <div
                    id="responseTestResults"
                    class="h-full overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                  ></div>
                </div>
                <div class="tab-content hidden" data-tab-group="response" data-tab-content="diff">
                  <div class="grid grid-cols-2 gap-3 h-full">
                    <textarea
                      id="diffLeft"
                      class="h-full bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                      placeholder="Baseline response"
                    ></textarea>
                    <textarea
                      id="diffRight"
                      class="h-full bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                      placeholder="New response"
                    ></textarea>
                  </div>
                  <button
                    id="runDiffBtn"
                    class="mt-2 px-3 py-2 rounded bg-[#313244] text-xs"
                  >
                    Compare Responses
                  </button>
                  <div
                    id="diffOutput"
                    class="mt-2 h-32 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                  ></div>
                </div>
              </div>
            </div>
          </section>

          <section id="mode-loadtest" class="mode-panel hidden h-full">
            <div class="grid grid-cols-3 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-4 overflow-auto">
                <div class="text-xs uppercase tracking-widest text-[var(--muted)]">
                  Load Test Configuration
                </div>
                <div class="space-y-3 text-xs">
                  <label class="text-[10px] text-[var(--muted)]">Profile</label>
                  <select id="loadProfile" class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244]">
                    <option>Spike</option>
                    <option>Ramp-up</option>
                    <option>Soak</option>
                    <option>Stress</option>
                    <option>Custom</option>
                  </select>
                  <label class="text-[10px] text-[var(--muted)]">Total Requests</label>
                  <input id="loadTotal" type="number" value="1000" class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244]" />
                  <label class="text-[10px] text-[var(--muted)]">Concurrency</label>
                  <input id="loadConcurrency" type="number" value="50" class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244]" />
                  <label class="text-[10px] text-[var(--muted)]">Ramp-up Time (s)</label>
                  <input id="loadRamp" type="number" value="10" class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244]" />
                  <label class="text-[10px] text-[var(--muted)]">Timeout (ms)</label>
                  <input id="loadTimeout" type="number" value="15000" class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244]" />
                  <div class="flex items-center gap-2">
                    <input id="loadKeepAlive" type="checkbox" checked class="accent-[var(--lavender)]" />
                    <span>Keep-alive</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <input id="loadRandomize" type="checkbox" class="accent-[var(--lavender)]" />
                    <span>Randomize payload</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <input id="loadRedirects" type="checkbox" checked class="accent-[var(--lavender)]" />
                    <span>Follow redirects</span>
                  </div>
                  <button id="startLoadTestBtn" class="button-primary px-3 py-2 rounded-lg text-xs">
                    Start Test (Space)
                  </button>
                  <button id="cancelLoadTestBtn" class="px-3 py-2 rounded-lg text-xs bg-[#40303a] hidden">
                    Cancel (Esc)
                  </button>
                </div>
              </div>

              <div class="col-span-2 flex flex-col gap-4">
                <div class="grid grid-cols-5 gap-3 text-xs">
                  <div class="glass rounded-xl p-3">
                    <div class="text-[10px] text-[var(--muted)]">RPS</div>
                    <div id="metricRps" class="text-lg text-[var(--lavender)]">0</div>
                  </div>
                  <div class="glass rounded-xl p-3">
                    <div class="text-[10px] text-[var(--muted)]">Avg Latency</div>
                    <div id="metricAvg" class="text-lg">0ms</div>
                    <div id="metricMinMax" class="text-[10px] text-[var(--muted)]">0/0</div>
                  </div>
                  <div class="glass rounded-xl p-3">
                    <div class="text-[10px] text-[var(--muted)]">P95</div>
                    <div id="metricP95" class="text-lg text-[var(--peach)]">0ms</div>
                  </div>
                  <div class="glass rounded-xl p-3">
                    <div class="text-[10px] text-[var(--muted)]">Error Rate</div>
                    <div id="metricError" class="text-lg text-[var(--red)]">0%</div>
                    <div id="metricErrorCount" class="text-[10px] text-[var(--muted)]">0 errors</div>
                  </div>
                  <div class="glass rounded-xl p-3">
                    <div class="text-[10px] text-[var(--muted)]">Throughput</div>
                    <div id="metricThroughput" class="text-lg">0 KB/s</div>
                  </div>
                </div>

                <div class="glass rounded-xl p-4">
                  <div class="flex items-center justify-between text-xs">
                    <span class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      Progress
                    </span>
                    <span id="loadProgressText">0%</span>
                  </div>
                  <div class="h-3 rounded-full bg-[#0f0f1b] overflow-hidden mt-2">
                    <div id="loadProgressBar" class="h-full w-0 progress-shimmer"></div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div class="glass rounded-xl p-4">
                    <div class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      Latency Distribution
                    </div>
                    <canvas id="latencyChart" height="160"></canvas>
                  </div>
                  <div class="glass rounded-xl p-4">
                    <div class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      RPS Timeline
                    </div>
                    <canvas id="rpsChart" height="160"></canvas>
                  </div>
                </div>

                <div class="glass rounded-xl p-4 flex flex-col">
                  <div class="flex items-center justify-between text-xs mb-2">
                    <span class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      Results
                    </span>
                    <button id="exportCsvBtn" class="px-2 py-1 rounded bg-[#313244]">
                      Export CSV
                    </button>
                  </div>
                  <div class="overflow-auto max-h-48">
                    <table class="w-full text-[10px]">
                      <thead class="text-[var(--muted)]">
                        <tr>
                          <th class="text-left">#</th>
                          <th class="text-left">Status</th>
                          <th class="text-left">Time</th>
                          <th class="text-left">Size</th>
                          <th class="text-left">Timestamp</th>
                        </tr>
                      </thead>
                      <tbody id="loadResultsTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section id="mode-websocket" class="mode-panel hidden h-full">
            <div class="glass rounded-2xl p-4 flex flex-col h-full gap-4">
              <div class="flex items-center gap-3 text-xs">
                <input
                  id="wsUrlInput"
                  class="flex-1 px-3 py-2 rounded-lg bg-[#0f0f1b] border border-[#313244] text-xs font-mono"
                  placeholder="wss://example.com/socket"
                />
                <button id="wsToggleBtn" class="button-primary px-3 py-2 rounded-lg text-xs">
                  Connect
                </button>
                <div class="flex items-center gap-2">
                  <div id="wsStatusDot" class="h-2 w-2 rounded-full bg-[var(--yellow)] pulse"></div>
                  <span id="wsStatusText" class="text-[10px] text-[var(--muted)]">Disconnected</span>
                </div>
                <div class="flex items-center gap-2">
                  <input id="wsAutoReconnect" type="checkbox" class="accent-[var(--lavender)]" />
                  <span class="text-[10px]">Auto Reconnect</span>
                </div>
              </div>

              <div class="flex-1 grid grid-cols-10 gap-4">
                <div class="col-span-7 glass rounded-xl p-3 flex flex-col">
                  <div class="flex items-center justify-between text-xs mb-2">
                    <span class="text-[10px] text-[var(--muted)] uppercase tracking-widest">
                      Message Log
                    </span>
                    <button id="wsClearBtn" class="px-2 py-1 rounded bg-[#313244] text-[10px]">
                      Clear
                    </button>
                  </div>
                  <div
                    id="wsLog"
                    class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-[10px] font-mono"
                  ></div>
                  <div class="flex items-center justify-between mt-2 text-[10px] text-[var(--muted)]">
                    <span id="wsMetrics">Latency: -- | Sent: 0 | Received: 0</span>
                    <span>Heartbeat: <span id="wsHeartbeat">Idle</span></span>
                  </div>
                </div>
                <div class="col-span-3 glass rounded-xl p-3 flex flex-col">
                  <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                    Composer
                  </div>
                  <select
                    id="wsFormatSelect"
                    class="mt-2 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  >
                    <option>JSON</option>
                    <option>Text</option>
                    <option>Binary</option>
                  </select>
                  <div class="line-editor mt-2 h-40" data-lang="json">
                    <div class="line-numbers"></div>
                    <div class="editor-stack">
                      <pre class="editor-highlight"></pre>
                      <textarea id="wsMessageEditor" class="editor-input"></textarea>
                    </div>
                  </div>
                  <button id="wsSendBtn" class="button-primary mt-2 px-3 py-2 rounded-lg text-xs">
                    Send (Ctrl+Enter)
                  </button>
                  <div class="mt-2 text-[10px] text-[var(--muted)]">Templates</div>
                  <div class="flex gap-2 mt-1">
                    <button class="px-2 py-1 rounded bg-[#313244] text-[10px]" data-template="ping">
                      ping
                    </button>
                    <button class="px-2 py-1 rounded bg-[#313244] text-[10px]" data-template="json">
                      JSON
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <section id="mode-graphql" class="mode-panel hidden h-full">
            <div class="grid grid-cols-3 gap-4 h-full">
              <div class="col-span-2 glass rounded-2xl p-4 flex flex-col gap-4">
                <div class="flex items-center gap-2 text-xs">
                  <input
                    id="graphqlUrl"
                    class="flex-1 px-3 py-2 rounded-lg bg-[#0f0f1b] border border-[#313244] text-xs font-mono"
                    placeholder="https://api.example.com/graphql"
                  />
                  <button id="graphqlIntrospectBtn" class="px-3 py-2 rounded-lg bg-[#313244]">
                    Introspect
                  </button>
                </div>
                <div class="flex gap-2 text-xs">
                  <button class="tab-button py-2" data-tab-group="graphql" data-tab="query">
                    Query
                  </button>
                  <button class="tab-button py-2" data-tab-group="graphql" data-tab="mutation">
                    Mutation
                  </button>
                  <button class="tab-button py-2" data-tab-group="graphql" data-tab="subscription">
                    Subscription
                  </button>
                </div>
                <div class="flex-1">
                  <div class="tab-content" data-tab-group="graphql" data-tab-content="query">
                    <div class="line-editor h-[220px]" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="graphqlQueryEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="tab-content hidden" data-tab-group="graphql" data-tab-content="mutation">
                    <div class="line-editor h-[220px]" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="graphqlMutationEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="tab-content hidden" data-tab-group="graphql" data-tab-content="subscription">
                    <div class="line-editor h-[220px]" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="graphqlSubscriptionEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <div class="text-[10px] text-[var(--muted)] uppercase tracking-widest">Variables</div>
                    <div class="line-editor h-32" data-lang="json">
                      <div class="line-numbers"></div>
                      <div class="editor-stack">
                        <pre class="editor-highlight"></pre>
                        <textarea id="graphqlVariablesEditor" class="editor-input"></textarea>
                      </div>
                    </div>
                  </div>
                  <div>
                    <div class="text-[10px] text-[var(--muted)] uppercase tracking-widest">Response</div>
                    <div
                      id="graphqlResponse"
                      class="h-32 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-[10px] font-mono"
                    ></div>
                  </div>
                </div>
                <button id="graphqlSendBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Run GraphQL
                </button>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">Schema</div>
                <div
                  id="graphqlSchema"
                  class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-[10px] font-mono"
                ></div>
              </div>
            </div>
          </section>

          <section id="mode-docs" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Documentation Generator
                </div>
                <button id="generateDocsBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Generate Markdown
                </button>
                <textarea
                  id="docsMarkdown"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Markdown output"
                ></textarea>
                <div class="flex gap-2">
                  <button id="exportMarkdownBtn" class="px-3 py-2 rounded-lg bg-[#313244] text-xs">
                    Export Markdown
                  </button>
                  <button id="exportHtmlBtn" class="px-3 py-2 rounded-lg bg-[#313244] text-xs">
                    Export HTML
                  </button>
                </div>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">Preview</div>
                <div
                  id="docsPreview"
                  class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-4 text-xs"
                ></div>
              </div>
            </div>
          </section>

          <section id="mode-diff" class="mode-panel hidden h-full">
            <div class="glass rounded-2xl p-4 flex flex-col gap-3 h-full">
              <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                Diff Viewer
              </div>
              <div class="grid grid-cols-2 gap-3 flex-1">
                <textarea
                  id="diffStandaloneLeft"
                  class="h-full bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Response A"
                ></textarea>
                <textarea
                  id="diffStandaloneRight"
                  class="h-full bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Response B"
                ></textarea>
              </div>
              <button id="runStandaloneDiffBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                Compare
              </button>
              <div
                id="diffStandaloneOutput"
                class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
              ></div>
            </div>
          </section>

          <section id="mode-chain" class="mode-panel hidden h-full">
            <div class="grid grid-cols-3 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Chain Builder
                </div>
                <button id="addChainNodeBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Add Node
                </button>
                <div id="chainNodes" class="space-y-2 text-xs"></div>
              </div>
              <div class="col-span-2 glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Chain Graph
                </div>
                <div
                  id="chainGraph"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                ></div>
                <div class="grid grid-cols-3 gap-3 text-xs">
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">Extract JSONPath</div>
                    <input
                      id="chainJsonPath"
                      class="w-full px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                      placeholder="data.user.id"
                    />
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">Assign to Variable</div>
                    <input
                      id="chainVarName"
                      class="w-full px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                      placeholder="userId"
                    />
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">Condition</div>
                    <input
                      id="chainCondition"
                      class="w-full px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244]"
                      placeholder="status == 200"
                    />
                  </div>
                </div>
                <button id="runChainBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Run Chain
                </button>
                <div id="chainOutput" class="text-xs"></div>
              </div>
            </div>
          </section>

          <section id="mode-security" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Security Scanner
                </div>
                <input
                  id="securityTarget"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  placeholder="Target URL or JWT"
                />
                <textarea
                  id="securityPayload"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Request/Response content"
                ></textarea>
                <button id="runSecurityScanBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Run Scan
                </button>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">Findings</div>
                <div
                  id="securityResults"
                  class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                ></div>
              </div>
            </div>
          </section>

          <section id="mode-generator" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Data Generator
                </div>
                <select
                  id="fakerType"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                >
                  <option value="person.fullName">Person Name</option>
                  <option value="internet.email">Email</option>
                  <option value="internet.url">URL</option>
                  <option value="location.city">City</option>
                  <option value="company.name">Company</option>
                  <option value="datatype.uuid">UUID</option>
                </select>
                <input
                  id="fakerCount"
                  type="number"
                  value="5"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                />
                <button id="generateDataBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Generate
                </button>
                <textarea
                  id="fakerOutput"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                ></textarea>
                <button id="copyFakerBtn" class="px-3 py-2 rounded bg-[#313244] text-xs w-fit">
                  Copy
                </button>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Bulk Request Generator
                </div>
                <textarea
                  id="bulkCsvInput"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Paste CSV to generate payloads"
                ></textarea>
                <button id="generateFromCsvBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Generate Payloads
                </button>
                <textarea
                  id="bulkPayloadOutput"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                ></textarea>
              </div>
            </div>
          </section>

          <section id="mode-collab" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Collaboration
                </div>
                <button id="shareRequestBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Generate Shareable Link
                </button>
                <input
                  id="shareableLink"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  placeholder="Shareable link"
                />
                <textarea
                  id="collabComments"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="Add comment"
                ></textarea>
                <button id="addCommentBtn" class="px-3 py-2 rounded bg-[#313244] text-xs w-fit">
                  Add Comment
                </button>
                <div id="commentList" class="space-y-2 text-xs"></div>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Audit Log
                </div>
                <div
                  id="auditLog"
                  class="flex-1 overflow-auto bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs"
                ></div>
              </div>
            </div>
          </section>

          <section id="mode-profiler" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Performance Profiler
                </div>
                <input
                  id="profilerUrl"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  placeholder="https://api.example.com/profile"
                />
                <button id="runProfilerBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Run Profile
                </button>
                <div class="grid grid-cols-2 gap-3 text-xs">
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">DNS</div>
                    <div id="profDns" class="text-lg">--</div>
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">TCP</div>
                    <div id="profTcp" class="text-lg">--</div>
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">TLS</div>
                    <div id="profTls" class="text-lg">--</div>
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">TTFB</div>
                    <div id="profTtfb" class="text-lg">--</div>
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">Download</div>
                    <div id="profDownload" class="text-lg">--</div>
                  </div>
                  <div class="glass p-3 rounded-lg">
                    <div class="text-[10px] text-[var(--muted)]">Total</div>
                    <div id="profTotal" class="text-lg">--</div>
                  </div>
                </div>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Waterfall Visualization
                </div>
                <div id="profWaterfall" class="flex-1 space-y-2 text-xs"></div>
              </div>
            </div>
          </section>

          <section id="mode-mock" class="mode-panel hidden h-full">
            <div class="grid grid-cols-2 gap-4 h-full">
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Mock Server
                </div>
                <div class="flex items-center gap-2 text-xs">
                  <input id="mockToggle" type="checkbox" class="accent-[var(--lavender)]" />
                  <span>Enable Mock Server</span>
                </div>
                <input
                  id="mockRouteInput"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  placeholder="/users/:id"
                />
                <textarea
                  id="mockResponseInput"
                  class="flex-1 bg-[#0f0f1b] border border-[#313244] rounded-lg p-3 text-xs font-mono"
                  placeholder="{ &quot;id&quot;: 1 }"
                ></textarea>
                <input
                  id="mockLatencyInput"
                  type="number"
                  value="200"
                  class="px-3 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
                  placeholder="Latency (ms)"
                />
                <button id="addMockBtn" class="button-primary px-3 py-2 rounded-lg text-xs w-fit">
                  Add Mock
                </button>
              </div>
              <div class="glass rounded-2xl p-4 flex flex-col gap-3">
                <div class="text-[10px] uppercase tracking-widest text-[var(--muted)]">
                  Mock Endpoints
                </div>
                <div id="mockList" class="flex-1 overflow-auto space-y-2 text-xs"></div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>

    <div
      id="commandPalette"
      class="fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur modal-enter"
    >
      <div class="glass rounded-2xl p-4 w-[600px]">
        <input
          id="commandSearch"
          class="w-full px-3 py-2 rounded-lg bg-[#0f0f1b] border border-[#313244] text-xs"
          placeholder="Type a command"
        />
        <div id="commandList" class="mt-3 max-h-64 overflow-auto text-xs"></div>
      </div>
    </div>

    <div
      id="breakpointModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 backdrop-blur modal-enter"
    >
      <div
        id="breakpointPanel"
        class="glass rounded-2xl p-6 w-[800px] max-h-[90vh] overflow-auto border border-[var(--yellow)] pulse"
      >
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Breakpoint Intercept</div>
          <button id="closeBreakpointBtn" class="text-xs px-2 py-1 rounded bg-[#313244]">
            Close
          </button>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="text-[10px] text-[var(--muted)]">Method</label>
            <select
              id="breakpointMethod"
              class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>DELETE</option>
              <option>PATCH</option>
            </select>
            <label class="text-[10px] text-[var(--muted)]">URL</label>
            <input
              id="breakpointUrl"
              class="w-full px-2 py-2 rounded bg-[#0f0f1b] border border-[#313244] text-xs"
            />
            <label class="text-[10px] text-[var(--muted)]">Headers</label>
            <div class="line-editor h-32" data-lang="json">
              <div class="line-numbers"></div>
              <div class="editor-stack">
                <pre class="editor-highlight"></pre>
                <textarea id="breakpointHeaders" class="editor-input"></textarea>
              </div>
            </div>
          </div>
          <div class="space-y-2">
            <label class="text-[10px] text-[var(--muted)]">Body</label>
            <div class="line-editor h-48" data-lang="json">
              <div class="line-numbers"></div>
              <div class="editor-stack">
                <pre class="editor-highlight"></pre>
                <textarea id="breakpointBody" class="editor-input"></textarea>
              </div>
            </div>
            <label class="text-[10px] text-[var(--muted)]">Response Override</label>
            <textarea
              id="breakpointResponse"
              class="w-full h-24 bg-[#0f0f1b] border border-[#313244] rounded-lg p-2 text-xs font-mono"
            ></textarea>
          </div>
        </div>
        <div class="mt-4 flex justify-end gap-2">
          <button id="resumeBreakpointBtn" class="button-primary px-3 py-2 rounded-lg text-xs">
            Resume
          </button>
          <button id="abortBreakpointBtn" class="px-3 py-2 rounded-lg text-xs bg-[#40303a]">
            Abort
          </button>
          <button id="dropBreakpointBtn" class="px-3 py-2 rounded-lg text-xs bg-[#40282f]">
            Drop
          </button>
        </div>
      </div>
    </div>

    <div
      id="envModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 backdrop-blur modal-enter"
    >
      <div class="glass rounded-2xl p-4 w-[720px] max-h-[90vh] overflow-auto">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Environment Variables</div>
          <button id="closeEnvModalBtn" class="text-xs px-2 py-1 rounded bg-[#313244]">
            Close
          </button>
        </div>
        <div class="grid grid-cols-3 gap-4 mt-4 text-xs">
          <div class="glass p-3 rounded-lg">
            <div class="text-[10px] text-[var(--muted)]">Globals</div>
            <div id="globalsTable" class="space-y-2"></div>
            <button id="addGlobalVarRow" class="mt-2 text-[10px] px-2 py-1 rounded bg-[#313244]">
              + Add
            </button>
          </div>
          <div class="glass p-3 rounded-lg">
            <div class="text-[10px] text-[var(--muted)]">Environment</div>
            <div id="envTable" class="space-y-2"></div>
            <button id="addEnvVarRow" class="mt-2 text-[10px] px-2 py-1 rounded bg-[#313244]">
              + Add
            </button>
          </div>
          <div class="glass p-3 rounded-lg">
            <div class="text-[10px] text-[var(--muted)]">Session</div>
            <div id="sessionTable" class="space-y-2"></div>
            <button id="addSessionVarRow" class="mt-2 text-[10px] px-2 py-1 rounded bg-[#313244]">
              + Add
            </button>
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button id="saveEnvBtn" class="button-primary px-3 py-2 rounded-lg text-xs">
            Save Variables
          </button>
        </div>
      </div>
    </div>

    <div
      id="contextMenu"
      class="context-menu fixed hidden glass rounded-lg p-2 text-xs"
    ></div>

    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
      const state = {
        mode: "http",
        interceptor: {
          enabled: false,
          mode: "request",
          intercepted: 0,
          modified: 0,
          blocked: 0,
          pendingRequest: null,
          pendingResponse: null,
        },
        collections: [],
        history: [],
        envs: {
          current: "Development",
          globals: {},
          environments: {
            Development: {},
            Staging: {},
            Production: {},
          },
          session: {},
        },
        loadTest: {
          running: false,
          interval: null,
          progress: 0,
          results: [],
        },
        websocket: {
          socket: null,
          connected: false,
          sent: 0,
          received: 0,
          heartbeatTimer: null,
        },
        mockServer: {
          enabled: false,
          mocks: [],
        },
        response: {
          text: "",
          lines: [],
        },
        comments: [],
        audit: [],
      };

      const elements = {
        modeButtons: document.querySelectorAll(".mode-btn"),
        modePanels: document.querySelectorAll(".mode-panel"),
        sidebar: document.getElementById("sidebar"),
        mobileMenuBtn: document.getElementById("mobileMenuBtn"),
        toggleSidebarBtn: document.getElementById("toggleSidebarBtn"),
        methodSelect: document.getElementById("methodSelect"),
        urlInput: document.getElementById("urlInput"),
        sendRequestBtn: document.getElementById("sendRequestBtn"),
        clearUrlBtn: document.getElementById("clearUrlBtn"),
        saveRequestBtn: document.getElementById("saveRequestBtn"),
        responseVirtualContainer: document.getElementById("responseVirtualContainer"),
        responseVirtualContent: document.getElementById("responseVirtualContent"),
        statusPill: document.getElementById("statusPill"),
        timePill: document.getElementById("timePill"),
        sizePill: document.getElementById("sizePill"),
        copyResponseBtn: document.getElementById("copyResponseBtn"),
        clearResponseBtn: document.getElementById("clearResponseBtn"),
        headersEditor: document.getElementById("headersEditor"),
        bodyEditor: document.getElementById("bodyEditor"),
        preRequestEditor: document.getElementById("preRequestEditor"),
        testScriptEditor: document.getElementById("testScriptEditor"),
        preConsole: document.getElementById("preConsole"),
        testResults: document.getElementById("testResults"),
        responseTestResults: document.getElementById("responseTestResults"),
        paramsList: document.getElementById("paramsList"),
        paramsCount: document.getElementById("paramsCount"),
        headersCount: document.getElementById("headersCount"),
        addParamBtn: document.getElementById("addParamBtn"),
        commandPalette: document.getElementById("commandPalette"),
        commandPaletteBtn: document.getElementById("commandPaletteBtn"),
        commandSearch: document.getElementById("commandSearch"),
        commandList: document.getElementById("commandList"),
        toastContainer: document.getElementById("toastContainer"),
        toggleInterceptorBtn: document.getElementById("toggleInterceptorBtn"),
        interceptorIndicator: document.getElementById("interceptorIndicator"),
        interceptorLog: document.getElementById("interceptorLog"),
        statIntercepted: document.getElementById("statIntercepted"),
        statModified: document.getElementById("statModified"),
        statBlocked: document.getElementById("statBlocked"),
        interceptorModeSelect: document.getElementById("interceptorModeSelect"),
        breakpointModal: document.getElementById("breakpointModal"),
        breakpointMethod: document.getElementById("breakpointMethod"),
        breakpointUrl: document.getElementById("breakpointUrl"),
        breakpointHeaders: document.getElementById("breakpointHeaders"),
        breakpointBody: document.getElementById("breakpointBody"),
        breakpointResponse: document.getElementById("breakpointResponse"),
        resumeBreakpointBtn: document.getElementById("resumeBreakpointBtn"),
        abortBreakpointBtn: document.getElementById("abortBreakpointBtn"),
        dropBreakpointBtn: document.getElementById("dropBreakpointBtn"),
        closeBreakpointBtn: document.getElementById("closeBreakpointBtn"),
        contextMenu: document.getElementById("contextMenu"),
        collectionTree: document.getElementById("collectionTree"),
        historyList: document.getElementById("historyList"),
        clearHistoryBtn: document.getElementById("clearHistoryBtn"),
        addFolderBtn: document.getElementById("addFolderBtn"),
        addRequestBtn: document.getElementById("addRequestBtn"),
        envSelector: document.getElementById("envSelector"),
        envIndicator: document.getElementById("envIndicator"),
        editEnvBtn: document.getElementById("editEnvBtn"),
        addGlobalVarBtn: document.getElementById("addGlobalVarBtn"),
        envModal: document.getElementById("envModal"),
        closeEnvModalBtn: document.getElementById("closeEnvModalBtn"),
        globalsTable: document.getElementById("globalsTable"),
        envTable: document.getElementById("envTable"),
        sessionTable: document.getElementById("sessionTable"),
        addGlobalVarRow: document.getElementById("addGlobalVarRow"),
        addEnvVarRow: document.getElementById("addEnvVarRow"),
        addSessionVarRow: document.getElementById("addSessionVarRow"),
        saveEnvBtn: document.getElementById("saveEnvBtn"),
        quickSearchInput: document.getElementById("quickSearchInput"),
        formatJsonBtn: document.getElementById("formatJsonBtn"),
        fileDropZone: document.getElementById("fileDropZone"),
        fileInput: document.getElementById("fileInput"),
        retryToggle: document.getElementById("retryToggle"),
        retryAttempts: document.getElementById("retryAttempts"),
        retryCodes: document.getElementById("retryCodes"),
        timeoutInput: document.getElementById("timeoutInput"),
        sizeLimitInput: document.getElementById("sizeLimitInput"),
        followRedirectsToggle: document.getElementById("followRedirectsToggle"),
        responseHeaders: document.getElementById("responseHeaders"),
        responseCookies: document.getElementById("responseCookies"),
        diffOutput: document.getElementById("diffOutput"),
        runDiffBtn: document.getElementById("runDiffBtn"),
        diffLeft: document.getElementById("diffLeft"),
        diffRight: document.getElementById("diffRight"),
        diffStandaloneLeft: document.getElementById("diffStandaloneLeft"),
        diffStandaloneRight: document.getElementById("diffStandaloneRight"),
        diffStandaloneOutput: document.getElementById("diffStandaloneOutput"),
        runStandaloneDiffBtn: document.getElementById("runStandaloneDiffBtn"),
        wsUrlInput: document.getElementById("wsUrlInput"),
        wsToggleBtn: document.getElementById("wsToggleBtn"),
        wsStatusDot: document.getElementById("wsStatusDot"),
        wsStatusText: document.getElementById("wsStatusText"),
        wsLog: document.getElementById("wsLog"),
        wsMessageEditor: document.getElementById("wsMessageEditor"),
        wsSendBtn: document.getElementById("wsSendBtn"),
        wsClearBtn: document.getElementById("wsClearBtn"),
        wsMetrics: document.getElementById("wsMetrics"),
        wsHeartbeat: document.getElementById("wsHeartbeat"),
        wsFormatSelect: document.getElementById("wsFormatSelect"),
        wsAutoReconnect: document.getElementById("wsAutoReconnect"),
        loadProfile: document.getElementById("loadProfile"),
        loadTotal: document.getElementById("loadTotal"),
        loadConcurrency: document.getElementById("loadConcurrency"),
        loadRamp: document.getElementById("loadRamp"),
        loadTimeout: document.getElementById("loadTimeout"),
        loadKeepAlive: document.getElementById("loadKeepAlive"),
        loadRandomize: document.getElementById("loadRandomize"),
        loadRedirects: document.getElementById("loadRedirects"),
        startLoadTestBtn: document.getElementById("startLoadTestBtn"),
        cancelLoadTestBtn: document.getElementById("cancelLoadTestBtn"),
        metricRps: document.getElementById("metricRps"),
        metricAvg: document.getElementById("metricAvg"),
        metricMinMax: document.getElementById("metricMinMax"),
        metricP95: document.getElementById("metricP95"),
        metricError: document.getElementById("metricError"),
        metricErrorCount: document.getElementById("metricErrorCount"),
        metricThroughput: document.getElementById("metricThroughput"),
        loadProgressText: document.getElementById("loadProgressText"),
        loadProgressBar: document.getElementById("loadProgressBar"),
        loadResultsTable: document.getElementById("loadResultsTable"),
        exportCsvBtn: document.getElementById("exportCsvBtn"),
        graphqlUrl: document.getElementById("graphqlUrl"),
        graphqlIntrospectBtn: document.getElementById("graphqlIntrospectBtn"),
        graphqlQueryEditor: document.getElementById("graphqlQueryEditor"),
        graphqlMutationEditor: document.getElementById("graphqlMutationEditor"),
        graphqlSubscriptionEditor: document.getElementById("graphqlSubscriptionEditor"),
        graphqlVariablesEditor: document.getElementById("graphqlVariablesEditor"),
        graphqlSendBtn: document.getElementById("graphqlSendBtn"),
        graphqlSchema: document.getElementById("graphqlSchema"),
        graphqlResponse: document.getElementById("graphqlResponse"),
        generateDocsBtn: document.getElementById("generateDocsBtn"),
        docsMarkdown: document.getElementById("docsMarkdown"),
        docsPreview: document.getElementById("docsPreview"),
        exportMarkdownBtn: document.getElementById("exportMarkdownBtn"),
        exportHtmlBtn: document.getElementById("exportHtmlBtn"),
        addChainNodeBtn: document.getElementById("addChainNodeBtn"),
        chainNodes: document.getElementById("chainNodes"),
        chainGraph: document.getElementById("chainGraph"),
        chainJsonPath: document.getElementById("chainJsonPath"),
        chainVarName: document.getElementById("chainVarName"),
        chainCondition: document.getElementById("chainCondition"),
        runChainBtn: document.getElementById("runChainBtn"),
        chainOutput: document.getElementById("chainOutput"),
        securityTarget: document.getElementById("securityTarget"),
        securityPayload: document.getElementById("securityPayload"),
        runSecurityScanBtn: document.getElementById("runSecurityScanBtn"),
        securityResults: document.getElementById("securityResults"),
        fakerType: document.getElementById("fakerType"),
        fakerCount: document.getElementById("fakerCount"),
        generateDataBtn: document.getElementById("generateDataBtn"),
        fakerOutput: document.getElementById("fakerOutput"),
        copyFakerBtn: document.getElementById("copyFakerBtn"),
        bulkCsvInput: document.getElementById("bulkCsvInput"),
        generateFromCsvBtn: document.getElementById("generateFromCsvBtn"),
        bulkPayloadOutput: document.getElementById("bulkPayloadOutput"),
        shareRequestBtn: document.getElementById("shareRequestBtn"),
        shareableLink: document.getElementById("shareableLink"),
        collabComments: document.getElementById("collabComments"),
        addCommentBtn: document.getElementById("addCommentBtn"),
        commentList: document.getElementById("commentList"),
        auditLog: document.getElementById("auditLog"),
        profilerUrl: document.getElementById("profilerUrl"),
        runProfilerBtn: document.getElementById("runProfilerBtn"),
        profDns: document.getElementById("profDns"),
        profTcp: document.getElementById("profTcp"),
        profTls: document.getElementById("profTls"),
        profTtfb: document.getElementById("profTtfb"),
        profDownload: document.getElementById("profDownload"),
        profTotal: document.getElementById("profTotal"),
        profWaterfall: document.getElementById("profWaterfall"),
        mockToggle: document.getElementById("mockToggle"),
        mockRouteInput: document.getElementById("mockRouteInput"),
        mockResponseInput: document.getElementById("mockResponseInput"),
        mockLatencyInput: document.getElementById("mockLatencyInput"),
        addMockBtn: document.getElementById("addMockBtn"),
        mockList: document.getElementById("mockList"),
        perfDns: document.getElementById("perfDns"),
        perfTcp: document.getElementById("perfTcp"),
        perfTls: document.getElementById("perfTls"),
        perfTtfb: document.getElementById("perfTtfb"),
        perfDownload: document.getElementById("perfDownload"),
        perfTotal: document.getElementById("perfTotal"),
        waterfallChart: document.getElementById("waterfallChart"),
        togglePreConsoleBtn: document.getElementById("togglePreConsoleBtn"),
      };

      const commands = [
        { name: "Send Request", action: () => sendRequest() },
        { name: "Toggle Sidebar", action: () => toggleSidebar() },
        { name: "Command Palette", action: () => openCommandPalette() },
        { name: "Toggle Interceptor", action: () => toggleInterceptor() },
        { name: "Start Load Test", action: () => startLoadTest() },
        { name: "Open WebSocket", action: () => switchMode("websocket") },
        { name: "Open GraphQL", action: () => switchMode("graphql") },
      ];

      let latencyChart;
      let rpsChart;

      const dmp = new diff_match_patch();

      function debounce(fn, wait = 250) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), wait);
        };
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 B";
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className =
          "toast glass rounded-lg px-3 py-2 text-xs flex items-center gap-2";
        const color =
          type === "error"
            ? "text-[var(--red)]"
            : type === "success"
            ? "text-[var(--green)]"
            : "text-[var(--lavender)]";
        toast.innerHTML = `<span class="${color}">${message}</span>`;
        elements.toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 3600);
      }

      function switchMode(mode) {
        state.mode = mode;
        elements.modeButtons.forEach((btn) => {
          btn.classList.toggle("border-[#313244]", btn.dataset.mode === mode);
          btn.classList.toggle("text-[var(--lavender)]", btn.dataset.mode === mode);
        });
        elements.modePanels.forEach((panel) => {
          panel.classList.toggle("hidden", panel.id !== `mode-${mode}`);
        });
      }

      function initTabs() {
        const tabButtons = document.querySelectorAll("[data-tab-group]");
        tabButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const group = button.dataset.tabGroup;
            const tab = button.dataset.tab;
            document
              .querySelectorAll(`[data-tab-group="${group}"]`)
              .forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            document
              .querySelectorAll(`[data-tab-content][data-tab-group="${group}"]`)
              .forEach((content) => {
                content.classList.toggle(
                  "hidden",
                  content.dataset.tabContent !== tab
                );
              });
          });
        });
        document
          .querySelectorAll("[data-tab-group='request'][data-tab='params']")
          .forEach((btn) => btn.classList.add("active"));
        document
          .querySelectorAll("[data-tab-group='response'][data-tab='body']")
          .forEach((btn) => btn.classList.add("active"));
        document
          .querySelectorAll("[data-tab-group='graphql'][data-tab='query']")
          .forEach((btn) => btn.classList.add("active"));
      }

      function initLineEditors() {
        document.querySelectorAll(".line-editor").forEach((editor) => {
          const textarea = editor.querySelector("textarea");
          const highlight = editor.querySelector(".editor-highlight");
          const numbers = editor.querySelector(".line-numbers");

          const update = () => {
            const value = textarea.value || "";
            const lines = value.split("\n").length;
            numbers.textContent = Array.from({ length: lines }, (_, i) => i + 1).join(
              "\n"
            );
            highlight.innerHTML = highlightSyntax(value, editor.dataset.lang);
          };

          textarea.addEventListener("input", update);
          textarea.addEventListener("scroll", () => {
            highlight.scrollTop = textarea.scrollTop;
            numbers.scrollTop = textarea.scrollTop;
          });
          update();
        });
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function highlightSyntax(text, lang) {
        const escaped = escapeHtml(text);
        if (lang === "json") {
          return escaped
            .replace(
              /"(.*?)":/g,
              '<span class="syntax-key">"$1"</span>:'
            )
            .replace(/"(.*?)"/g, '<span class="syntax-string">"$1"</span>')
            .replace(/\b(true|false|null)\b/g, '<span class="syntax-boolean">$1</span>')
            .replace(/\b(\d+)\b/g, '<span class="syntax-number">$1</span>');
        }
        if (lang === "xml" || lang === "html") {
          return escaped.replace(
            /(&lt;\/?)([\w-]+)/g,
            '$1<span class="syntax-key">$2</span>'
          );
        }
        if (lang === "sql") {
          return escaped.replace(
            /\b(SELECT|FROM|WHERE|INSERT|UPDATE|DELETE|JOIN|ON|AND|OR|LIMIT)\b/gi,
            '<span class="syntax-key">$1</span>'
          );
        }
        return escaped;
      }

      function updateMethodColor() {
        const method = elements.methodSelect.value;
        const colorMap = {
          GET: "var(--green)",
          POST: "var(--blue)",
          PUT: "var(--yellow)",
          DELETE: "var(--red)",
          PATCH: "var(--mauve)",
        };
        elements.methodSelect.style.borderColor = colorMap[method] || "#313244";
      }

      function updateCounts() {
        const paramsCount = elements.paramsList.children.length;
        elements.paramsCount.textContent = paramsCount;
        try {
          const headers = JSON.parse(elements.headersEditor.value || "{}");
          elements.headersCount.textContent = Object.keys(headers).length;
        } catch (err) {
          elements.headersCount.textContent = "!";
        }
      }

      function addParamRow(key = "", value = "") {
        const row = document.createElement("div");
        row.className = "flex gap-2 items-center";
        row.innerHTML = `
          <input class="flex-1 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-xs" placeholder="key" value="${key}" />
          <input class="flex-1 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-xs" placeholder="value" value="${value}" />
          <button class="px-2 py-1 rounded bg-[#313244] text-[10px]">Remove</button>
        `;
        row.querySelector("button").addEventListener("click", () => {
          row.remove();
          updateCounts();
        });
        elements.paramsList.appendChild(row);
        updateCounts();
      }

      function openCommandPalette() {
        elements.commandPalette.classList.remove("hidden");
        elements.commandPalette.classList.add("flex");
        elements.commandSearch.focus();
        renderCommandList(commands);
      }

      function closeCommandPalette() {
        elements.commandPalette.classList.add("hidden");
        elements.commandPalette.classList.remove("flex");
      }

      function renderCommandList(list) {
        elements.commandList.innerHTML = "";
        list.forEach((cmd) => {
          const item = document.createElement("button");
          item.className =
            "w-full text-left px-3 py-2 rounded-lg glass-hover border border-transparent";
          item.textContent = cmd.name;
          item.addEventListener("click", () => {
            cmd.action();
            closeCommandPalette();
          });
          elements.commandList.appendChild(item);
        });
      }

      function toggleSidebar() {
        elements.sidebar.classList.toggle("sidebar-collapsed");
      }

      function toggleInterceptor() {
        state.interceptor.enabled = !state.interceptor.enabled;
        elements.interceptorIndicator.classList.toggle(
          "hidden",
          !state.interceptor.enabled
        );
        showToast(
          `Interceptor ${state.interceptor.enabled ? "enabled" : "disabled"}`,
          state.interceptor.enabled ? "success" : "info"
        );
      }

      function openBreakpointModal(data) {
        elements.breakpointModal.classList.remove("hidden");
        elements.breakpointModal.classList.add("flex");
        elements.breakpointMethod.value = data.method || "GET";
        elements.breakpointUrl.value = data.url || "";
        elements.breakpointHeaders.value = JSON.stringify(data.headers || {}, null, 2);
        elements.breakpointBody.value = data.body || "";
        elements.breakpointResponse.value = data.responseOverride || "";
        initLineEditors();
      }

      function closeBreakpointModal() {
        elements.breakpointModal.classList.add("hidden");
        elements.breakpointModal.classList.remove("flex");
      }

      function recordInterceptorLog(entry) {
        state.interceptor.intercepted += 1;
        elements.statIntercepted.textContent = state.interceptor.intercepted;
        if (entry.status === "modified") {
          state.interceptor.modified += 1;
          elements.statModified.textContent = state.interceptor.modified;
        }
        if (entry.status === "blocked") {
          state.interceptor.blocked += 1;
          elements.statBlocked.textContent = state.interceptor.blocked;
        }
        const item = document.createElement("div");
        item.className = "glass p-2 rounded-lg flex items-center justify-between";
        const statusDot =
          entry.status === "blocked"
            ? "bg-[var(--red)]"
            : "bg-[var(--green)]";
        item.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="method-badge method-${entry.method.toLowerCase()}">${
          entry.method
        }</span>
            <span class="truncate max-w-[120px]">${entry.url}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="h-2 w-2 rounded-full ${statusDot}"></span>
            <button class="text-[10px] text-[var(--lavender)]">Edit</button>
            <button class="text-[10px] text-[var(--red)]">Drop</button>
          </div>
        `;
        const [editBtn, dropBtn] = item.querySelectorAll("button");
        editBtn.addEventListener("click", () => {
          openBreakpointModal({
            method: entry.method,
            url: entry.url,
            headers: entry.headers,
            body: entry.body,
          });
        });
        dropBtn.addEventListener("click", () => {
          state.interceptor.blocked += 1;
          elements.statBlocked.textContent = state.interceptor.blocked;
          showToast("Request dropped", "error");
        });
        elements.interceptorLog.prepend(item);
      }

      function updateEnvIndicator(env) {
        const colors = {
          Development: "bg-[var(--green)]",
          Staging: "bg-[var(--yellow)]",
          Production: "bg-[var(--red)]",
        };
        elements.envIndicator.className = `h-2 w-2 rounded-full ${colors[env]}`;
      }

      function persistEnv() {
        localStorage.setItem("nebula.envs", JSON.stringify(state.envs));
      }

      function loadEnv() {
        const stored = localStorage.getItem("nebula.envs");
        if (stored) {
          try {
            const parsed = JSON.parse(stored);
            state.envs = parsed;
            elements.envSelector.value = parsed.current || "Development";
            updateEnvIndicator(elements.envSelector.value);
          } catch (err) {
            showToast("Failed to load environment", "error");
          }
        }
      }

      function openEnvModal() {
        renderEnvTable(elements.globalsTable, state.envs.globals);
        renderEnvTable(
          elements.envTable,
          state.envs.environments[state.envs.current] || {}
        );
        renderEnvTable(elements.sessionTable, state.envs.session);
        elements.envModal.classList.remove("hidden");
        elements.envModal.classList.add("flex");
      }

      function closeEnvModal() {
        elements.envModal.classList.add("hidden");
        elements.envModal.classList.remove("flex");
      }

      function renderEnvTable(container, data) {
        container.innerHTML = "";
        Object.entries(data).forEach(([key, value]) => {
          const row = document.createElement("div");
          row.className = "flex gap-2";
          row.innerHTML = `
            <input class="flex-1 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-[10px]" value="${key}" placeholder="key" />
            <input class="flex-1 px-2 py-1 rounded bg-[#0f0f1b] border border-[#313244] text-[10px]" value="${value}" placeholder="value" />
            <button class="px-2 py-1 rounded bg-[#313244] text-[10px]">X</button>
          `;
          row.querySelector("button").addEventListener("click", () => row.remove());
          container.appendChild(row);
        });
      }

      function collectEnvTable(container) {
        const data = {};
        container.querySelectorAll("div").forEach((row) => {
          const inputs = row.querySelectorAll("input");
          const key = inputs[0].value.trim();
          const value = inputs[1].value;
          if (key) {
            data[key] = value;
          }
        });
        return data;
      }

      function applyVariables(value) {
        const env = state.envs.environments[state.envs.current] || {};
        return value.replace(/\{\{(.*?)\}\}/g, (_, key) => {
          const trimmed = key.trim();
          return (
            state.envs.session[trimmed] ??
            env[trimmed] ??
            state.envs.globals[trimmed] ??
            `{{${trimmed}}}`
          );
        });
      }

      function showVarAutocomplete(target) {
        const vars = [
          ...Object.keys(state.envs.globals),
          ...Object.keys(state.envs.environments[state.envs.current] || {}),
          ...Object.keys(state.envs.session),
        ];
        if (!vars.length) return;
        let menu = document.getElementById("varAutocomplete");
        if (!menu) {
          menu = document.createElement("div");
          menu.id = "varAutocomplete";
          menu.className =
            "fixed z-50 glass rounded-lg p-2 text-xs max-h-40 overflow-auto";
          document.body.appendChild(menu);
        }
        menu.innerHTML = vars
          .map((v) => `<button class="w-full text-left px-2 py-1">${v}</button>`)
          .join("");
        const rect = target.getBoundingClientRect();
        menu.style.top = `${rect.bottom + 4}px`;
        menu.style.left = `${rect.left}px`;
        menu.style.width = `${Math.min(rect.width, 220)}px`;
        menu.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const insert = `{{${btn.textContent}}}`;
            const start = target.selectionStart || 0;
            const end = target.selectionEnd || 0;
            target.value = `${target.value.slice(0, start)}${insert}${target.value.slice(
              end
            )}`;
            target.focus();
            menu.remove();
          });
        });
      }

      function hideVarAutocomplete() {
        const menu = document.getElementById("varAutocomplete");
        if (menu) menu.remove();
      }

      function captureHistory(entry) {
        state.history.unshift(entry);
        state.history = state.history.slice(0, 50);
        sessionStorage.setItem("nebula.history", JSON.stringify(state.history));
        renderHistory();
      }

      function loadHistory() {
        const stored = sessionStorage.getItem("nebula.history");
        if (stored) {
          try {
            state.history = JSON.parse(stored);
          } catch (err) {
            state.history = [];
          }
        }
      }

      function renderHistory() {
        elements.historyList.innerHTML = "";
        state.history.forEach((item) => {
          const row = document.createElement("div");
          row.className =
            "glass p-2 rounded-lg flex items-center justify-between gap-2";
          row.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="method-badge method-${item.method.toLowerCase()}">${
          item.method
        }</span>
              <span class="truncate max-w-[140px]">${item.url}</span>
            </div>
            <button class="text-[10px] text-[var(--lavender)]">Open</button>
          `;
          row.querySelector("button").addEventListener("click", () => {
            elements.methodSelect.value = item.method;
            elements.urlInput.value = item.url;
            elements.bodyEditor.value = item.body || "";
            elements.headersEditor.value = item.headers || "";
            initLineEditors();
            updateMethodColor();
          });
          elements.historyList.appendChild(row);
        });
      }

      function loadCollections() {
        const stored = localStorage.getItem("nebula.collections");
        if (stored) {
          try {
            state.collections = JSON.parse(stored);
          } catch (err) {
            state.collections = [];
          }
        }
        if (!state.collections.length) {
          state.collections = [
            {
              id: "root-1",
              name: "Nebula Starter",
              type: "folder",
              children: [
                {
                  id: "req-1",
                  name: "List Users",
                  method: "GET",
                  url: "https://api.example.com/users",
                },
              ],
            },
          ];
        }
      }

      function persistCollections() {
        localStorage.setItem("nebula.collections", JSON.stringify(state.collections));
      }

      function renderCollections() {
        elements.collectionTree.innerHTML = "";
        state.collections.forEach((node) => renderCollectionNode(node, elements.collectionTree, 0));
      }

      function renderCollectionNode(node, container, depth) {
        const item = document.createElement("div");
        item.className =
          "glass p-2 rounded-lg flex items-center justify-between gap-2 cursor-pointer";
        item.style.marginLeft = `${depth * 8}px`;
        item.dataset.id = node.id;
        if (node.type === "folder") {
          item.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-[10px]">â–¸</span>
              <span class="truncate">${node.name}</span>
            </div>
            <button class="text-[10px] text-[var(--lavender)]">+</button>
          `;
        } else {
          item.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="method-badge method-${node.method.toLowerCase()}">${node.method}</span>
              <span class="truncate">${node.name}</span>
            </div>
            <button class="text-[10px] text-[var(--lavender)]">Run</button>
          `;
        }

        item.addEventListener("contextmenu", (event) => {
          event.preventDefault();
          openContextMenu(event.clientX, event.clientY, node);
        });

        if (node.type === "folder") {
          const toggleBtn = item.querySelector("span");
          toggleBtn.addEventListener("click", () => {
            item.classList.toggle("active");
            item.nextSibling.classList.toggle("hidden");
          });
          item.querySelector("button").addEventListener("click", () => {
            node.children = node.children || [];
            node.children.push({
              id: `req-${Date.now()}`,
              name: "New Request",
              method: "GET",
              url: "",
            });
            persistCollections();
            renderCollections();
          });
        } else {
          item.querySelector("button").addEventListener("click", () => {
            elements.methodSelect.value = node.method;
            elements.urlInput.value = node.url;
            updateMethodColor();
          });
        }

        container.appendChild(item);

        if (node.type === "folder") {
          const childrenContainer = document.createElement("div");
          childrenContainer.className = "space-y-2 mt-2";
          container.appendChild(childrenContainer);
          (node.children || []).forEach((child) =>
            renderCollectionNode(child, childrenContainer, depth + 1)
          );
        }
      }

      function openContextMenu(x, y, node) {
        elements.contextMenu.innerHTML = `
          <button class="w-full text-left px-2 py-1 rounded hover:bg-[#313244]">Rename</button>
          <button class="w-full text-left px-2 py-1 rounded hover:bg-[#313244]">Duplicate</button>
          <button class="w-full text-left px-2 py-1 rounded hover:bg-[#313244]">Delete</button>
          <button class="w-full text-left px-2 py-1 rounded hover:bg-[#313244]">Export</button>
        `;
        elements.contextMenu.style.left = `${x}px`;
        elements.contextMenu.style.top = `${y}px`;
        elements.contextMenu.classList.remove("hidden");
        const [renameBtn, duplicateBtn, deleteBtn, exportBtn] =
          elements.contextMenu.querySelectorAll("button");
        renameBtn.addEventListener("click", () => {
          const name = prompt("Rename item", node.name);
          if (name) {
            node.name = name;
            persistCollections();
            renderCollections();
          }
          elements.contextMenu.classList.add("hidden");
        });
        duplicateBtn.addEventListener("click", () => {
          const copy = { ...node, id: `${node.id}-copy` };
          state.collections.push(copy);
          persistCollections();
          renderCollections();
          elements.contextMenu.classList.add("hidden");
        });
        deleteBtn.addEventListener("click", () => {
          state.collections = state.collections.filter((n) => n.id !== node.id);
          persistCollections();
          renderCollections();
          elements.contextMenu.classList.add("hidden");
        });
        exportBtn.addEventListener("click", () => {
          const data = JSON.stringify(node, null, 2);
          navigator.clipboard.writeText(data);
          showToast("Exported to clipboard", "success");
          elements.contextMenu.classList.add("hidden");
        });
      }

      function parseHeaders() {
        try {
          const parsed = JSON.parse(elements.headersEditor.value || "{}");
          return parsed;
        } catch (err) {
          showToast("Invalid headers JSON", "error");
          return {};
        }
      }

      function buildRequestOptions() {
        const headers = parseHeaders();
        const authType = document.getElementById("authTypeSelect").value;
        const authValue = document.getElementById("authValueInput").value.trim();
        if (authType === "bearer" && authValue) {
          headers.Authorization = `Bearer ${authValue}`;
        }
        if (authType === "basic" && authValue) {
          headers.Authorization = `Basic ${btoa(authValue)}`;
        }
        if (authType === "apikey" && authValue) {
          headers["x-api-key"] = authValue;
        }
        return headers;
      }

      function buildBody() {
        const file = elements.fileInput.files[0];
        if (file) {
          const formData = new FormData();
          formData.append("file", file);
          return formData;
        }
        return elements.bodyEditor.value;
      }

      function runScript(script, context, outputEl) {
        if (!script.trim()) return [];
        const results = [];
        const pm = createPm(context, results);
        try {
          const fn = new Function("pm", "console", script);
          const customConsole = {
            log: (...args) => {
              const line = args.map(String).join(" ");
              outputEl.innerHTML += `${escapeHtml(line)}<br/>`;
            },
          };
          fn(pm, customConsole);
        } catch (err) {
          results.push({ name: "Script Error", pass: false, message: err.message });
        }
        return results;
      }

      function createPm(context, results) {
        const expect = (value) => ({
          to: {
            equal: (expected) => {
              if (value !== expected) throw new Error(`${value} != ${expected}`);
            },
          },
        });
        const pm = {
          environment: {
            set: (key, value) => {
              state.envs.environments[state.envs.current][key] = value;
            },
            get: (key) => state.envs.environments[state.envs.current][key],
          },
          globals: {
            set: (key, value) => {
              state.envs.globals[key] = value;
            },
            get: (key) => state.envs.globals[key],
          },
          variables: {
            replaceIn: (value) => applyVariables(value),
          },
          response: {
            to: {
              have: {
                status: (code) => {
                  if (context.status !== code) throw new Error("Status mismatch");
                },
                jsonBody: (key) => {
                  if (!context.json || context.json[key] === undefined)
                    throw new Error("Missing JSON key");
                },
                header: (key) => {
                  if (!context.headers[key]) throw new Error("Missing header");
                },
              },
            },
          },
          test: (name, fn) => {
            try {
              fn();
              results.push({ name, pass: true });
            } catch (err) {
              results.push({ name, pass: false, message: err.message });
            }
          },
          expect,
        };
        return pm;
      }

      async function sendRequest() {
        const urlRaw = elements.urlInput.value.trim();
        if (!urlRaw) {
          showToast("URL is required", "error");
          elements.urlInput.classList.add("shake");
          setTimeout(() => elements.urlInput.classList.remove("shake"), 400);
          return;
        }

        const url = applyVariables(urlRaw);
        const method = elements.methodSelect.value;
        const headers = buildRequestOptions();
        const body = buildBody();
        const params = new URLSearchParams();
        elements.paramsList.querySelectorAll("div").forEach((row) => {
          const inputs = row.querySelectorAll("input");
          if (inputs[0].value) {
            params.append(inputs[0].value, applyVariables(inputs[1].value));
          }
        });

        const finalUrl = params.toString() ? `${url}?${params.toString()}` : url;

        elements.sendRequestBtn.disabled = true;
        elements.sendRequestBtn.innerHTML = `<span class="spinner"></span> Sending`;

        const preContext = { url: finalUrl, method, headers, body };
        elements.preConsole.innerHTML = "";
        runScript(elements.preRequestEditor.value || "", preContext, elements.preConsole);

        const requestPayload = {
          url: finalUrl,
          method,
          headers,
          body: body instanceof FormData ? "[FormData]" : body,
        };

        if (state.interceptor.enabled && ["request", "both"].includes(state.interceptor.mode)) {
          state.interceptor.pendingRequest = requestPayload;
          openBreakpointModal(requestPayload);
          return;
        }

        await performFetch(requestPayload);
      }

      async function performFetch(payload, responseOverride = null) {
        let url = payload.url;
        let method = payload.method;
        let headers = payload.headers;
        let body = payload.body;

        if (responseOverride) {
          updateResponseViewer(200, responseOverride, {}, 0);
          return;
        }

        if (state.mockServer.enabled) {
          const mock = findMock(url);
          if (mock) {
            await new Promise((resolve) => setTimeout(resolve, mock.latency));
            updateResponseViewer(200, mock.response, { "x-mock": "true" }, 0);
            showToast("Mock response served", "success");
            elements.sendRequestBtn.disabled = false;
            elements.sendRequestBtn.innerHTML = "Send";
            return;
          }
        }

        const timeout = Number(elements.timeoutInput.value) || 15000;
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeout);
        const retryEnabled = elements.retryToggle.checked;
        const maxAttempts = Number(elements.retryAttempts.value) || 1;
        const retryCodes = elements.retryCodes.value
          .split(",")
          .map((c) => Number(c.trim()))
          .filter(Boolean);

        let attempt = 0;
        let response;
        let responseText = "";
        let error = null;
        const startTime = performance.now();

        while (attempt < maxAttempts) {
          attempt += 1;
          try {
            response = await fetch(url, {
              method,
              headers,
              body: body instanceof FormData ? body : body || undefined,
              signal: controller.signal,
              redirect: elements.followRedirectsToggle.checked ? "follow" : "manual",
            });
            responseText = await response.text();
            if (!retryEnabled || !retryCodes.includes(response.status)) {
              break;
            }
          } catch (err) {
            error = err;
            if (!retryEnabled || attempt >= maxAttempts) {
              break;
            }
            const delay = Math.pow(2, attempt) * 200;
            await new Promise((resolve) => setTimeout(resolve, delay));
          }
        }
        clearTimeout(timer);

        if (error) {
          showToast("Request failed", "error");
          updateResponseViewer(0, error.message, {}, performance.now() - startTime);
          elements.sendRequestBtn.disabled = false;
          elements.sendRequestBtn.innerHTML = "Send";
          return;
        }

        const duration = performance.now() - startTime;
        const headerObj = {};
        response.headers.forEach((value, key) => {
          headerObj[key] = value;
        });

        captureHistory({
          url,
          method,
          headers: JSON.stringify(headers, null, 2),
          body: body instanceof FormData ? "" : body,
        });

        if (state.interceptor.enabled && ["response", "both"].includes(state.interceptor.mode)) {
          state.interceptor.pendingResponse = {
            status: response.status,
            body: responseText,
            headers: headerObj,
          };
          openBreakpointModal({
            method,
            url,
            headers,
            body,
            responseOverride: responseText,
          });
          return;
        }

        updateResponseViewer(response.status, responseText, headerObj, duration);
        elements.sendRequestBtn.disabled = false;
        elements.sendRequestBtn.innerHTML = "Send";
      }

      function updateResponseViewer(status, text, headers, duration) {
        elements.statusPill.textContent = status ? `${status}` : "--";
        elements.timePill.textContent = `${Math.round(duration)}ms`;
        const sizeBytes = new Blob([text]).size;
        elements.sizePill.textContent = formatBytes(sizeBytes);
        const sizeLimitMb = Number(elements.sizeLimitInput.value) || 10;
        if (sizeBytes > sizeLimitMb * 1024 * 1024) {
          showToast("Response exceeds size limit", "error");
        }
        updateStatusPill(status);
        elements.responseHeaders.innerHTML = Object.entries(headers)
          .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
          .join("");
        elements.responseCookies.innerHTML = headers["set-cookie"] || "No cookies";
        updateVirtualResponse(text);
        runPostResponseTests(status, text, headers);
        updatePerfMetrics(duration);
      }

      function updateStatusPill(status) {
        elements.statusPill.classList.remove("success", "warn", "error", "peach");
        if (!status) return;
        if (status >= 200 && status < 300) {
          elements.statusPill.classList.add("success");
        } else if (status >= 300 && status < 400) {
          elements.statusPill.classList.add("warn");
        } else if (status >= 400 && status < 500) {
          elements.statusPill.classList.add("peach");
        } else if (status >= 500) {
          elements.statusPill.classList.add("error", "pulse");
        }
      }

      function updateVirtualResponse(text) {
        state.response.text = text;
        state.response.lines = text.split("\n");
        renderVirtualLines();
      }

      function renderVirtualLines() {
        const container = elements.responseVirtualContainer;
        const content = elements.responseVirtualContent;
        const lineHeight = 18;
        const totalLines = state.response.lines.length;
        const viewportHeight = container.clientHeight;
        const scrollTop = container.scrollTop;
        const start = Math.max(0, Math.floor(scrollTop / lineHeight) - 10);
        const end = Math.min(totalLines, start + Math.ceil(viewportHeight / lineHeight) + 20);
        const offsetY = start * lineHeight;
        content.style.paddingTop = `${offsetY}px`;
        const visible = state.response.lines.slice(start, end).join("\n");
        content.innerHTML = `<pre class="response-viewer">${highlightSyntax(
          visible,
          detectSyntax(state.response.text)
        )}</pre>`;
        content.style.height = `${totalLines * lineHeight}px`;
      }

      function detectSyntax(text) {
        const trimmed = text.trim();
        if (trimmed.startsWith("{") || trimmed.startsWith("[")) return "json";
        if (trimmed.startsWith("<")) return "xml";
        if (/\bSELECT\b|\bFROM\b|\bWHERE\b/i.test(trimmed)) return "sql";
        return "text";
      }

      function updatePerfMetrics(total) {
        const dns = Math.max(1, total * 0.05);
        const tcp = Math.max(1, total * 0.15);
        const tls = Math.max(1, total * 0.1);
        const ttfb = Math.max(1, total * 0.2);
        const download = Math.max(1, total * 0.5);
        elements.perfDns.textContent = `${dns.toFixed(0)}ms`;
        elements.perfTcp.textContent = `${tcp.toFixed(0)}ms`;
        elements.perfTls.textContent = `${tls.toFixed(0)}ms`;
        elements.perfTtfb.textContent = `${ttfb.toFixed(0)}ms`;
        elements.perfDownload.textContent = `${download.toFixed(0)}ms`;
        elements.perfTotal.textContent = `${total.toFixed(0)}ms`;
        elements.waterfallChart.innerHTML = buildWaterfall([
          { label: "DNS", value: dns },
          { label: "TCP", value: tcp },
          { label: "TLS", value: tls },
          { label: "TTFB", value: ttfb },
          { label: "Download", value: download },
        ]);
      }

      function buildWaterfall(stages) {
        return stages
          .map(
            (stage) =>
              `<div class="flex items-center gap-2">
                <span class="w-16">${stage.label}</span>
                <div class="flex-1 h-2 bg-[#0f0f1b] rounded">
                  <div class="h-2 bg-[var(--lavender)] rounded" style="width:${Math.min(
                    100,
                    stage.value
                  )}%"></div>
                </div>
                <span>${stage.value.toFixed(0)}ms</span>
              </div>`
          )
          .join("");
      }

      function runPostResponseTests(status, text, headers) {
        const resultsEl = elements.testResults;
        const responseResultsEl = elements.responseTestResults;
        resultsEl.innerHTML = "";
        responseResultsEl.innerHTML = "";
        let json = null;
        try {
          json = JSON.parse(text);
        } catch (err) {
          json = null;
        }
        const context = { status, json, headers, text };
        const results = runScript(
          elements.testScriptEditor.value || "",
          context,
          responseResultsEl
        );
        results.forEach((result) => {
          const row = document.createElement("div");
          row.className = result.pass ? "text-[var(--green)]" : "text-[var(--red)]";
          row.textContent = result.pass
            ? `PASS: ${result.name}`
            : `FAIL: ${result.name} - ${result.message}`;
          resultsEl.appendChild(row.cloneNode(true));
          responseResultsEl.appendChild(row);
        });
      }

      function formatJsonEditor() {
        try {
          const formatted = JSON.stringify(
            JSON.parse(elements.bodyEditor.value || "{}"),
            null,
            2
          );
          elements.bodyEditor.value = formatted;
          initLineEditors();
          showToast("Formatted JSON", "success");
        } catch (err) {
          showToast("Invalid JSON", "error");
        }
      }

      function handleFileDrop(event) {
        event.preventDefault();
        elements.fileDropZone.classList.remove("border-[var(--lavender)]");
        if (event.dataTransfer.files.length) {
          elements.fileInput.files = event.dataTransfer.files;
          elements.fileDropZone.textContent = event.dataTransfer.files[0].name;
        }
      }

      function initLoadCharts() {
        const latencyCtx = document.getElementById("latencyChart");
        const rpsCtx = document.getElementById("rpsChart");
        latencyChart = new Chart(latencyCtx, {
          type: "bar",
          data: {
            labels: ["0-50", "50-100", "100-200", "200-500", "500+"],
            datasets: [
              {
                data: [0, 0, 0, 0, 0],
                backgroundColor: [
                  "#a6e3a1",
                  "#89b4fa",
                  "#f9e2af",
                  "#fab387",
                  "#f38ba8",
                ],
                borderRadius: 4,
              },
            ],
          },
          options: { plugins: { legend: { display: false } }, animation: true },
        });
        rpsChart = new Chart(rpsCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                fill: true,
                borderColor: "#b4befe",
                backgroundColor: "rgba(180,190,254,0.2)",
                tension: 0.4,
              },
            ],
          },
          options: { plugins: { legend: { display: false } }, animation: false },
        });
      }

      function startLoadTest() {
        if (state.loadTest.running) return;
        state.loadTest.running = true;
        state.loadTest.progress = 0;
        state.loadTest.results = [];
        elements.cancelLoadTestBtn.classList.remove("hidden");
        elements.startLoadTestBtn.disabled = true;
        elements.loadResultsTable.innerHTML = "";
        const total = Number(elements.loadTotal.value) || 1000;
        state.loadTest.interval = setInterval(() => {
          const rps = Math.floor(Math.random() * 1000);
          const avg = Math.floor(Math.random() * 200) + 50;
          const p95 = avg + Math.floor(Math.random() * 200);
          const errors = Math.floor(Math.random() * 5);
          state.loadTest.progress = Math.min(100, state.loadTest.progress + 5);
          elements.metricRps.textContent = rps;
          elements.metricAvg.textContent = `${avg}ms`;
          elements.metricMinMax.textContent = `${avg - 20}/${avg + 40}`;
          elements.metricP95.textContent = `${p95}ms`;
          elements.metricError.textContent = `${errors}%`;
          elements.metricErrorCount.textContent = `${errors} errors`;
          elements.metricThroughput.textContent = `${Math.floor(rps * 1.2)} KB/s`;
          elements.loadProgressText.textContent = `${state.loadTest.progress}%`;
          elements.loadProgressBar.style.width = `${state.loadTest.progress}%`;
          latencyChart.data.datasets[0].data = [
            Math.floor(Math.random() * 50),
            Math.floor(Math.random() * 40),
            Math.floor(Math.random() * 30),
            Math.floor(Math.random() * 20),
            Math.floor(Math.random() * 10),
          ];
          latencyChart.update();
          rpsChart.data.labels.push(Date.now().toString().slice(-4));
          rpsChart.data.datasets[0].data.push(rps);
          if (rpsChart.data.labels.length > 20) {
            rpsChart.data.labels.shift();
            rpsChart.data.datasets[0].data.shift();
          }
          rpsChart.update();
          state.loadTest.results.push({
            id: state.loadTest.results.length + 1,
            status: errors ? "500" : "200",
            time: avg,
            size: `${Math.floor(Math.random() * 10) + 1} KB`,
            timestamp: new Date().toLocaleTimeString(),
          });
          renderLoadResults();
          if (state.loadTest.progress >= 100) {
            stopLoadTest();
          }
        }, 500);
      }

      function stopLoadTest() {
        clearInterval(state.loadTest.interval);
        state.loadTest.running = false;
        elements.cancelLoadTestBtn.classList.add("hidden");
        elements.startLoadTestBtn.disabled = false;
      }

      function renderLoadResults() {
        elements.loadResultsTable.innerHTML = "";
        state.loadTest.results.slice(-50).forEach((result) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${result.id}</td>
            <td class="${result.status.startsWith("2") ? "text-[var(--green)]" : "text-[var(--red)]"}">${result.status}</td>
            <td>${result.time}ms</td>
            <td>${result.size}</td>
            <td>${result.timestamp}</td>
          `;
          elements.loadResultsTable.appendChild(row);
        });
      }

      function exportLoadCsv() {
        const header = "id,status,time,size,timestamp\n";
        const rows = state.loadTest.results
          .map((r) => `${r.id},${r.status},${r.time},${r.size},${r.timestamp}`)
          .join("\n");
        const blob = new Blob([header + rows], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "load-test-results.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function connectWebSocket() {
        if (state.websocket.socket) {
          state.websocket.socket.close();
        }
        const url = elements.wsUrlInput.value.trim();
        if (!url) {
          showToast("WebSocket URL required", "error");
          return;
        }
        elements.wsStatusText.textContent = "Connecting";
        elements.wsStatusDot.className = "h-2 w-2 rounded-full bg-[var(--yellow)] pulse";
        const ws = new WebSocket(url);
        state.websocket.socket = ws;
        ws.addEventListener("open", () => {
          state.websocket.connected = true;
          elements.wsStatusText.textContent = "Connected";
          elements.wsStatusDot.className = "h-2 w-2 rounded-full bg-[var(--green)]";
          showToast("WebSocket connected", "success");
        });
        ws.addEventListener("message", (event) => {
          state.websocket.received += 1;
          appendWsLog("in", event.data);
          updateWsMetrics();
        });
        ws.addEventListener("close", () => {
          state.websocket.connected = false;
          elements.wsStatusText.textContent = "Disconnected";
          elements.wsStatusDot.className = "h-2 w-2 rounded-full bg-[var(--red)]";
          if (elements.wsAutoReconnect.checked) {
            setTimeout(connectWebSocket, 1500);
          }
        });
      }

      function appendWsLog(direction, message) {
        const row = document.createElement("div");
        const time = new Date().toLocaleTimeString();
        const arrow = direction === "out" ? "->" : "<-";
        const color = direction === "out" ? "text-[var(--blue)]" : "text-[var(--green)]";
        row.innerHTML = `<span class="text-[var(--muted)]">[${time}]</span> <span class="${color}">${arrow}</span> ${escapeHtml(
          String(message)
        )}`;
        elements.wsLog.appendChild(row);
        elements.wsLog.scrollTop = elements.wsLog.scrollHeight;
      }

      function updateWsMetrics() {
        elements.wsMetrics.textContent = `Latency: -- | Sent: ${state.websocket.sent} | Received: ${state.websocket.received}`;
      }

      function sendWsMessage() {
        if (!state.websocket.socket || !state.websocket.connected) {
          showToast("WebSocket not connected", "error");
          return;
        }
        const payload = elements.wsMessageEditor.value;
        state.websocket.socket.send(payload);
        state.websocket.sent += 1;
        appendWsLog("out", payload);
        updateWsMetrics();
      }

      async function runGraphql() {
        const url = elements.graphqlUrl.value.trim();
        if (!url) {
          showToast("GraphQL URL required", "error");
          return;
        }
        const query =
          elements.graphqlQueryEditor.value ||
          elements.graphqlMutationEditor.value ||
          elements.graphqlSubscriptionEditor.value;
        let variables = {};
        try {
          variables = JSON.parse(elements.graphqlVariablesEditor.value || "{}");
        } catch (err) {
          showToast("Invalid variables JSON", "error");
          return;
        }
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, variables }),
          });
          const result = await response.json();
          elements.graphqlResponse.textContent = JSON.stringify(result, null, 2);
        } catch (err) {
          elements.graphqlResponse.textContent = err.message;
        }
      }

      async function runIntrospection() {
        const url = elements.graphqlUrl.value.trim();
        if (!url) {
          showToast("GraphQL URL required", "error");
          return;
        }
        const query = `query IntrospectionQuery {
          __schema {
            types { name kind fields { name } }
          }
        }`;
        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query }),
          });
          const result = await response.json();
          elements.graphqlSchema.textContent = JSON.stringify(result.data, null, 2);
        } catch (err) {
          elements.graphqlSchema.textContent = err.message;
        }
      }

      function generateDocs() {
        const markdown = state.history
          .map((item) => `### ${item.method} ${item.url}\n\n\`\`\`json\n${item.body || ""}\n\`\`\``)
          .join("\n\n");
        elements.docsMarkdown.value = markdown;
        elements.docsPreview.innerHTML = markdown
          .split("\n")
          .map((line) => (line.startsWith("###") ? `<h3>${line.slice(4)}</h3>` : `<p>${escapeHtml(line)}</p>`))
          .join("");
      }

      function exportMarkdown() {
        const blob = new Blob([elements.docsMarkdown.value], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "api-docs.md";
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportHtml() {
        const html = `<html><body>${elements.docsPreview.innerHTML}</body></html>`;
        const blob = new Blob([html], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "api-docs.html";
        a.click();
        URL.revokeObjectURL(url);
      }

      function runDiff(left, right, output) {
        const diffs = dmp.diff_main(left, right);
        dmp.diff_cleanupSemantic(diffs);
        output.innerHTML = dmp.diff_prettyHtml(diffs);
      }

      function addChainNode() {
        const node = {
          id: `node-${Date.now()}`,
          name: `Request ${state.collections.length + 1}`,
          method: "GET",
          url: "",
        };
        const item = document.createElement("div");
        item.className = "glass p-2 rounded-lg flex items-center justify-between";
        item.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="method-badge method-get">GET</span>
            <input class="flex-1 bg-transparent border-b border-[#313244] text-xs" value="${node.name}" />
          </div>
          <button class="text-[10px] text-[var(--lavender)]">Run</button>
        `;
        elements.chainNodes.appendChild(item);
        elements.chainGraph.innerHTML += `<div class="mb-2">Node: ${node.name}</div>`;
      }

      function runChain() {
        const path = elements.chainJsonPath.value.trim();
        const varName = elements.chainVarName.value.trim();
        const condition = elements.chainCondition.value.trim();
        let output = "Chain executed";
        if (path && varName) {
          output += ` | Extract ${path} -> ${varName}`;
        }
        if (condition) {
          output += ` | Condition: ${condition}`;
        }
        elements.chainOutput.textContent = output;
      }

      function runSecurityScan() {
        const target = elements.securityTarget.value.trim();
        const payload = elements.securityPayload.value;
        const findings = [];
        if (/select\s+.*from/i.test(payload)) {
          findings.push("Potential SQL injection pattern detected.");
        }
        if (/<script>/i.test(payload)) {
          findings.push("Potential XSS payload detected.");
        }
        if (target.split(".").length === 3) {
          findings.push("JWT detected. Decoding...");
          const parts = target.split(".");
          try {
            const header = JSON.parse(atob(parts[0]));
            const body = JSON.parse(atob(parts[1]));
            findings.push(`JWT Header: ${JSON.stringify(header)}`);
            findings.push(`JWT Body: ${JSON.stringify(body)}`);
          } catch (err) {
            findings.push("Invalid JWT encoding.");
          }
        }
        if (!findings.length) {
          findings.push("No critical issues detected.");
        }
        elements.securityResults.innerHTML = findings
          .map((item) => `<div class="mb-2">${escapeHtml(item)}</div>`)
          .join("");
      }

      function generateFakerData() {
        const count = Number(elements.fakerCount.value) || 1;
        const path = elements.fakerType.value;
        const data = [];
        for (let i = 0; i < count; i += 1) {
          data.push(path.split(".").reduce((acc, key) => acc[key], faker));
        }
        elements.fakerOutput.value = JSON.stringify(data, null, 2);
      }

      function generateFromCsv() {
        const csv = elements.bulkCsvInput.value.trim();
        if (!csv) return;
        const [headerLine, ...rows] = csv.split("\n");
        const headers = headerLine.split(",").map((h) => h.trim());
        const output = rows.map((row) => {
          const values = row.split(",");
          const obj = {};
          headers.forEach((h, idx) => {
            obj[h] = values[idx] || "";
          });
          return obj;
        });
        elements.bulkPayloadOutput.value = JSON.stringify(output, null, 2);
      }

      function generateShareLink() {
        const data = {
          method: elements.methodSelect.value,
          url: elements.urlInput.value,
          headers: elements.headersEditor.value,
          body: elements.bodyEditor.value,
        };
        const encoded = btoa(JSON.stringify(data));
        const link = `${location.origin}${location.pathname}#${encoded}`;
        elements.shareableLink.value = link;
        navigator.clipboard.writeText(link);
        showToast("Shareable link copied", "success");
        recordAudit(`Shared request link`);
      }

      function addComment() {
        const text = elements.collabComments.value.trim();
        if (!text) return;
        state.comments.push({ text, time: new Date().toLocaleTimeString() });
        elements.collabComments.value = "";
        renderComments();
      }

      function renderComments() {
        elements.commentList.innerHTML = state.comments
          .map((c) => `<div class="glass p-2 rounded-lg">${escapeHtml(c.text)} <span class="text-[10px] text-[var(--muted)]">${c.time}</span></div>`)
          .join("");
      }

      function recordAudit(message) {
        state.audit.unshift({ message, time: new Date().toLocaleTimeString() });
        elements.auditLog.innerHTML = state.audit
          .map((entry) => `<div class="mb-2">${entry.time} - ${escapeHtml(entry.message)}</div>`)
          .join("");
      }

      function runProfiler() {
        const total = Math.floor(Math.random() * 300) + 200;
        const dns = Math.floor(total * 0.05);
        const tcp = Math.floor(total * 0.15);
        const tls = Math.floor(total * 0.1);
        const ttfb = Math.floor(total * 0.25);
        const download = total - dns - tcp - tls - ttfb;
        elements.profDns.textContent = `${dns}ms`;
        elements.profTcp.textContent = `${tcp}ms`;
        elements.profTls.textContent = `${tls}ms`;
        elements.profTtfb.textContent = `${ttfb}ms`;
        elements.profDownload.textContent = `${download}ms`;
        elements.profTotal.textContent = `${total}ms`;
        elements.profWaterfall.innerHTML = buildWaterfall([
          { label: "DNS", value: dns },
          { label: "TCP", value: tcp },
          { label: "TLS", value: tls },
          { label: "TTFB", value: ttfb },
          { label: "Download", value: download },
        ]);
      }

      function addMock() {
        const route = elements.mockRouteInput.value.trim();
        const response = elements.mockResponseInput.value.trim();
        const latency = Number(elements.mockLatencyInput.value) || 0;
        if (!route || !response) {
          showToast("Route and response required", "error");
          return;
        }
        state.mockServer.mocks.push({ route, response, latency });
        persistMocks();
        renderMocks();
      }

      function persistMocks() {
        localStorage.setItem("nebula.mocks", JSON.stringify(state.mockServer));
      }

      function loadMocks() {
        const stored = localStorage.getItem("nebula.mocks");
        if (stored) {
          try {
            state.mockServer = JSON.parse(stored);
            elements.mockToggle.checked = state.mockServer.enabled;
          } catch (err) {
            state.mockServer = { enabled: false, mocks: [] };
          }
        }
      }

      function renderMocks() {
        elements.mockList.innerHTML = "";
        state.mockServer.mocks.forEach((mock, idx) => {
          const row = document.createElement("div");
          row.className = "glass p-2 rounded-lg flex items-center justify-between";
          row.innerHTML = `
            <div>
              <div class="text-xs">${mock.route}</div>
              <div class="text-[10px] text-[var(--muted)]">${mock.latency}ms</div>
            </div>
            <button class="text-[10px] text-[var(--red)]">Delete</button>
          `;
          row.querySelector("button").addEventListener("click", () => {
            state.mockServer.mocks.splice(idx, 1);
            persistMocks();
            renderMocks();
          });
          elements.mockList.appendChild(row);
        });
      }

      function findMock(url) {
        const path = new URL(url).pathname;
        return state.mockServer.mocks.find((mock) => {
          const pattern = mock.route.replace(/:\w+/g, "[^/]+");
          const regex = new RegExp(`^${pattern}$`);
          return regex.test(path);
        });
      }

      function applySharedLink() {
        if (location.hash.length > 1) {
          try {
            const decoded = JSON.parse(atob(location.hash.slice(1)));
            elements.methodSelect.value = decoded.method || "GET";
            elements.urlInput.value = decoded.url || "";
            elements.headersEditor.value = decoded.headers || "";
            elements.bodyEditor.value = decoded.body || "";
            initLineEditors();
            updateMethodColor();
            showToast("Loaded shared request", "success");
          } catch (err) {
            showToast("Invalid share link", "error");
          }
        }
      }

      function setupKeyboardShortcuts() {
        document.addEventListener("keydown", (event) => {
          const key = event.key.toLowerCase();
          if ((event.ctrlKey || event.metaKey) && key === "p") {
            event.preventDefault();
            openCommandPalette();
          }
          if ((event.ctrlKey || event.metaKey) && key === "b") {
            event.preventDefault();
            toggleSidebar();
          }
          if ((event.ctrlKey || event.metaKey) && key === "k") {
            event.preventDefault();
            elements.quickSearchInput.focus();
          }
          if ((event.ctrlKey || event.metaKey) && key === "enter") {
            event.preventDefault();
            if (state.mode === "http") sendRequest();
            if (state.mode === "websocket") sendWsMessage();
          }
          if ((event.ctrlKey || event.metaKey) && event.shiftKey && key === "c") {
            event.preventDefault();
            clearResponse();
          }
          if (event.key === "F10") {
            if (!elements.breakpointModal.classList.contains("hidden")) {
              elements.resumeBreakpointBtn.click();
            }
          }
          if ((event.ctrlKey || event.metaKey) && key === "s") {
            event.preventDefault();
            saveRequest();
          }
          if ((event.ctrlKey || event.metaKey) && key === "l") {
            event.preventDefault();
            elements.urlInput.focus();
          }
          if ((event.ctrlKey || event.metaKey) && event.shiftKey && key === "f") {
            event.preventDefault();
            formatJsonEditor();
          }
          if ((event.ctrlKey || event.metaKey) && key === "i") {
            event.preventDefault();
            toggleInterceptor();
          }
          if (state.mode === "loadtest" && event.key === " ") {
            event.preventDefault();
            if (state.loadTest.running) stopLoadTest();
            else startLoadTest();
          }
          if (state.mode === "loadtest" && event.key === "Escape") {
            stopLoadTest();
          }
        });
      }

      function clearResponse() {
        elements.statusPill.textContent = "--";
        elements.timePill.textContent = "--";
        elements.sizePill.textContent = "--";
        elements.responseHeaders.textContent = "";
        elements.responseCookies.textContent = "";
        elements.responseVirtualContent.innerHTML = "";
        state.response.text = "";
        state.response.lines = [];
      }

      function saveRequest() {
        const entry = {
          id: `req-${Date.now()}`,
          name: elements.urlInput.value || "Untitled",
          method: elements.methodSelect.value,
          url: elements.urlInput.value,
        };
        state.collections.push(entry);
        persistCollections();
        renderCollections();
        showToast("Request saved", "success");
      }

      function initApp() {
        switchMode("http");
        initTabs();
        initLineEditors();
        loadEnv();
        loadHistory();
        loadCollections();
        loadMocks();
        renderCollections();
        renderHistory();
        initLoadCharts();
        applySharedLink();
        updateMethodColor();
        addParamRow();
        setupKeyboardShortcuts();
      }

      elements.modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => switchMode(btn.dataset.mode));
      });
      elements.mobileMenuBtn.addEventListener("click", () => {
        elements.sidebar.classList.toggle("open");
      });
      elements.toggleSidebarBtn.addEventListener("click", toggleSidebar);
      elements.commandPaletteBtn.addEventListener("click", openCommandPalette);
      elements.commandPalette.addEventListener("click", (event) => {
        if (event.target === elements.commandPalette) closeCommandPalette();
      });
      elements.commandSearch.addEventListener(
        "input",
        debounce(() => {
          const query = elements.commandSearch.value.toLowerCase();
          const filtered = commands.filter((cmd) =>
            cmd.name.toLowerCase().includes(query)
          );
          renderCommandList(filtered);
        }, 150)
      );

      elements.methodSelect.addEventListener("change", updateMethodColor);
      elements.sendRequestBtn.addEventListener("click", sendRequest);
      elements.clearUrlBtn.addEventListener("click", () => {
        elements.urlInput.value = "";
      });
      elements.saveRequestBtn.addEventListener("click", saveRequest);
      elements.addParamBtn.addEventListener("click", () => addParamRow());
      elements.headersEditor.addEventListener("input", updateCounts);
      elements.bodyEditor.addEventListener("input", updateCounts);
      elements.formatJsonBtn.addEventListener("click", formatJsonEditor);
      elements.toggleInterceptorBtn.addEventListener("click", toggleInterceptor);
      elements.interceptorModeSelect.addEventListener("change", (event) => {
        state.interceptor.mode = event.target.value;
      });
      elements.resumeBreakpointBtn.addEventListener("click", async () => {
        const payload = {
          url: elements.breakpointUrl.value,
          method: elements.breakpointMethod.value,
          headers: JSON.parse(elements.breakpointHeaders.value || "{}"),
          body: elements.breakpointBody.value,
        };
        recordInterceptorLog({
          method: payload.method,
          url: payload.url,
          headers: payload.headers,
          body: payload.body,
          status: "modified",
        });
        closeBreakpointModal();
        if (state.interceptor.pendingResponse) {
          const override = elements.breakpointResponse.value || state.interceptor.pendingResponse.body;
          updateResponseViewer(
            state.interceptor.pendingResponse.status,
            override,
            state.interceptor.pendingResponse.headers,
            0
          );
          state.interceptor.pendingResponse = null;
          elements.sendRequestBtn.disabled = false;
          elements.sendRequestBtn.innerHTML = "Send";
          return;
        }
        await performFetch(payload);
      });
      elements.abortBreakpointBtn.addEventListener("click", () => {
        recordInterceptorLog({
          method: elements.breakpointMethod.value,
          url: elements.breakpointUrl.value,
          status: "blocked",
        });
        closeBreakpointModal();
        elements.sendRequestBtn.disabled = false;
        elements.sendRequestBtn.innerHTML = "Send";
      });
      elements.dropBreakpointBtn.addEventListener("click", () => {
        recordInterceptorLog({
          method: elements.breakpointMethod.value,
          url: elements.breakpointUrl.value,
          status: "blocked",
        });
        closeBreakpointModal();
        elements.sendRequestBtn.disabled = false;
        elements.sendRequestBtn.innerHTML = "Send";
      });
      elements.closeBreakpointBtn.addEventListener("click", closeBreakpointModal);
      elements.contextMenu.addEventListener("mouseleave", () =>
        elements.contextMenu.classList.add("hidden")
      );
      document.addEventListener("click", () => elements.contextMenu.classList.add("hidden"));
      elements.clearHistoryBtn.addEventListener("click", () => {
        state.history = [];
        sessionStorage.removeItem("nebula.history");
        renderHistory();
      });
      elements.addFolderBtn.addEventListener("click", () => {
        state.collections.push({
          id: `folder-${Date.now()}`,
          name: "New Folder",
          type: "folder",
          children: [],
        });
        persistCollections();
        renderCollections();
      });
      elements.addRequestBtn.addEventListener("click", () => {
        state.collections.push({
          id: `req-${Date.now()}`,
          name: "New Request",
          method: "GET",
          url: "",
        });
        persistCollections();
        renderCollections();
      });
      elements.envSelector.addEventListener("change", (event) => {
        state.envs.current = event.target.value;
        updateEnvIndicator(state.envs.current);
        persistEnv();
      });
      elements.editEnvBtn.addEventListener("click", openEnvModal);
      elements.addGlobalVarBtn.addEventListener("click", openEnvModal);
      elements.closeEnvModalBtn.addEventListener("click", closeEnvModal);
      elements.addGlobalVarRow.addEventListener("click", () =>
        elements.globalsTable.appendChild(document.createElement("div"))
      );
      elements.addEnvVarRow.addEventListener("click", () =>
        elements.envTable.appendChild(document.createElement("div"))
      );
      elements.addSessionVarRow.addEventListener("click", () =>
        elements.sessionTable.appendChild(document.createElement("div"))
      );
      elements.saveEnvBtn.addEventListener("click", () => {
        state.envs.globals = collectEnvTable(elements.globalsTable);
        state.envs.environments[state.envs.current] = collectEnvTable(elements.envTable);
        state.envs.session = collectEnvTable(elements.sessionTable);
        persistEnv();
        closeEnvModal();
        showToast("Variables saved", "success");
      });
      elements.quickSearchInput.addEventListener(
        "input",
        debounce(() => {
          const query = elements.quickSearchInput.value.toLowerCase();
          const matches = state.history.filter((item) =>
            item.url.toLowerCase().includes(query)
          );
          elements.historyList.innerHTML = "";
          matches.forEach((item) => {
            const row = document.createElement("div");
            row.className = "glass p-2 rounded-lg text-xs";
            row.textContent = `${item.method} ${item.url}`;
            elements.historyList.appendChild(row);
          });
        }, 200)
      );

      elements.fileDropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        elements.fileDropZone.classList.add("border-[var(--lavender)]");
      });
      elements.fileDropZone.addEventListener("dragleave", () => {
        elements.fileDropZone.classList.remove("border-[var(--lavender)]");
      });
      elements.fileDropZone.addEventListener("drop", handleFileDrop);

      elements.responseVirtualContainer.addEventListener("scroll", debounce(renderVirtualLines, 50));
      elements.copyResponseBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(state.response.text || "");
        elements.copyResponseBtn.classList.add("success-bounce");
        showToast("Response copied", "success");
        setTimeout(() => elements.copyResponseBtn.classList.remove("success-bounce"), 300);
      });
      elements.clearResponseBtn.addEventListener("click", clearResponse);

      elements.runDiffBtn.addEventListener("click", () =>
        runDiff(elements.diffLeft.value, elements.diffRight.value, elements.diffOutput)
      );
      elements.runStandaloneDiffBtn.addEventListener("click", () =>
        runDiff(
          elements.diffStandaloneLeft.value,
          elements.diffStandaloneRight.value,
          elements.diffStandaloneOutput
        )
      );

      elements.wsToggleBtn.addEventListener("click", () => {
        if (state.websocket.connected) {
          state.websocket.socket.close();
        } else {
          connectWebSocket();
        }
      });
      elements.wsSendBtn.addEventListener("click", sendWsMessage);
      elements.wsClearBtn.addEventListener("click", () => (elements.wsLog.innerHTML = ""));
      document.querySelectorAll("[data-template]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const template = btn.dataset.template;
          elements.wsMessageEditor.value =
            template === "ping" ? JSON.stringify({ type: "ping" }, null, 2) : "{\n  \"hello\": \"world\"\n}";
          initLineEditors();
        });
      });

      elements.startLoadTestBtn.addEventListener("click", startLoadTest);
      elements.cancelLoadTestBtn.addEventListener("click", stopLoadTest);
      elements.exportCsvBtn.addEventListener("click", exportLoadCsv);

      elements.graphqlSendBtn.addEventListener("click", runGraphql);
      elements.graphqlIntrospectBtn.addEventListener("click", runIntrospection);

      elements.generateDocsBtn.addEventListener("click", generateDocs);
      elements.exportMarkdownBtn.addEventListener("click", exportMarkdown);
      elements.exportHtmlBtn.addEventListener("click", exportHtml);

      elements.addChainNodeBtn.addEventListener("click", addChainNode);
      elements.runChainBtn.addEventListener("click", runChain);

      elements.runSecurityScanBtn.addEventListener("click", runSecurityScan);

      elements.generateDataBtn.addEventListener("click", generateFakerData);
      elements.copyFakerBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(elements.fakerOutput.value);
        showToast("Copied data", "success");
      });
      elements.generateFromCsvBtn.addEventListener("click", generateFromCsv);

      elements.shareRequestBtn.addEventListener("click", generateShareLink);
      elements.addCommentBtn.addEventListener("click", addComment);

      elements.runProfilerBtn.addEventListener("click", runProfiler);

      elements.mockToggle.addEventListener("change", (event) => {
        state.mockServer.enabled = event.target.checked;
        persistMocks();
      });
      elements.addMockBtn.addEventListener("click", addMock);

      elements.urlInput.addEventListener(
        "input",
        debounce(() => {
          if (elements.urlInput.value.includes("{{")) {
            showVarAutocomplete(elements.urlInput);
          } else {
            hideVarAutocomplete();
          }
        }, 200)
      );
      elements.bodyEditor.addEventListener(
        "input",
        debounce(() => {
          if (elements.bodyEditor.value.includes("{{")) {
            showVarAutocomplete(elements.bodyEditor);
          } else {
            hideVarAutocomplete();
          }
        }, 200)
      );

      elements.togglePreConsoleBtn.addEventListener("click", () => {
        elements.preConsole.classList.toggle("hidden");
      });

      initApp();
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebula API Client - Professional Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
          },
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@faker-js/faker@latest/dist/faker.umd.min.js"></script>
    <style>
      :root {
        --bg-crust: #11111b;
        --bg-base: #1e1e2e;
        --surface: rgba(24, 24, 37, 0.6);
        --glass-bg: rgba(30, 30, 46, 0.6);
        --border: rgba(180, 190, 254, 0.1);
        --border-hover: rgba(180, 190, 254, 0.2);
        --primary: #b4befe;
        --secondary: #cba6f7;
        --blue: #89b4fa;
        --green: #a6e3a1;
        --yellow: #f9e2af;
        --red: #f38ba8;
        --text: #cdd6f4;
        --muted: #6c7086;
        --peach: #fab387;
        --overlay: #313244;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(180deg, var(--bg-crust), var(--bg-base));
        color: var(--text);
      }

      ::selection {
        background: rgba(180, 190, 254, 0.35);
      }

      .glass {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        border: 1px solid var(--border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      .glass-hover:hover {
        border-color: var(--border-hover);
      }

      .panel {
        border-radius: 14px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      }

      .btn:active {
        transform: translateY(0) scale(0.98);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        box-shadow: 0 4px 20px rgba(180, 190, 254, 0.4);
        color: #11111b;
      }

      .btn-secondary {
        background: rgba(49, 50, 68, 0.6);
        border: 1px solid var(--border);
        color: var(--text);
      }

      .btn-outline {
        border: 1px solid var(--border);
        color: var(--text);
      }

      .btn-icon {
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(17, 17, 27, 0.4);
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-icon:hover {
        border-color: var(--border-hover);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
      }

      .input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(17, 17, 27, 0.4);
        padding: 8px 12px;
        font-size: 12px;
        color: var(--text);
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(180, 190, 254, 0.1);
      }

      .mono {
        font-family: "JetBrains Mono", monospace;
      }

      .method-select {
        width: 120px;
        border-radius: 12px;
        border: 2px solid var(--green);
        background: rgba(17, 17, 27, 0.4);
        font-weight: 700;
        font-size: 14px;
        padding: 6px 10px;
        color: var(--text);
      }

      .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid var(--overlay);
      }

      .tab-btn {
        padding: 10px 12px;
        font-size: 12px;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .tab-btn:hover {
        color: var(--text);
      }

      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: linear-gradient(0deg, rgba(180, 190, 254, 0.1), transparent);
      }

      .badge-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(49, 50, 68, 0.6);
        font-size: 10px;
        margin-left: 6px;
      }

      .editor {
        position: relative;
        display: grid;
        grid-template-columns: 40px 1fr;
        border: 1px solid var(--overlay);
        border-radius: 12px;
        overflow: hidden;
        height: 100%;
      }

      .line-numbers {
        padding: 12px 8px;
        font-size: 12px;
        color: var(--muted);
        text-align: right;
        border-right: 1px solid var(--overlay);
        background: rgba(17, 17, 27, 0.4);
        user-select: none;
        overflow: hidden;
      }

      .editor .highlight {
        position: absolute;
        left: 40px;
        right: 0;
        top: 0;
        bottom: 0;
        padding: 12px;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        color: transparent;
        pointer-events: none;
      }

      .editor textarea {
        grid-column: 2;
        padding: 12px;
        font-size: 12px;
        line-height: 1.6;
        background: transparent;
        color: var(--text);
        border: none;
        resize: none;
        outline: none;
        height: 100%;
        width: 100%;
      }

      .token-key {
        color: var(--primary);
      }

      .token-string {
        color: var(--green);
      }

      .token-number {
        color: var(--peach);
      }

      .token-boolean {
        color: var(--blue);
      }

      .token-tag {
        color: var(--secondary);
      }

      .token-keyword {
        color: var(--primary);
      }

      .status-pill {
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-2xx {
        color: var(--green);
        background: rgba(166, 227, 161, 0.15);
        box-shadow: 0 0 12px rgba(166, 227, 161, 0.3);
      }

      .status-3xx {
        color: var(--yellow);
        background: rgba(249, 226, 175, 0.15);
      }

      .status-4xx {
        color: var(--peach);
        background: rgba(250, 179, 135, 0.15);
        box-shadow: 0 0 12px rgba(250, 179, 135, 0.3);
      }

      .status-5xx {
        color: var(--red);
        background: rgba(243, 139, 168, 0.15);
        box-shadow: 0 0 12px rgba(243, 139, 168, 0.3);
        animation: pulse 2s infinite;
      }

      .method-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        font-weight: 700;
        color: #11111b;
      }

      .kbd {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: rgba(17, 17, 27, 0.5);
        color: var(--muted);
      }

      .kbd-sup {
        vertical-align: super;
      }

      .toast {
        background: rgba(24, 24, 37, 0.9);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 14px;
        margin-top: 10px;
        transform: translateY(20px);
        opacity: 0;
        transition: all 300ms ease;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .modal-backdrop {
        background: rgba(17, 17, 27, 0.65);
        backdrop-filter: blur(10px);
      }

      .modal {
        animation: slideUp 300ms ease;
      }

      .context-menu {
        position: fixed;
        width: 200px;
        border-radius: 12px;
        background: rgba(17, 17, 27, 0.95);
        border: 1px solid var(--border);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
        z-index: 50;
      }

      .context-menu button {
        width: 100%;
        padding: 8px 12px;
        text-align: left;
        font-size: 12px;
        color: var(--text);
      }

      .context-menu button:hover {
        background: rgba(49, 50, 68, 0.6);
      }

      .spinner {
        border: 2px solid rgba(180, 190, 254, 0.1);
        border-top-color: var(--primary);
        border-radius: 999px;
        width: 18px;
        height: 18px;
        animation: spin 0.8s linear infinite;
      }

      .progress-bar {
        position: relative;
        overflow: hidden;
        background: rgba(49, 50, 68, 0.6);
        border-radius: 999px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 200ms ease;
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        left: -30%;
        top: 0;
        bottom: 0;
        width: 30%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 2s infinite;
      }

      .skeleton {
        background: rgba(49, 50, 68, 0.6);
        border-radius: 8px;
        height: 12px;
        animation: pulse 2s infinite;
      }

      .badge-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
      }

      .pulse {
        animation: pulse 1.5s infinite;
      }

      .shake {
        animation: shake 0.35s ease;
      }

      .drop-zone {
        border: 1px dashed var(--border);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        font-size: 12px;
        color: var(--muted);
      }

      .drop-zone.dragover {
        border-color: var(--primary);
        color: var(--text);
      }

      .waterfall {
        display: grid;
        gap: 6px;
      }

      .waterfall-bar {
        height: 12px;
        border-radius: 999px;
        background: rgba(180, 190, 254, 0.15);
        position: relative;
        overflow: hidden;
      }

      .waterfall-bar span {
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
      }

      .tooltip {
        position: absolute;
        z-index: 40;
        background: rgba(17, 17, 27, 0.95);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: 10px;
        font-size: 11px;
      }

      .autocmp {
        position: absolute;
        z-index: 30;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(17, 17, 27, 0.95);
        padding: 6px;
        max-height: 160px;
        overflow-y: auto;
      }

      .autocmp button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
      }

      .autocmp button:hover {
        background: rgba(49, 50, 68, 0.6);
      }

      .mode-section {
        display: none;
        height: 100%;
      }

      .mode-section.active {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .mode-switcher button.active {
        border-color: var(--primary);
        color: var(--primary);
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes shimmer {
        to {
          transform: translateX(200%);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-6px);
        }
        50% {
          transform: translateX(6px);
        }
        75% {
          transform: translateX(-4px);
        }
      }

      @media (max-width: 768px) {
        #sidebar {
          position: absolute;
          left: 0;
          top: 56px;
          bottom: 0;
          z-index: 20;
          transform: translateX(-100%);
          transition: transform 300ms ease;
        }

        #sidebar.open {
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen text-[12px]">
    <div id="app" class="min-h-screen flex flex-col">
      <header class="h-14 glass panel mx-4 mt-4 px-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button id="sidebarToggle" class="btn-icon md:hidden">&#9776;</button>
          <div>
            <div class="text-[16px] font-semibold">Nebula API Client</div>
            <div class="text-[10px] text-[var(--muted)]">Professional Edition</div>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <span class="badge-dot bg-[var(--green)]"></span>
            <span id="envIndicator" class="text-[10px] text-[var(--muted)]">Development</span>
          </div>
        </div>
        <div class="mode-switcher flex items-center gap-2 overflow-x-auto max-w-[52vw]">
          <button class="btn btn-secondary active" data-mode="http">HTTP</button>
          <button class="btn btn-secondary" data-mode="load">Load</button>
          <button class="btn btn-secondary" data-mode="ws">WebSocket</button>
          <button class="btn btn-secondary" data-mode="graphql">GraphQL</button>
          <button class="btn btn-secondary" data-mode="docs">Docs</button>
          <button class="btn btn-secondary" data-mode="diff">Diff</button>
          <button class="btn btn-secondary" data-mode="chain">Chain</button>
          <button class="btn btn-secondary" data-mode="security">Security</button>
          <button class="btn btn-secondary" data-mode="data">Data</button>
          <button class="btn btn-secondary" data-mode="profiler">Profiler</button>
          <button class="btn btn-secondary" data-mode="mock">Mock</button>
          <button class="btn btn-secondary" data-mode="collab">Collab</button>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex items-center gap-1">
            <button id="interceptorToggle" class="btn btn-outline">
              <span>&#128274;</span>
              <span>Interceptor</span>
              <span
                id="interceptorIndicator"
                class="badge-dot bg-[var(--red)]"
                style="opacity: 0"
              ></span>
            </button>
            <select id="interceptorMode" class="input w-[140px] text-[10px]">
              <option value="request">Request Intercept</option>
              <option value="response">Response Intercept</option>
            </select>
          </div>
          <button id="commandBtn" class="btn btn-secondary">
            Command <span class="kbd">Cmd+P</span>
          </button>
          <button id="shortcutBtn" class="btn btn-secondary">
            Shortcuts
          </button>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden mt-4 px-4 pb-4 gap-4">
        <aside
          id="sidebar"
          class="glass panel w-80 flex flex-col gap-4 p-4 overflow-y-auto"
        >
          <div class="flex items-center gap-2">
            <input
              id="sidebarSearch"
              class="input"
              placeholder="Search collections, history..."
            />
            <button id="sidebarSearchClear" class="btn-icon">&#10005;</button>
          </div>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="text-[12px] font-semibold">Collections</div>
              <div class="flex gap-2">
                <button id="addFolderBtn" class="btn-icon">+</button>
                <button id="importBtn" class="btn-icon">&#8681;</button>
                <button id="exportBtn" class="btn-icon">&#8682;</button>
              </div>
            </div>
            <div id="collectionTree" class="flex flex-col gap-2"></div>
          </section>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="text-[12px] font-semibold">History</div>
              <button id="clearHistoryBtn" class="btn-icon">&#128465;</button>
            </div>
            <div id="historyList" class="flex flex-col gap-2 max-h-40 overflow-y-auto"></div>
          </section>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="text-[12px] font-semibold">Interceptor Log</div>
            <div id="interceptorStats" class="grid grid-cols-3 gap-2 text-[10px]">
              <div class="glass panel p-2">
                <div class="text-[var(--muted)]">Intercepted</div>
                <div id="statIntercepted" class="text-[14px] font-semibold">0</div>
              </div>
              <div class="glass panel p-2">
                <div class="text-[var(--muted)]">Modified</div>
                <div id="statModified" class="text-[14px] font-semibold">0</div>
              </div>
              <div class="glass panel p-2">
                <div class="text-[var(--muted)]">Blocked</div>
                <div id="statBlocked" class="text-[14px] font-semibold">0</div>
              </div>
            </div>
            <div id="interceptorLog" class="flex flex-col gap-2 max-h-40 overflow-y-auto"></div>
          </section>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <div class="text-[12px] font-semibold">Environments</div>
              <button id="editEnvBtn" class="btn-icon">&#9998;</button>
            </div>
            <select id="envSelect" class="input">
              <option value="Development">Development</option>
              <option value="Staging">Staging</option>
              <option value="Production">Production</option>
            </select>
            <div class="text-[10px] text-[var(--muted)]">
              Use {{variableName}} in URL, headers, or body.
            </div>
          </section>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="text-[12px] font-semibold">Quick Access</div>
            <div id="favoritesList" class="flex flex-col gap-2"></div>
          </section>

          <section class="glass panel p-3 flex flex-col gap-2">
            <div class="text-[12px] font-semibold">Keyboard Shortcuts</div>
            <div class="grid grid-cols-2 gap-2 text-[10px] text-[var(--muted)]">
              <div>Cmd+P</div>
              <div>Command Palette</div>
              <div>Cmd+Enter</div>
              <div>Send Request</div>
              <div>Cmd+Shift+C</div>
              <div>Clear Response</div>
              <div>Cmd+S</div>
              <div>Save to Collection</div>
              <div>Cmd+L</div>
              <div>Focus URL</div>
              <div>Cmd+Shift+F</div>
              <div>Format JSON</div>
              <div>Cmd+I</div>
              <div>Toggle Interceptor</div>
              <div>F10</div>
              <div>Resume Breakpoint</div>
              <div>Space</div>
              <div>Start/Pause Load Test</div>
              <div>Esc</div>
              <div>Cancel Load Test</div>
            </div>
          </section>
        </aside>

        <main class="flex-1 overflow-hidden">
          <div class="h-full flex flex-col">
            <section id="mode-http" class="mode-section active">
              <div class="glass panel p-4 flex flex-col gap-4 flex-[4]">
                <div class="flex items-center gap-2">
                  <select id="methodSelect" class="method-select">
                    <option value="GET" data-color="#a6e3a1">GET</option>
                    <option value="POST" data-color="#89b4fa">POST</option>
                    <option value="PUT" data-color="#f9e2af">PUT</option>
                    <option value="DELETE" data-color="#f38ba8">DELETE</option>
                    <option value="PATCH" data-color="#cba6f7">PATCH</option>
                  </select>
                  <div class="flex-1 relative">
                    <input
                      id="urlInput"
                      class="input mono"
                      placeholder="https://api.example.com/v1/resource"
                    />
                    <div class="absolute right-2 top-2 flex items-center gap-2">
                      <button id="clearUrlBtn" class="btn-icon">&#10005;</button>
                      <button id="saveRequestBtn" class="btn-icon">&#128190;</button>
                    </div>
                  </div>
                  <button id="sendBtn" class="btn btn-primary">
                    Send <span class="kbd kbd-sup">Cmd+Enter</span>
                  </button>
                </div>

                <div class="flex items-center gap-4 text-[10px] text-[var(--muted)]">
                  <label class="flex items-center gap-2">
                    <input id="keepAliveToggle" type="checkbox" checked />
                    Keep-alive
                  </label>
                  <label class="flex items-center gap-2">
                    <input id="followRedirectsToggle" type="checkbox" checked />
                    Follow redirects
                  </label>
                  <label class="flex items-center gap-2">
                    <input id="autoRetryToggle" type="checkbox" checked />
                    Auto-retry
                  </label>
                  <label class="flex items-center gap-2">
                    <input id="randomizePayloadToggle" type="checkbox" />
                    Randomize payload
                  </label>
                  <label class="flex items-center gap-2">
                    <input id="limitResponseToggle" type="checkbox" checked />
                    Warn &gt;10MB
                  </label>
                </div>

                <div class="tabs">
                  <button class="tab-btn active" data-tab="params">
                    Params <span id="paramsCount" class="badge-count">0</span>
                  </button>
                  <button class="tab-btn" data-tab="headers">
                    Headers <span id="headersCount" class="badge-count">0</span>
                  </button>
                  <button class="tab-btn" data-tab="body">
                    Body <span id="bodyCount" class="badge-count">0</span>
                  </button>
                  <button class="tab-btn" data-tab="auth">Auth</button>
                  <button class="tab-btn" data-tab="pre">
                    Pre-request
                  </button>
                  <button class="tab-btn" data-tab="tests">
                    Tests <span id="testsCount" class="badge-count">0</span>
                  </button>
                </div>

                <div class="flex-1 overflow-hidden">
                  <div class="tab-panel active h-full" id="tab-params">
                    <div class="editor h-full" data-editor="params" data-lang="json">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="paramsEditor" spellcheck="false">
{
  "page": 1,
  "limit": 20
}
                      </textarea>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-headers">
                    <div class="editor h-full" data-editor="headers" data-lang="json">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="headersEditor" spellcheck="false">
{
  "content-type": "application/json"
}
                      </textarea>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-body">
                    <div class="flex flex-col gap-3 h-full">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                          <button id="formatBodyBtn" class="btn btn-secondary">
                            Format JSON <span class="kbd">Cmd+Shift+F</span>
                          </button>
                          <select id="bodyTypeSelect" class="input w-[140px]">
                            <option value="json">JSON</option>
                            <option value="xml">XML</option>
                            <option value="html">HTML</option>
                            <option value="sql">SQL</option>
                            <option value="text">Text</option>
                          </select>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-[var(--muted)]">
                          <span>Drag files into drop zone</span>
                        </div>
                      </div>
                      <div class="drop-zone" id="fileDropZone">
                        Drop files here to upload (multipart)
                      </div>
                      <div class="editor flex-1" data-editor="body" data-lang="json">
                        <div class="line-numbers"></div>
                        <pre class="highlight"></pre>
                        <textarea id="bodyEditor" spellcheck="false">
{
  "name": "Nebula",
  "type": "request"
}
                        </textarea>
                      </div>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-auth">
                    <div class="grid gap-4">
                      <div class="flex items-center gap-3">
                        <label class="text-[10px] text-[var(--muted)]">Auth Type</label>
                        <select id="authTypeSelect" class="input w-[160px]">
                          <option value="none">None</option>
                          <option value="bearer">Bearer Token</option>
                          <option value="basic">Basic Auth</option>
                        </select>
                      </div>
                      <div class="grid gap-2">
                        <input id="authToken" class="input mono" placeholder="Token / Base64" />
                        <input id="authUser" class="input mono" placeholder="Username" />
                        <input id="authPass" class="input mono" placeholder="Password" />
                      </div>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-pre">
                    <div class="flex flex-col h-full gap-2">
                      <div class="editor flex-1" data-editor="pre" data-lang="javascript">
                        <div class="line-numbers"></div>
                        <pre class="highlight"></pre>
                        <textarea id="preEditor" spellcheck="false">
// Pre-request script
pm.environment.set("traceId", crypto.randomUUID());
pm.variables.replaceIn("{{traceId}}");
                        </textarea>
                      </div>
                      <div class="glass panel p-2 text-[10px]">
                        <div class="flex items-center justify-between">
                          <span>Console Output</span>
                          <button id="clearPreConsole" class="btn-icon">&#10005;</button>
                        </div>
                        <div id="preConsole" class="max-h-24 overflow-y-auto mt-2"></div>
                      </div>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-tests">
                    <div class="flex flex-col h-full gap-2">
                      <div class="editor flex-1" data-editor="tests" data-lang="javascript">
                        <div class="line-numbers"></div>
                        <pre class="highlight"></pre>
                        <textarea id="testsEditor" spellcheck="false">
pm.test("status is 200", () => {
  pm.response.to.have.status(200);
});
pm.test("has content type", () => {
  pm.response.to.have.header("content-type");
});
                        </textarea>
                      </div>
                      <div class="glass panel p-2 text-[10px]">
                        <div class="flex items-center justify-between">
                          <span>Test Results</span>
                          <button id="clearTestResults" class="btn-icon">&#10005;</button>
                        </div>
                        <div id="testResultsList" class="max-h-24 overflow-y-auto mt-2"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="glass panel p-4 flex flex-col gap-4 flex-[6]">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span id="statusPill" class="status-pill status-2xx">200 OK</span>
                    <span id="timePill" class="status-pill">45ms</span>
                    <span id="sizePill" class="status-pill">1.2 KB</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="copyResponseBtn" class="btn btn-secondary">
                      Copy
                    </button>
                    <button id="clearResponseBtn" class="btn btn-secondary">
                      Clear
                    </button>
                  </div>
                </div>

                <div class="tabs">
                  <button class="tab-btn active" data-tab="resp-body">Body</button>
                  <button class="tab-btn" data-tab="resp-headers">Headers</button>
                  <button class="tab-btn" data-tab="resp-cookies">Cookies</button>
                  <button class="tab-btn" data-tab="resp-timeline">Timeline</button>
                  <button class="tab-btn" data-tab="resp-tests">
                    Tests <span id="respTestsCount" class="badge-count">0</span>
                  </button>
                </div>

                <div class="flex-1 overflow-hidden">
                  <div class="tab-panel active h-full" id="tab-resp-body">
                    <div
                      id="responseViewer"
                      class="glass panel p-3 h-full overflow-auto mono text-[12px]"
                    >
                      <div id="responseSkeleton" class="space-y-2">
                        <div class="skeleton w-2/3"></div>
                        <div class="skeleton w-1/2"></div>
                        <div class="skeleton w-4/5"></div>
                      </div>
                      <pre id="responseContent" class="whitespace-pre-wrap"></pre>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-resp-headers">
                    <pre
                      id="responseHeaders"
                      class="glass panel p-3 h-full overflow-auto mono text-[12px]"
                    ></pre>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-resp-cookies">
                    <pre
                      id="responseCookies"
                      class="glass panel p-3 h-full overflow-auto mono text-[12px]"
                    ></pre>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-resp-timeline">
                    <div class="glass panel p-3 h-full overflow-auto">
                      <div id="timelineList" class="space-y-2"></div>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-resp-tests">
                    <div class="glass panel p-3 h-full overflow-auto">
                      <div id="respTestsList" class="space-y-2"></div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section id="mode-load" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-4 flex-[3]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Load Testing Suite</div>
                  <div class="flex gap-2">
                    <button id="loadStartBtn" class="btn btn-primary">Start</button>
                    <button id="loadCancelBtn" class="btn btn-secondary">Cancel</button>
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="grid gap-2">
                    <label class="text-[10px] text-[var(--muted)]">Profile</label>
                    <select id="loadProfile" class="input">
                      <option>Spike</option>
                      <option>Ramp-up</option>
                      <option>Soak</option>
                      <option>Stress</option>
                      <option>Custom</option>
                    </select>
                    <label class="text-[10px] text-[var(--muted)]">Total Requests</label>
                    <input id="loadTotal" class="input" value="500" />
                    <label class="text-[10px] text-[var(--muted)]">Concurrency</label>
                    <input id="loadConcurrency" class="input" value="25" />
                  </div>
                  <div class="grid gap-2">
                    <label class="text-[10px] text-[var(--muted)]">Ramp-up Time (s)</label>
                    <input id="loadRamp" class="input" value="15" />
                    <label class="text-[10px] text-[var(--muted)]">Timeout (ms)</label>
                    <input id="loadTimeout" class="input" value="5000" />
                    <label class="flex items-center gap-2 text-[10px] text-[var(--muted)]">
                      <input id="loadKeepAlive" type="checkbox" checked />
                      Keep-alive
                    </label>
                    <label class="flex items-center gap-2 text-[10px] text-[var(--muted)]">
                      <input id="loadRandomize" type="checkbox" />
                      Randomize payload
                    </label>
                    <label class="flex items-center gap-2 text-[10px] text-[var(--muted)]">
                      <input id="loadRedirects" type="checkbox" checked />
                      Follow redirects
                    </label>
                  </div>
                </div>
                <div class="progress-bar h-4">
                  <div id="loadProgress" class="progress-fill" style="width: 0%"></div>
                  <div
                    id="loadProgressText"
                    class="absolute inset-0 flex items-center justify-center text-[10px]"
                  >
                    0%
                  </div>
                </div>
              </div>

              <div class="glass panel p-4 flex flex-col gap-4 flex-[2]">
                <div class="grid md:grid-cols-5 gap-3">
                  <div class="glass panel p-3">
                    <div class="text-[10px] text-[var(--muted)]">RPS</div>
                    <div id="metricRps" class="text-[20px] text-[var(--primary)]">0</div>
                  </div>
                  <div class="glass panel p-3">
                    <div class="text-[10px] text-[var(--muted)]">Avg Latency</div>
                    <div id="metricAvg" class="text-[16px]">0 ms</div>
                    <div class="text-[10px] text-[var(--muted)]">
                      <span id="metricMin">0</span> / <span id="metricMax">0</span>
                    </div>
                  </div>
                  <div class="glass panel p-3">
                    <div class="text-[10px] text-[var(--muted)]">P95 Latency</div>
                    <div id="metricP95" class="text-[16px] text-[var(--peach)]">0 ms</div>
                  </div>
                  <div class="glass panel p-3">
                    <div class="text-[10px] text-[var(--muted)]">Error Rate</div>
                    <div id="metricError" class="text-[16px] text-[var(--red)]">0%</div>
                  </div>
                  <div class="glass panel p-3">
                    <div class="text-[10px] text-[var(--muted)]">Throughput</div>
                    <div id="metricThroughput" class="text-[16px]">0 KB/s</div>
                  </div>
                </div>
              </div>

              <div class="glass panel p-4 flex flex-col gap-4 flex-[3]">
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="glass panel p-3">
                    <div class="text-[12px] font-semibold mb-2">Latency Distribution</div>
                    <canvas id="latencyChart" height="160"></canvas>
                  </div>
                  <div class="glass panel p-3">
                    <div class="text-[12px] font-semibold mb-2">RPS Timeline</div>
                    <canvas id="rpsChart" height="160"></canvas>
                  </div>
                </div>
                <div class="glass panel p-3">
                  <div class="flex items-center justify-between mb-2">
                    <div class="text-[12px] font-semibold">Test Results</div>
                    <button id="exportCsvBtn" class="btn btn-secondary">Export CSV</button>
                  </div>
                  <div class="max-h-48 overflow-y-auto">
                    <table class="w-full text-[10px]">
                      <thead class="text-[var(--muted)]">
                        <tr>
                          <th class="text-left">#</th>
                          <th class="text-left">Status</th>
                          <th class="text-left">Time (ms)</th>
                          <th class="text-left">Size</th>
                          <th class="text-left">Timestamp</th>
                        </tr>
                      </thead>
                      <tbody id="loadResultsTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </section>

            <section id="mode-ws" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-4 flex-[2]">
                <div class="flex items-center gap-2">
                  <input
                    id="wsUrl"
                    class="input mono"
                    placeholder="wss://echo.websocket.org"
                  />
                  <button id="wsConnectBtn" class="btn btn-primary">Connect</button>
                  <button id="wsDisconnectBtn" class="btn btn-secondary">Disconnect</button>
                  <span id="wsStatusDot" class="badge-dot bg-[var(--muted)]"></span>
                  <span id="wsStatusText" class="text-[10px] text-[var(--muted)]">
                    Disconnected
                  </span>
                </div>
                <div class="grid md:grid-cols-3 gap-3 text-[10px]">
                  <div class="glass panel p-3">Latency: <span id="wsLatency">0</span> ms</div>
                  <div class="glass panel p-3">Sent: <span id="wsSent">0</span></div>
                  <div class="glass panel p-3">Received: <span id="wsReceived">0</span></div>
                </div>
              </div>

              <div class="glass panel p-4 flex flex-1 gap-4">
                <div class="flex-[7] flex flex-col gap-2">
                  <div class="flex items-center justify-between">
                    <div class="text-[12px] font-semibold">Message Log</div>
                    <div class="flex gap-2">
                      <button id="wsClearLog" class="btn btn-secondary">Clear</button>
                      <button id="wsPingBtn" class="btn btn-secondary">Ping</button>
                    </div>
                  </div>
                  <div
                    id="wsLog"
                    class="glass panel p-3 flex-1 overflow-y-auto mono text-[11px]"
                  ></div>
                </div>
                <div class="flex-[3] flex flex-col gap-2">
                  <div class="text-[12px] font-semibold">Composer</div>
                  <select id="wsFormat" class="input">
                    <option value="json">JSON</option>
                    <option value="text">Text</option>
                    <option value="binary">Binary</option>
                  </select>
                  <div class="editor flex-1" data-editor="ws" data-lang="json">
                    <div class="line-numbers"></div>
                    <pre class="highlight"></pre>
                    <textarea id="wsEditor" spellcheck="false">{ "type": "ping" }</textarea>
                  </div>
                  <div class="flex items-center justify-between">
                    <button id="wsSendBtn" class="btn btn-primary">Send</button>
                    <div class="text-[10px] text-[var(--muted)]">Ctrl+Enter</div>
                  </div>
                  <div class="glass panel p-2 text-[10px]">
                    Templates:
                    <div class="flex gap-2 mt-2">
                      <button class="btn btn-secondary ws-template" data-template='{"type":"ping"}'>
                        ping
                      </button>
                      <button class="btn btn-secondary ws-template" data-template='{"hello":"world"}'>
                        json
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section id="mode-graphql" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center gap-2">
                  <input
                    id="graphqlUrl"
                    class="input mono"
                    placeholder="https://api.example.com/graphql"
                  />
                  <button id="graphqlIntrospectBtn" class="btn btn-secondary">
                    Introspect
                  </button>
                  <button id="graphqlSendBtn" class="btn btn-primary">Send</button>
                </div>
                <div class="tabs">
                  <button class="tab-btn active" data-tab="gql-query">Query</button>
                  <button class="tab-btn" data-tab="gql-mutation">Mutation</button>
                  <button class="tab-btn" data-tab="gql-subscription">Subscription</button>
                  <button class="tab-btn" data-tab="gql-vars">Variables</button>
                </div>
                <div class="flex-1 overflow-hidden">
                  <div class="tab-panel active h-full" id="tab-gql-query">
                    <div class="editor h-full" data-editor="gql-query" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="gqlQueryEditor" spellcheck="false">
query ListUsers {
  users {
    id
    name
  }
}
                      </textarea>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-gql-mutation">
                    <div class="editor h-full" data-editor="gql-mutation" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="gqlMutationEditor" spellcheck="false">
mutation UpdateUser($id: ID!, $name: String!) {
  updateUser(id: $id, name: $name) {
    id
    name
  }
}
                      </textarea>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-gql-subscription">
                    <div class="editor h-full" data-editor="gql-subscription" data-lang="graphql">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="gqlSubscriptionEditor" spellcheck="false">
subscription OnUserAdded {
  userAdded {
    id
    name
  }
}
                      </textarea>
                    </div>
                  </div>
                  <div class="tab-panel h-full hidden" id="tab-gql-vars">
                    <div class="editor h-full" data-editor="gql-vars" data-lang="json">
                      <div class="line-numbers"></div>
                      <pre class="highlight"></pre>
                      <textarea id="gqlVarsEditor" spellcheck="false">
{
  "id": "1",
  "name": "Nebula"
}
                      </textarea>
                    </div>
                  </div>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[12px] font-semibold">Schema Explorer</div>
                  <div id="gqlSchemaStatus" class="text-[10px] text-[var(--muted)]">
                    Not loaded
                  </div>
                </div>
                <div id="gqlSchemaList" class="flex-1 overflow-y-auto text-[11px]"></div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Result</div>
                <pre id="gqlResult" class="glass panel p-3 flex-1 overflow-y-auto mono"></pre>
              </div>
            </section>

            <section id="mode-docs" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">API Documentation Generator</div>
                  <div class="flex gap-2">
                    <button id="docsGenerateBtn" class="btn btn-primary">Generate</button>
                    <button id="docsExportMdBtn" class="btn btn-secondary">Export MD</button>
                    <button id="docsExportHtmlBtn" class="btn btn-secondary">Export HTML</button>
                  </div>
                </div>
                <div class="editor flex-1" data-editor="docs" data-lang="markdown">
                  <div class="line-numbers"></div>
                  <pre class="highlight"></pre>
                  <textarea id="docsEditor" spellcheck="false"></textarea>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Preview</div>
                <iframe
                  id="docsPreview"
                  class="glass panel flex-1 w-full"
                  title="Docs Preview"
                ></iframe>
              </div>
            </section>

            <section id="mode-diff" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[14px] font-semibold">Diff Viewer</div>
                <div class="grid md:grid-cols-2 gap-4 flex-1">
                  <div class="editor h-full" data-editor="diff-left" data-lang="json">
                    <div class="line-numbers"></div>
                    <pre class="highlight"></pre>
                    <textarea id="diffLeft" spellcheck="false">{ "id": 1, "name": "Alpha" }</textarea>
                  </div>
                  <div class="editor h-full" data-editor="diff-right" data-lang="json">
                    <div class="line-numbers"></div>
                    <pre class="highlight"></pre>
                    <textarea id="diffRight" spellcheck="false">{ "id": 1, "name": "Beta", "active": true }</textarea>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="diffCompareBtn" class="btn btn-primary">Compare</button>
                  <button id="diffSaveBtn" class="btn btn-secondary">Save Snapshot</button>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Diff Output</div>
                <div id="diffOutput" class="glass panel p-3 flex-1 overflow-y-auto mono"></div>
              </div>
            </section>

            <section id="mode-chain" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Request Chaining</div>
                  <div class="flex gap-2">
                    <button id="chainAddBtn" class="btn btn-secondary">Add Step</button>
                    <button id="chainRunBtn" class="btn btn-primary">Run Chain</button>
                  </div>
                </div>
                <div id="chainSteps" class="flex flex-col gap-3"></div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Chain Log</div>
                <div id="chainLog" class="glass panel p-3 flex-1 overflow-y-auto mono text-[11px]"></div>
              </div>
            </section>

            <section id="mode-security" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Security Scanner</div>
                  <button id="scanBtn" class="btn btn-primary">Scan Response</button>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  <input id="jwtInput" class="input mono" placeholder="Paste JWT for analysis" />
                  <input id="scanPayload" class="input mono" placeholder="Custom payload" />
                </div>
                <div id="scanResults" class="glass panel p-3 flex-1 overflow-y-auto text-[11px]"></div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Vulnerability Checklist</div>
                <ul class="text-[10px] text-[var(--muted)] list-disc ml-4 space-y-1">
                  <li>SQL injection payloads</li>
                  <li>XSS detection</li>
                  <li>JWT decode and expiry</li>
                  <li>SSL certificate info (simulated)</li>
                  <li>Header security hints</li>
                </ul>
              </div>
            </section>

            <section id="mode-data" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Data Generator</div>
                  <button id="dataGenerateBtn" class="btn btn-primary">Generate</button>
                </div>
                <div class="editor flex-1" data-editor="data" data-lang="json">
                  <div class="line-numbers"></div>
                  <pre class="highlight"></pre>
                  <textarea id="dataTemplate" spellcheck="false">
{
  "id": "{{faker.string.uuid}}",
  "email": "{{faker.internet.email}}",
  "name": "{{faker.person.fullName}}",
  "city": "{{faker.location.city}}"
}
                  </textarea>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Generated Output</div>
                <pre id="dataOutput" class="glass panel p-3 flex-1 overflow-y-auto mono"></pre>
              </div>
            </section>

            <section id="mode-profiler" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[14px] font-semibold">Performance Profiler</div>
                <div class="grid md:grid-cols-3 gap-3">
                  <div class="glass panel p-3">DNS: <span id="profDns">0</span> ms</div>
                  <div class="glass panel p-3">TCP: <span id="profTcp">0</span> ms</div>
                  <div class="glass panel p-3">TLS: <span id="profTls">0</span> ms</div>
                  <div class="glass panel p-3">TTFB: <span id="profTtfb">0</span> ms</div>
                  <div class="glass panel p-3">Download: <span id="profDownload">0</span> ms</div>
                  <div class="glass panel p-3">Total: <span id="profTotal">0</span> ms</div>
                </div>
                <div class="text-[12px] font-semibold mt-2">Waterfall</div>
                <div id="waterfall" class="waterfall"></div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Profiler Notes</div>
                <div class="text-[10px] text-[var(--muted)]">
                  DNS, TCP, and TLS values are estimated in-browser. Use
                  production tracing for precise metrics.
                </div>
              </div>
            </section>

            <section id="mode-mock" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Mock Server</div>
                  <button id="mockAddBtn" class="btn btn-primary">Add Mock</button>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  <input id="mockRoute" class="input mono" placeholder="/users/:id" />
                  <input id="mockStatus" class="input" value="200" />
                  <input id="mockDelay" class="input" value="200" />
                  <input id="mockContentType" class="input" value="application/json" />
                </div>
                <div class="editor flex-1" data-editor="mock" data-lang="json">
                  <div class="line-numbers"></div>
                  <pre class="highlight"></pre>
                  <textarea id="mockBody" spellcheck="false">
{
  "id": "{{params.id}}",
  "name": "Mocked User"
}
                  </textarea>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Mocks</div>
                <div id="mockList" class="flex-1 overflow-y-auto"></div>
              </div>
            </section>

            <section id="mode-collab" class="mode-section">
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-semibold">Collaboration</div>
                  <button id="shareBtn" class="btn btn-primary">Share</button>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                  <input id="shareLink" class="input mono" readonly />
                  <input id="workspaceName" class="input" placeholder="Team Workspace" />
                </div>
                <div class="glass panel p-3">
                  <div class="text-[12px] font-semibold">Comments</div>
                  <div class="flex items-center gap-2 mt-2">
                    <input id="commentInput" class="input" placeholder="Add a comment" />
                    <button id="commentAddBtn" class="btn btn-secondary">Add</button>
                  </div>
                  <div id="commentList" class="mt-2 max-h-40 overflow-y-auto text-[11px]"></div>
                </div>
              </div>
              <div class="glass panel p-4 flex flex-col gap-3 flex-[2]">
                <div class="text-[12px] font-semibold">Audit Log</div>
                <div id="auditLog" class="flex-1 overflow-y-auto text-[11px]"></div>
              </div>
            </section>
          </div>
        </main>
      </div>

      <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>

      <div id="autocomplete" class="autocmp hidden"></div>

      <div
        id="modalBackdrop"
        class="modal-backdrop fixed inset-0 z-40 hidden items-center justify-center"
      >
        <div
          id="commandPalette"
          class="modal glass panel p-4 w-[600px] hidden flex flex-col gap-3"
        >
          <div class="text-[14px] font-semibold">Command Palette</div>
          <input id="commandSearch" class="input" placeholder="Type a command" />
          <div id="commandList" class="flex flex-col gap-2 text-[11px]"></div>
        </div>

        <div
          id="breakpointModal"
          class="modal glass panel p-4 w-[800px] hidden flex flex-col gap-3 border border-[var(--yellow)]"
        >
          <div class="flex items-center justify-between">
            <div class="text-[14px] font-semibold">Breakpoint Interceptor</div>
            <span class="text-[10px] text-[var(--muted)]">F10 to resume</span>
          </div>
          <div class="flex items-center gap-2">
            <select id="bpMethod" class="method-select">
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="DELETE">DELETE</option>
              <option value="PATCH">PATCH</option>
            </select>
            <input id="bpUrl" class="input mono flex-1" />
          </div>
          <div class="grid md:grid-cols-2 gap-3">
            <div class="editor h-40" data-editor="bp-headers" data-lang="json">
              <div class="line-numbers"></div>
              <pre class="highlight"></pre>
              <textarea id="bpHeaders" spellcheck="false">{}</textarea>
            </div>
            <div class="editor h-40" data-editor="bp-body" data-lang="json">
              <div class="line-numbers"></div>
              <pre class="highlight"></pre>
              <textarea id="bpBody" spellcheck="false"></textarea>
            </div>
          </div>
          <div class="flex items-center justify-end gap-2">
            <button id="bpAbortBtn" class="btn btn-secondary">Abort</button>
            <button id="bpDropBtn" class="btn btn-secondary">Drop</button>
            <button id="bpResumeBtn" class="btn btn-primary">Resume</button>
          </div>
        </div>

        <div
          id="envModal"
          class="modal glass panel p-4 w-[700px] hidden flex flex-col gap-3"
        >
          <div class="flex items-center justify-between">
            <div class="text-[14px] font-semibold">Environment Variables</div>
            <button id="envCloseBtn" class="btn-icon">&#10005;</button>
          </div>
          <div class="text-[10px] text-[var(--muted)]">
            Manage globals, environment-specific, and session variables.
          </div>
          <div class="grid md:grid-cols-3 gap-3">
            <div class="glass panel p-3">
              <div class="text-[12px] font-semibold">Globals</div>
              <div id="globalsTable" class="mt-2 space-y-2"></div>
              <button class="btn btn-secondary mt-2 add-var-btn" data-scope="globals">
                Add
              </button>
            </div>
            <div class="glass panel p-3">
              <div class="text-[12px] font-semibold">Environment</div>
              <div id="envTable" class="mt-2 space-y-2"></div>
              <button class="btn btn-secondary mt-2 add-var-btn" data-scope="env">
                Add
              </button>
            </div>
            <div class="glass panel p-3">
              <div class="text-[12px] font-semibold">Session</div>
              <div id="sessionTable" class="mt-2 space-y-2"></div>
              <button class="btn btn-secondary mt-2 add-var-btn" data-scope="session">
                Add
              </button>
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button id="envSaveBtn" class="btn btn-primary">Save</button>
          </div>
        </div>

        <div
          id="importModal"
          class="modal glass panel p-4 w-[700px] hidden flex flex-col gap-3"
        >
          <div class="flex items-center justify-between">
            <div class="text-[14px] font-semibold">Import</div>
            <button id="importCloseBtn" class="btn-icon">&#10005;</button>
          </div>
          <textarea
            id="importInput"
            class="input mono h-40"
            placeholder="Paste cURL command or Postman collection JSON"
          ></textarea>
          <div class="flex justify-end gap-2">
            <button id="importSubmitBtn" class="btn btn-primary">Import</button>
          </div>
        </div>
      </div>

      <div id="contextMenu" class="context-menu hidden"></div>
    </div>

    <script>
      const state = {
        mode: "http",
        sending: false,
        interceptor: {
          enabled: false,
          mode: "request",
          stats: { intercepted: 0, modified: 0, blocked: 0 },
          log: [],
          pending: null,
          pendingResponse: null,
        },
        env: {
          current: "Development",
          globals: {},
          environments: { Development: {}, Staging: {}, Production: {} },
          session: {},
        },
        collections: [],
        history: [],
        favorites: [],
        comments: [],
        audit: [],
        mocks: [],
        loadTest: {
          running: false,
          timer: null,
          progress: 0,
          results: [],
        },
        charts: {},
        ws: {
          socket: null,
          sent: 0,
          received: 0,
          latency: 0,
          lastPing: 0,
        },
        chain: { steps: [] },
        lastResponse: {
          status: 0,
          statusText: "",
          time: 0,
          size: 0,
          headers: {},
          body: "",
          cookies: "",
        },
      };

      const methodColors = {
        GET: "#a6e3a1",
        POST: "#89b4fa",
        PUT: "#f9e2af",
        DELETE: "#f38ba8",
        PATCH: "#cba6f7",
      };

      const qs = (sel, el = document) => el.querySelector(sel);
      const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));

      const toastContainer = qs("#toastContainer");
      const modalBackdrop = qs("#modalBackdrop");
      const autocomplete = qs("#autocomplete");

      const debounce = (fn, delay = 250) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      };

      const showToast = (message, tone = "info") => {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        if (tone === "error") {
          toast.style.borderColor = "rgba(243, 139, 168, 0.4)";
        }
        toastContainer.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("show"));
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      };

      const escapeHtml = (str) =>
        str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

      const highlightCode = (code, lang) => {
        if (!code) return "";
        let html = escapeHtml(code);
        if (lang === "json") {
          html = html
            .replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*")(?=\\s*:)/g, '<span class="token-key">$1</span>')
            .replace(/"(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"/g, '<span class="token-string">$&</span>')
            .replace(/\b(true|false|null)\b/g, '<span class="token-boolean">$1</span>')
            .replace(/-?\b\d+(\.\d+)?\b/g, '<span class="token-number">$&</span>');
        } else if (lang === "xml" || lang === "html") {
          html = html.replace(/(&lt;\/?[a-zA-Z0-9-]+)(.*?)(\/?&gt;)/g, '<span class="token-tag">$1</span>$2<span class="token-tag">$3</span>');
        } else if (lang === "sql") {
          html = html.replace(/\b(SELECT|FROM|WHERE|AND|OR|INSERT|UPDATE|DELETE|JOIN|INNER|LEFT|RIGHT|ON|GROUP|BY|ORDER|LIMIT)\b/gi, '<span class="token-keyword">$1</span>');
        } else if (lang === "graphql") {
          html = html.replace(/\b(query|mutation|subscription|fragment|on)\b/gi, '<span class="token-keyword">$1</span>');
        }
        return html;
      };

      const setupEditors = () => {
        qsa(".editor").forEach((editor) => {
          const textarea = qs("textarea", editor);
          const numbers = qs(".line-numbers", editor);
          const highlight = qs(".highlight", editor);
          const lang = editor.dataset.lang || "json";
          const render = () => {
            const lines = textarea.value.split("\n").length || 1;
            numbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join("<br>");
            highlight.innerHTML = highlightCode(textarea.value, lang);
          };
          const syncScroll = () => {
            numbers.scrollTop = textarea.scrollTop;
            highlight.scrollTop = textarea.scrollTop;
          };
          textarea.addEventListener("input", render);
          textarea.addEventListener("scroll", syncScroll);
          render();
        });
      };

      const setMode = (mode) => {
        state.mode = mode;
        qsa(".mode-switcher button").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.mode === mode);
        });
        qsa(".mode-section").forEach((section) => {
          section.classList.toggle("active", section.id === `mode-${mode}`);
        });
      };

      const updateMethodStyle = () => {
        const method = qs("#methodSelect").value;
        qs("#methodSelect").style.borderColor = methodColors[method];
      };

      const updateCounts = () => {
        const paramsVal = qs("#paramsEditor").value.trim();
        const headersVal = qs("#headersEditor").value.trim();
        const bodyVal = qs("#bodyEditor").value.trim();
        qs("#paramsCount").textContent = countJsonKeys(paramsVal);
        qs("#headersCount").textContent = countJsonKeys(headersVal);
        qs("#bodyCount").textContent = bodyVal ? 1 : 0;
      };

      const countJsonKeys = (value) => {
        try {
          const obj = JSON.parse(value || "{}");
          return obj && typeof obj === "object" ? Object.keys(obj).length : 0;
        } catch (err) {
          return 0;
        }
      };

      const replaceVariables = (text) => {
        if (!text) return text;
        return text.replace(/\{\{(\w+)\}\}/g, (_, key) => {
          const session = state.env.session[key];
          const env = state.env.environments[state.env.current][key];
          const global = state.env.globals[key];
          return session ?? env ?? global ?? "";
        });
      };

      const parseJsonSafe = (value, fallback = {}) => {
        try {
          return JSON.parse(value || "{}");
        } catch (err) {
          showToast("Invalid JSON detected", "error");
          return fallback;
        }
      };

      const buildRequestConfig = () => {
        const method = qs("#methodSelect").value;
        const url = qs("#urlInput").value.trim();
        const params = parseJsonSafe(qs("#paramsEditor").value, {});
        const headers = parseJsonSafe(qs("#headersEditor").value, {});
        let body = qs("#bodyEditor").value;
        const authType = qs("#authTypeSelect").value;
        const token = qs("#authToken").value.trim();
        const user = qs("#authUser").value.trim();
        const pass = qs("#authPass").value.trim();

        if (authType === "bearer" && token) {
          headers["authorization"] = `Bearer ${token}`;
        }
        if (authType === "basic" && user && pass) {
          headers["authorization"] = `Basic ${btoa(`${user}:${pass}`)}`;
        }

        const finalUrl = buildUrlWithParams(replaceVariables(url), params);
        body = replaceVariables(body);
        return { method, url: finalUrl, headers, body };
      };

      const buildUrlWithParams = (url, params) => {
        if (!url) return "";
        const query = new URLSearchParams(params).toString();
        if (!query) return url;
        return url.includes("?") ? `${url}&${query}` : `${url}?${query}`;
      };

      const runPreRequestScript = () => {
        const script = qs("#preEditor").value;
        const consoleEl = qs("#preConsole");
        consoleEl.innerHTML = "";
        const pm = createPmContext(consoleEl);
        try {
          new Function("pm", script)(pm);
        } catch (err) {
          showToast(`Pre-request error: ${err.message}`, "error");
        }
      };

      const runTestScript = () => {
        const script = qs("#testsEditor").value;
        const resultsEl = qs("#testResultsList");
        resultsEl.innerHTML = "";
        const pm = createPmContext(resultsEl, true);
        try {
          new Function("pm", script)(pm);
        } catch (err) {
          pushTestResult(resultsEl, false, `Script error: ${err.message}`);
        }
      };

      const createPmContext = (logEl, isTest = false) => {
        const log = (msg) => {
          const line = document.createElement("div");
          line.textContent = msg;
          logEl.appendChild(line);
        };
        const pm = {
          environment: {
            set: (k, v) => (state.env.environments[state.env.current][k] = v),
            get: (k) => state.env.environments[state.env.current][k],
          },
          globals: {
            set: (k, v) => (state.env.globals[k] = v),
            get: (k) => state.env.globals[k],
          },
          variables: {
            replaceIn: (value) => replaceVariables(value),
          },
          response: {
            to: {
              have: {
                status: (code) => {
                  if (state.lastResponse.status !== code) {
                    throw new Error(`Expected status ${code} but got ${state.lastResponse.status}`);
                  }
                },
                header: (key) => {
                  const lower = key.toLowerCase();
                  if (!state.lastResponse.headers[lower]) {
                    throw new Error(`Missing header ${key}`);
                  }
                },
                jsonBody: (key) => {
                  const json = parseJsonSafe(state.lastResponse.body, null);
                  if (!json || !(key in json)) {
                    throw new Error(`Missing JSON key ${key}`);
                  }
                },
              },
            },
          },
          test: (name, fn) => {
            try {
              fn();
              pushTestResult(logEl, true, name, isTest);
            } catch (err) {
              pushTestResult(logEl, false, `${name}: ${err.message}`, isTest);
            }
          },
          expect: (value) => ({
            to: {
              equal: (expected) => {
                if (value !== expected) throw new Error(`Expected ${expected} but got ${value}`);
              },
            },
          }),
          console: { log },
        };
        return pm;
      };

      const pushTestResult = (container, ok, message, showBadge = true) => {
        const line = document.createElement("div");
        line.className = "flex items-center gap-2";
        const icon = document.createElement("span");
        icon.textContent = ok ? "âœ”" : "âœ–";
        icon.style.color = ok ? "var(--green)" : "var(--red)";
        const text = document.createElement("span");
        text.textContent = message;
        line.appendChild(icon);
        line.appendChild(text);
        container.appendChild(line);
        if (showBadge) {
          const count = container.querySelectorAll("div").length;
          qs("#respTestsCount").textContent = count;
        }
      };

      const updateResponseUI = (response) => {
        qs("#responseSkeleton").style.display = "none";
        qs("#responseContent").textContent = "";
        qs("#responseHeaders").textContent = "";
        qs("#responseCookies").textContent = response.cookies || "";
        qs("#timelineList").innerHTML = "";
        state.lastResponse = response;

        const statusClass = response.status >= 500
          ? "status-5xx"
          : response.status >= 400
          ? "status-4xx"
          : response.status >= 300
          ? "status-3xx"
          : "status-2xx";
        const statusPill = qs("#statusPill");
        statusPill.className = `status-pill ${statusClass}`;
        statusPill.textContent = `${response.status} ${response.statusText}`;
        qs("#timePill").textContent = `${response.time}ms`;
        qs("#sizePill").textContent = formatSize(response.size);

        Object.entries(response.headers || {}).forEach(([key, value]) => {
          qs("#responseHeaders").textContent += `${key}: ${value}\n`;
        });

        const timeline = response.timeline || [];
        timeline.forEach((item) => {
          const row = document.createElement("div");
          row.className = "glass panel p-2 text-[10px]";
          row.textContent = `${item.label}: ${item.time}ms`;
          qs("#timelineList").appendChild(row);
        });

        renderResponseBody(response.body, response.headers["content-type"] || "");
        updateProfiler(response);
        runTestScript();
      };

      const renderResponseBody = (body, contentType) => {
        const viewer = qs("#responseContent");
        const container = qs("#responseViewer");
        viewer.innerHTML = "";
        const limitEnabled = qs("#limitResponseToggle").checked;
        const bytes = new Blob([body || ""]).size;
        if (limitEnabled && bytes > 10 * 1024 * 1024) {
          showToast("Response exceeds 10MB. Rendering truncated view.", "error");
        }
        const language = contentType.includes("json")
          ? "json"
          : contentType.includes("xml")
          ? "xml"
          : contentType.includes("html")
          ? "html"
          : contentType.includes("sql")
          ? "sql"
          : "text";
        const lines = (body || "").split("\n");
        if (lines.length > 1500) {
          const chunkSize = 200;
          let start = 0;
          const renderChunk = () => {
            const end = Math.min(lines.length, start + chunkSize);
            const slice = lines.slice(start, end).join("\n");
            viewer.innerHTML = highlightCode(slice, language);
            container.onscroll = () => {
              const progress = container.scrollTop / (container.scrollHeight - container.clientHeight);
              start = Math.floor(progress * Math.max(0, lines.length - chunkSize));
              viewer.innerHTML = highlightCode(lines.slice(start, start + chunkSize).join("\n"), language);
            };
          };
          renderChunk();
        } else {
          viewer.innerHTML = highlightCode(body || "", language) || "";
        }
      };

      const formatSize = (bytes) => {
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
      };

      const sendRequest = async () => {
        if (state.sending) return;
        const config = buildRequestConfig();
        if (!config.url) {
          showToast("Please enter a URL", "error");
          return;
        }
        runPreRequestScript();

        if (state.interceptor.enabled && state.interceptor.mode === "request") {
          state.interceptor.pending = config;
          openBreakpointModal(config);
          return;
        }
        await executeRequest(config);
      };

      const executeRequest = async (config) => {
        state.sending = true;
        qs("#sendBtn").disabled = true;
        qs("#sendBtn").innerHTML = `<span class="spinner"></span> Sending`;
        const start = performance.now();
        const retryEnabled = qs("#autoRetryToggle").checked;
        const maxAttempts = retryEnabled ? 3 : 1;
        let attempt = 0;
        let response;
        while (attempt < maxAttempts) {
          try {
            response = await doFetch(config);
            if (![502, 503, 504].includes(response.status) || attempt === maxAttempts - 1) break;
            await delay(300 * Math.pow(2, attempt));
          } catch (err) {
            if (attempt === maxAttempts - 1) throw err;
          }
          attempt += 1;
        }
        const time = Math.round(performance.now() - start);
        response.time = time;

        if (state.interceptor.enabled && state.interceptor.mode === "response") {
          state.interceptor.pendingResponse = response;
          openBreakpointModal(null, response);
        } else {
          finalizeResponse(response);
        }

        state.sending = false;
        qs("#sendBtn").disabled = false;
        qs("#sendBtn").innerHTML = `Send <span class="kbd kbd-sup">Cmd+Enter</span>`;
      };

      const doFetch = async (config) => {
        const mock = matchMock(config.url);
        if (mock) {
          await delay(mock.delay);
          return {
            status: mock.status,
            statusText: "MOCK",
            headers: { "content-type": mock.contentType },
            body: mock.body,
            size: new Blob([mock.body]).size,
            cookies: "",
            timeline: buildTimeline(120),
          };
        }
        const headers = new Headers(config.headers || {});
        const method = config.method;
        let body = null;
        if (method !== "GET" && method !== "HEAD") {
          body = config.body;
        }
        const controller = new AbortController();
        const resp = await fetch(config.url, {
          method,
          headers,
          body,
          signal: controller.signal,
          redirect: qs("#followRedirectsToggle").checked ? "follow" : "manual",
        });
        const text = await resp.text();
        const headersObj = {};
        resp.headers.forEach((val, key) => (headersObj[key] = val));
        return {
          status: resp.status,
          statusText: resp.statusText,
          headers: headersObj,
          body: text,
          size: new Blob([text]).size,
          cookies: headersObj["set-cookie"] || "",
          timeline: buildTimeline(Math.round(Math.random() * 200) + 80),
        };
      };

      const finalizeResponse = (response) => {
        updateResponseUI(response);
        pushHistory();
        updateCollectionsAudit("Response received");
      };

      const buildTimeline = (total) => {
        const dns = Math.round(total * 0.1);
        const tcp = Math.round(total * 0.2);
        const tls = Math.round(total * 0.15);
        const ttfb = Math.round(total * 0.25);
        const download = Math.round(total * 0.3);
        return [
          { label: "DNS", time: dns },
          { label: "TCP", time: tcp },
          { label: "TLS", time: tls },
          { label: "TTFB", time: ttfb },
          { label: "Download", time: download },
        ];
      };

      const updateProfiler = (response) => {
        const timeline = response.timeline || [];
        const dns = timeline[0]?.time || 0;
        const tcp = timeline[1]?.time || 0;
        const tls = timeline[2]?.time || 0;
        const ttfb = timeline[3]?.time || 0;
        const download = timeline[4]?.time || 0;
        const total = dns + tcp + tls + ttfb + download;
        qs("#profDns").textContent = dns;
        qs("#profTcp").textContent = tcp;
        qs("#profTls").textContent = tls;
        qs("#profTtfb").textContent = ttfb;
        qs("#profDownload").textContent = download;
        qs("#profTotal").textContent = total;
        const waterfall = qs("#waterfall");
        waterfall.innerHTML = "";
        [
          { label: "DNS", time: dns },
          { label: "TCP", time: tcp },
          { label: "TLS", time: tls },
          { label: "TTFB", time: ttfb },
          { label: "Download", time: download },
        ].forEach((item) => {
          const row = document.createElement("div");
          row.className = "flex items-center gap-2 text-[10px]";
          row.innerHTML = `<span class="w-20">${item.label}</span>`;
          const bar = document.createElement("div");
          bar.className = "waterfall-bar flex-1";
          const span = document.createElement("span");
          span.style.width = `${(item.time / total) * 100 || 0}%`;
          bar.appendChild(span);
          row.appendChild(bar);
          row.appendChild(document.createTextNode(`${item.time}ms`));
          waterfall.appendChild(row);
        });
      };

      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      const pushHistory = () => {
        const method = qs("#methodSelect").value;
        const url = qs("#urlInput").value.trim();
        if (!url) return;
        const entry = {
          id: Date.now(),
          method,
          url,
          status: state.lastResponse.status,
        };
        state.history.unshift(entry);
        state.history = state.history.slice(0, 50);
        sessionStorage.setItem("nebula-history", JSON.stringify(state.history));
        renderHistory();
      };

      const renderHistory = () => {
        const list = qs("#historyList");
        list.innerHTML = "";
        state.history.forEach((item) => {
          const row = document.createElement("div");
          row.className =
            "flex items-center justify-between p-2 glass panel text-[10px] hover:border-[var(--border-hover)]";
          row.innerHTML = `
            <span class="method-badge" style="background:${methodColors[item.method]}">${item.method}</span>
            <span class="truncate flex-1 mx-2">${item.url}</span>
            <span class="text-[var(--muted)]">${item.status}</span>
          `;
          row.addEventListener("click", () => {
            qs("#methodSelect").value = item.method;
            qs("#urlInput").value = item.url;
            updateMethodStyle();
          });
          list.appendChild(row);
        });
      };

      const renderCollections = () => {
        const tree = qs("#collectionTree");
        tree.innerHTML = "";
        state.collections.forEach((node) => tree.appendChild(renderNode(node)));
      };

      const renderNode = (node) => {
        const wrapper = document.createElement("div");
        if (node.type === "folder") {
          wrapper.className = "glass panel p-2";
          const header = document.createElement("div");
          header.className = "flex items-center justify-between text-[11px]";
          header.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="toggle">&#9656;</span>
              <span>${node.name}</span>
            </div>
            <div class="text-[var(--muted)]">${node.children.length}</div>
          `;
          const list = document.createElement("div");
          list.className = "ml-4 mt-2 flex flex-col gap-2";
          node.children.forEach((child) => list.appendChild(renderNode(child)));
          header.addEventListener("click", () => {
            const icon = header.querySelector(".toggle");
            const open = list.style.display !== "none";
            list.style.display = open ? "none" : "flex";
            icon.style.transform = open ? "rotate(-90deg)" : "rotate(0deg)";
          });
          wrapper.appendChild(header);
          wrapper.appendChild(list);
          wrapper.addEventListener("contextmenu", (event) => openContextMenu(event, node));
        } else {
          wrapper.className =
            "glass panel p-2 flex items-center gap-2 text-[10px] hover:border-[var(--border-hover)] cursor-pointer";
          wrapper.innerHTML = `
            <span class="method-badge" style="background:${methodColors[node.method]}">${node.method}</span>
            <span class="truncate">${node.name}</span>
          `;
          wrapper.addEventListener("click", () => {
            qs("#methodSelect").value = node.method;
            qs("#urlInput").value = node.url;
            updateMethodStyle();
          });
          wrapper.addEventListener("contextmenu", (event) => openContextMenu(event, node));
        }
        return wrapper;
      };

      const openContextMenu = (event, node) => {
        event.preventDefault();
        const menu = qs("#contextMenu");
        menu.innerHTML = "";
        const actions = [
          { label: "Rename", action: () => renameNode(node) },
          { label: "Duplicate", action: () => duplicateNode(node) },
          { label: "Delete", action: () => deleteNode(node) },
          { label: "Export JSON", action: () => exportNode(node, "json") },
          { label: "Export cURL", action: () => exportNode(node, "curl") },
        ];
        actions.forEach((item) => {
          const btn = document.createElement("button");
          btn.textContent = item.label;
          btn.addEventListener("click", () => {
            item.action();
            closeContextMenu();
          });
          menu.appendChild(btn);
        });
        menu.style.left = `${event.pageX}px`;
        menu.style.top = `${event.pageY}px`;
        menu.classList.remove("hidden");
        document.addEventListener("click", closeContextMenu, { once: true });
      };

      const closeContextMenu = () => {
        qs("#contextMenu").classList.add("hidden");
      };

      const renameNode = (node) => {
        const name = prompt("Rename", node.name || "Untitled");
        if (name) {
          node.name = name;
          updateCollectionsAudit(`Renamed ${name}`);
          saveCollections();
          renderCollections();
        }
      };

      const duplicateNode = (node) => {
        const clone = JSON.parse(JSON.stringify(node));
        clone.id = Date.now();
        if (node.type === "folder") {
          clone.name = `${node.name} Copy`;
          state.collections.push(clone);
        } else {
          state.collections.push({ ...clone, name: `${node.name} Copy` });
        }
        updateCollectionsAudit("Duplicated item");
        saveCollections();
        renderCollections();
      };

      const deleteNode = (node) => {
        const remove = (list) => {
          const idx = list.findIndex((item) => item.id === node.id);
          if (idx >= 0) list.splice(idx, 1);
          list.forEach((item) => item.type === "folder" && remove(item.children));
        };
        remove(state.collections);
        updateCollectionsAudit("Deleted item");
        saveCollections();
        renderCollections();
      };

      const exportNode = (node, format) => {
        let output = "";
        if (format === "json") {
          output = JSON.stringify(node, null, 2);
        } else {
          const method = node.method || "GET";
          const url = node.url || "";
          output = `curl -X ${method} "${url}"`;
        }
        navigator.clipboard.writeText(output);
        showToast(`Exported ${format} to clipboard`);
      };

      const saveCollections = () => {
        localStorage.setItem("nebula-collections", JSON.stringify(state.collections));
      };

      const updateCollectionsAudit = (message) => {
        const entry = `${new Date().toLocaleTimeString()} - ${message}`;
        state.audit.unshift(entry);
        state.audit = state.audit.slice(0, 50);
        localStorage.setItem("nebula-audit", JSON.stringify(state.audit));
        renderAudit();
      };

      const renderAudit = () => {
        qs("#auditLog").innerHTML = state.audit
          .map((item) => `<div class="glass panel p-2 mb-2">${item}</div>`)
          .join("");
      };

      const openModal = (modalId) => {
        modalBackdrop.classList.remove("hidden");
        modalBackdrop.classList.add("flex");
        qs(modalId).classList.remove("hidden");
      };

      const closeModal = (modalId) => {
        qs(modalId).classList.add("hidden");
        modalBackdrop.classList.add("hidden");
        modalBackdrop.classList.remove("flex");
      };

      const openBreakpointModal = (config, response) => {
        openModal("#breakpointModal");
        const modal = qs("#breakpointModal");
        modal.classList.add("breakpoint-hit");
        if (config) {
          qs("#bpMethod").value = config.method;
          qs("#bpUrl").value = config.url;
          qs("#bpHeaders").value = JSON.stringify(config.headers || {}, null, 2);
          qs("#bpBody").value = config.body || "";
        } else if (response) {
          qs("#bpMethod").value = "GET";
          qs("#bpUrl").value = `Response ${response.status}`;
          qs("#bpHeaders").value = JSON.stringify(response.headers || {}, null, 2);
          qs("#bpBody").value = response.body || "";
        }
        setupEditors();
      };

      const closeBreakpointModal = () => {
        closeModal("#breakpointModal");
        qs("#breakpointModal").classList.remove("breakpoint-hit");
      };

      const handleBreakpointResume = async () => {
        const pending = state.interceptor.pending;
        const pendingResp = state.interceptor.pendingResponse;
        if (pending) {
          const updated = {
            method: qs("#bpMethod").value,
            url: qs("#bpUrl").value,
            headers: parseJsonSafe(qs("#bpHeaders").value, {}),
            body: qs("#bpBody").value,
          };
          state.interceptor.stats.modified += JSON.stringify(updated) !== JSON.stringify(pending) ? 1 : 0;
          state.interceptor.stats.intercepted += 1;
          updateInterceptorStats();
          addInterceptorLog(updated.method, updated.url, "modified");
          closeBreakpointModal();
          state.interceptor.pending = null;
          await executeRequest(updated);
        } else if (pendingResp) {
          const updatedResp = {
            ...pendingResp,
            headers: parseJsonSafe(qs("#bpHeaders").value, pendingResp.headers),
            body: qs("#bpBody").value,
            statusText: pendingResp.statusText || "OK",
          };
          state.interceptor.stats.modified += 1;
          state.interceptor.stats.intercepted += 1;
          updateInterceptorStats();
          addInterceptorLog("RESP", pendingResp.status.toString(), "modified");
          closeBreakpointModal();
          state.interceptor.pendingResponse = null;
          finalizeResponse(updatedResp);
        }
      };

      const handleBreakpointDrop = () => {
        state.interceptor.stats.blocked += 1;
        state.interceptor.stats.intercepted += 1;
        updateInterceptorStats();
        addInterceptorLog("DROP", "Blocked", "blocked");
        state.interceptor.pending = null;
        state.interceptor.pendingResponse = null;
        closeBreakpointModal();
        showToast("Request dropped");
      };

      const updateInterceptorStats = () => {
        qs("#statIntercepted").textContent = state.interceptor.stats.intercepted;
        qs("#statModified").textContent = state.interceptor.stats.modified;
        qs("#statBlocked").textContent = state.interceptor.stats.blocked;
      };

      const addInterceptorLog = (method, url, status) => {
        const entry = {
          id: Date.now(),
          method,
          url,
          status,
        };
        state.interceptor.log.unshift(entry);
        state.interceptor.log = state.interceptor.log.slice(0, 20);
        renderInterceptorLog();
      };

      const renderInterceptorLog = () => {
        const list = qs("#interceptorLog");
        list.innerHTML = "";
        state.interceptor.log.forEach((entry) => {
          const row = document.createElement("div");
          row.className = "glass panel p-2 text-[10px] flex items-center gap-2";
          row.innerHTML = `
            <span class="method-badge" style="background:${methodColors[entry.method] || "#b4befe"}">${entry.method}</span>
            <span class="truncate flex-1">${entry.url}</span>
            <span class="badge-dot" style="background:${entry.status === "blocked" ? "var(--red)" : "var(--green)"}"></span>
          `;
          list.appendChild(row);
        });
      };

      const initCharts = () => {
        const latencyCtx = qs("#latencyChart").getContext("2d");
        const rpsCtx = qs("#rpsChart").getContext("2d");
        state.charts.latency = new Chart(latencyCtx, {
          type: "bar",
          data: {
            labels: ["0-50", "50-100", "100-200", "200-500", "500+"],
            datasets: [
              {
                data: [0, 0, 0, 0, 0],
                backgroundColor: ["#a6e3a1", "#89b4fa", "#f9e2af", "#fab387", "#f38ba8"],
                borderRadius: 6,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } }, y: { display: false } },
          },
        });
        state.charts.rps = new Chart(rpsCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                borderColor: "#b4befe",
                backgroundColor: "rgba(180, 190, 254, 0.2)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { x: { display: false }, y: { display: false } },
          },
        });
      };

      const startLoadTest = () => {
        if (state.loadTest.running) return;
        state.loadTest.running = true;
        state.loadTest.progress = 0;
        state.loadTest.results = [];
        qs("#loadResultsTable").innerHTML = "";
        const total = Number(qs("#loadTotal").value || 1);
        const startTime = Date.now();
        state.loadTest.timer = setInterval(() => {
          if (!state.loadTest.running) return;
          state.loadTest.progress += 1;
          const progressPercent = Math.min(100, Math.round((state.loadTest.progress / total) * 100));
          qs("#loadProgress").style.width = `${progressPercent}%`;
          qs("#loadProgressText").textContent = `${progressPercent}%`;
          const rps = Math.round(Math.random() * 200 + 50);
          const avg = Math.round(Math.random() * 200 + 80);
          const p95 = Math.round(avg + Math.random() * 120);
          const min = Math.round(avg - Math.random() * 50);
          const max = Math.round(avg + Math.random() * 200);
          const errorRate = Math.round(Math.random() * 5);
          const throughput = Math.round(Math.random() * 900 + 120);
          qs("#metricRps").textContent = rps;
          qs("#metricAvg").textContent = `${avg} ms`;
          qs("#metricMin").textContent = min;
          qs("#metricMax").textContent = max;
          qs("#metricP95").textContent = `${p95} ms`;
          qs("#metricError").textContent = `${errorRate}%`;
          qs("#metricThroughput").textContent = `${throughput} KB/s`;

          const latencyData = [
            Math.round(Math.random() * 40 + 20),
            Math.round(Math.random() * 30 + 10),
            Math.round(Math.random() * 20 + 5),
            Math.round(Math.random() * 10 + 2),
            Math.round(Math.random() * 5 + 1),
          ];
          state.charts.latency.data.datasets[0].data = latencyData;
          state.charts.latency.update();
          state.charts.rps.data.labels.push(progressPercent);
          state.charts.rps.data.datasets[0].data.push(rps);
          if (state.charts.rps.data.labels.length > 20) {
            state.charts.rps.data.labels.shift();
            state.charts.rps.data.datasets[0].data.shift();
          }
          state.charts.rps.update();
          const status = errorRate > 0 ? "ERR" : "OK";
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${state.loadTest.progress}</td>
            <td style="color:${status === "OK" ? "var(--green)" : "var(--red)"}">${status}</td>
            <td>${avg}</td>
            <td>${Math.round(Math.random() * 5 + 1)} KB</td>
            <td>${new Date().toLocaleTimeString()}</td>
          `;
          qs("#loadResultsTable").appendChild(row);
          if (state.loadTest.progress >= total) {
            stopLoadTest();
          }
        }, 500);
        showToast("Load test started");
      };

      const stopLoadTest = () => {
        state.loadTest.running = false;
        clearInterval(state.loadTest.timer);
        showToast("Load test stopped");
      };

      const initWebSocket = () => {
        if (state.ws.socket) {
          state.ws.socket.close();
        }
        const url = qs("#wsUrl").value.trim();
        if (!url) {
          showToast("Enter a WebSocket URL", "error");
          return;
        }
        const socket = new WebSocket(url);
        state.ws.socket = socket;
        qs("#wsStatusText").textContent = "Connecting...";
        qs("#wsStatusDot").classList.add("pulse");
        socket.onopen = () => {
          qs("#wsStatusText").textContent = "Connected";
          qs("#wsStatusDot").style.background = "var(--green)";
          qs("#wsStatusDot").classList.remove("pulse");
        };
        socket.onclose = () => {
          qs("#wsStatusText").textContent = "Disconnected";
          qs("#wsStatusDot").style.background = "var(--muted)";
          qs("#wsStatusDot").classList.remove("pulse");
        };
        socket.onerror = () => {
          showToast("WebSocket error", "error");
        };
        socket.onmessage = (event) => {
          state.ws.received += 1;
          qs("#wsReceived").textContent = state.ws.received;
          appendWsLog("in", event.data);
        };
      };

      const appendWsLog = (direction, message) => {
        const log = qs("#wsLog");
        const time = new Date().toLocaleTimeString();
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        const arrow = direction === "out" ? "&rarr;" : "&larr;";
        const color = direction === "out" ? "var(--blue)" : "var(--green)";
        row.innerHTML = `<span class="text-[var(--muted)]">[${time}]</span> <span style="color:${color}">${arrow}</span> <span>${escapeHtml(message)}</span>`;
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      };

      const sendWsMessage = () => {
        if (!state.ws.socket || state.ws.socket.readyState !== 1) {
          showToast("WebSocket not connected", "error");
          return;
        }
        const format = qs("#wsFormat").value;
        let msg = qs("#wsEditor").value;
        if (format === "json") {
          try {
            msg = JSON.stringify(JSON.parse(msg));
          } catch (err) {
            showToast("Invalid JSON", "error");
            return;
          }
        }
        state.ws.socket.send(msg);
        state.ws.sent += 1;
        qs("#wsSent").textContent = state.ws.sent;
        appendWsLog("out", msg);
      };

      const loadStorage = () => {
        const savedCollections = localStorage.getItem("nebula-collections");
        state.collections = savedCollections
          ? JSON.parse(savedCollections)
          : [
              {
                id: 1,
                type: "folder",
                name: "Sample",
                children: [
                  {
                    id: 2,
                    type: "request",
                    name: "List Users",
                    method: "GET",
                    url: "https://jsonplaceholder.typicode.com/users",
                  },
                ],
              },
            ];
        state.history = JSON.parse(sessionStorage.getItem("nebula-history") || "[]");
        state.audit = JSON.parse(localStorage.getItem("nebula-audit") || "[]");
        state.mocks = JSON.parse(localStorage.getItem("nebula-mocks") || "[]");
        state.comments = JSON.parse(localStorage.getItem("nebula-comments") || "[]");
      };

      const renderFavorites = () => {
        const list = qs("#favoritesList");
        list.innerHTML = "";
        state.favorites.forEach((fav) => {
          const row = document.createElement("div");
          row.className = "glass panel p-2 text-[10px]";
          row.textContent = fav.name;
          list.appendChild(row);
        });
      };

      const renderMocks = () => {
        const list = qs("#mockList");
        list.innerHTML = "";
        state.mocks.forEach((mock, idx) => {
          const row = document.createElement("div");
          row.className = "glass panel p-2 text-[10px] mb-2";
          row.innerHTML = `
            <div class="flex items-center justify-between">
              <span>${mock.route}</span>
              <button class="btn-icon" data-idx="${idx}">&#10005;</button>
            </div>
            <div class="text-[var(--muted)]">Status ${mock.status} | ${mock.delay}ms</div>
          `;
          row.querySelector("button").addEventListener("click", () => {
            state.mocks.splice(idx, 1);
            localStorage.setItem("nebula-mocks", JSON.stringify(state.mocks));
            renderMocks();
          });
          list.appendChild(row);
        });
      };

      const matchMock = (url) => {
        if (!state.mocks.length) return null;
        const parsed = new URL(url, window.location.origin);
        for (const mock of state.mocks) {
          const routeRegex = new RegExp(
            "^" + mock.route.replace(/:[^/]+/g, "([^/]+)") + "$"
          );
          const match = parsed.pathname.match(routeRegex);
          if (match) {
            const params = {};
            const keys = (mock.route.match(/:([^/]+)/g) || []).map((k) => k.slice(1));
            keys.forEach((key, idx) => (params[key] = match[idx + 1]));
            let body = mock.body;
            Object.entries(params).forEach(([k, v]) => {
              body = body.replace(new RegExp(`\\{\\{params.${k}\\}\\}`, "g"), v);
            });
            return { ...mock, body };
          }
        }
        return null;
      };

      const openEnvModal = () => {
        renderEnvTables();
        openModal("#envModal");
      };

      const renderEnvTables = () => {
        renderVarTable("globalsTable", state.env.globals);
        renderVarTable("envTable", state.env.environments[state.env.current]);
        renderVarTable("sessionTable", state.env.session);
      };

      const renderVarTable = (id, store) => {
        const container = qs(`#${id}`);
        container.innerHTML = "";
        Object.entries(store).forEach(([key, value]) => {
          const row = document.createElement("div");
          row.className = "flex items-center gap-2";
          row.innerHTML = `
            <input class="input w-1/2" value="${key}" data-key="key" />
            <input class="input w-1/2" value="${value}" data-key="value" />
          `;
          container.appendChild(row);
        });
      };

      const saveEnvModal = () => {
        state.env.globals = collectVarTable("globalsTable");
        state.env.environments[state.env.current] = collectVarTable("envTable");
        state.env.session = collectVarTable("sessionTable");
        localStorage.setItem("nebula-envs", JSON.stringify(state.env));
        closeModal("#envModal");
        showToast("Environment saved");
      };

      const collectVarTable = (id) => {
        const data = {};
        qsa(`#${id} .flex`).forEach((row) => {
          const key = row.querySelector('[data-key="key"]').value.trim();
          const value = row.querySelector('[data-key="value"]').value.trim();
          if (key) data[key] = value;
        });
        return data;
      };

      const initAutocomplete = () => {
        const inputs = [qs("#urlInput"), qs("#paramsEditor"), qs("#headersEditor"), qs("#bodyEditor")];
        inputs.forEach((input) => {
          input.addEventListener(
            "keyup",
            debounce((event) => {
              const value = input.value;
              const cursor = input.selectionStart || value.length;
              const prefix = value.slice(Math.max(0, cursor - 2), cursor);
              if (prefix === "{{") {
                showAutocomplete(input);
              }
            }, 150)
          );
        });
      };

      const showAutocomplete = (input) => {
        const vars = {
          ...state.env.globals,
          ...state.env.environments[state.env.current],
          ...state.env.session,
        };
        autocomplete.innerHTML = "";
        Object.keys(vars).forEach((key) => {
          const btn = document.createElement("button");
          btn.textContent = key;
          btn.addEventListener("click", () => {
            const cursor = input.selectionStart || input.value.length;
            const value = input.value;
            input.value = value.slice(0, cursor) + key + "}}" + value.slice(cursor);
            autocomplete.classList.add("hidden");
            input.focus();
          });
          autocomplete.appendChild(btn);
        });
        const rect = input.getBoundingClientRect();
        autocomplete.style.left = `${rect.left}px`;
        autocomplete.style.top = `${rect.bottom + 4}px`;
        autocomplete.classList.remove("hidden");
      };

      const generateDocs = () => {
        let markdown = "# API Documentation\n\n";
        state.collections.forEach((node) => {
          if (node.type === "folder") {
            markdown += `## ${node.name}\n`;
            node.children.forEach((req) => {
              markdown += `### ${req.name}\n- Method: ${req.method}\n- URL: ${req.url}\n\n`;
            });
          }
        });
        qs("#docsEditor").value = markdown;
        qs("#docsPreview").srcdoc = `<pre>${escapeHtml(markdown)}</pre>`;
        setupEditors();
      };

      const compareDiff = () => {
        const left = qs("#diffLeft").value;
        const right = qs("#diffRight").value;
        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(left, right);
        dmp.diff_cleanupSemantic(diffs);
        const diffHtml = dmp.diff_prettyHtml(diffs)
          .replace(/&para;/g, "")
          .replace(/<ins/g, '<ins style="background: rgba(166,227,161,0.2)"')
          .replace(/<del/g, '<del style="background: rgba(243,139,168,0.2)"');
        qs("#diffOutput").innerHTML = diffHtml;
      };

      const addChainStep = () => {
        const step = {
          id: Date.now(),
          method: "GET",
          url: "",
          extractPath: "",
          variable: "",
        };
        state.chain.steps.push(step);
        renderChainSteps();
      };

      const renderChainSteps = () => {
        const container = qs("#chainSteps");
        container.innerHTML = "";
        state.chain.steps.forEach((step, idx) => {
          const row = document.createElement("div");
          row.className = "glass panel p-3 grid md:grid-cols-4 gap-2 text-[10px]";
          row.innerHTML = `
            <select class="input" data-step="${idx}" data-field="method">
              ${Object.keys(methodColors)
                .map((m) => `<option value="${m}" ${m === step.method ? "selected" : ""}>${m}</option>`)
                .join("")}
            </select>
            <input class="input mono" data-step="${idx}" data-field="url" value="${step.url}" placeholder="URL" />
            <input class="input mono" data-step="${idx}" data-field="extractPath" value="${step.extractPath}" placeholder="JSONPath $.data.id" />
            <input class="input mono" data-step="${idx}" data-field="variable" value="${step.variable}" placeholder="Variable name" />
          `;
          container.appendChild(row);
        });
      };

      const runChain = async () => {
        const log = qs("#chainLog");
        log.innerHTML = "";
        for (const step of state.chain.steps) {
          const config = {
            method: step.method,
            url: replaceVariables(step.url),
            headers: parseJsonSafe(qs("#headersEditor").value, {}),
            body: qs("#bodyEditor").value,
          };
          try {
            const response = await doFetch(config);
            log.innerHTML += `<div>${step.method} ${config.url} -> ${response.status}</div>`;
            if (step.extractPath && step.variable) {
              const extracted = extractJsonPath(response.body, step.extractPath);
              state.env.session[step.variable] = extracted ?? "";
              log.innerHTML += `<div class="text-[var(--muted)]">Set {{${step.variable}}} = ${extracted}</div>`;
            }
          } catch (err) {
            log.innerHTML += `<div class="text-[var(--red)]">Error: ${err.message}</div>`;
            break;
          }
        }
        showToast("Chain complete");
      };

      const extractJsonPath = (body, path) => {
        try {
          const obj = JSON.parse(body);
          const parts = path.replace(/^\$\./, "").split(".");
          let current = obj;
          for (const part of parts) {
            const match = part.match(/(\w+)\[(\d+)\]/);
            if (match) {
              current = current[match[1]][Number(match[2])];
            } else {
              current = current[part];
            }
            if (current === undefined) return null;
          }
          return current;
        } catch (err) {
          return null;
        }
      };

      const runSecurityScan = () => {
        const results = [];
        const body = state.lastResponse.body || "";
        if (/<script|onerror|onload/i.test(body)) results.push("Potential XSS found");
        if (/sql|syntax error|ORA-\d+/i.test(body)) results.push("Possible SQL error leak");
        const payload = qs("#scanPayload").value;
        if (payload && body.includes(payload)) results.push("Payload echoed in response");
        const jwt = qs("#jwtInput").value.trim();
        if (jwt.split(".").length === 3) {
          try {
            const payloadData = JSON.parse(atob(jwt.split(".")[1]));
            results.push(`JWT exp: ${payloadData.exp || "n/a"}`);
          } catch (err) {
            results.push("JWT parse failed");
          }
        }
        if (!results.length) results.push("No critical issues detected");
        qs("#scanResults").innerHTML = results.map((r) => `<div class="glass panel p-2">${r}</div>`).join("");
      };

      const generateData = () => {
        const template = qs("#dataTemplate").value;
        let output = template;
        output = output.replace(/\{\{faker\.([^}]+)\}\}/g, (match, path) => {
          const parts = path.split(".");
          let ref = faker;
          parts.forEach((p) => {
            ref = ref?.[p];
          });
          if (typeof ref === "function") {
            return ref();
          }
          return "";
        });
        qs("#dataOutput").textContent = output;
      };

      const addMock = () => {
        const route = qs("#mockRoute").value.trim();
        if (!route) return;
        const mock = {
          route,
          status: Number(qs("#mockStatus").value || 200),
          delay: Number(qs("#mockDelay").value || 0),
          contentType: qs("#mockContentType").value || "application/json",
          body: qs("#mockBody").value || "",
        };
        state.mocks.push(mock);
        localStorage.setItem("nebula-mocks", JSON.stringify(state.mocks));
        renderMocks();
        showToast("Mock added");
      };

      const generateShareLink = () => {
        const config = buildRequestConfig();
        const encoded = btoa(JSON.stringify(config));
        const url = `${window.location.origin}${window.location.pathname}#${encoded}`;
        qs("#shareLink").value = url;
        navigator.clipboard.writeText(url);
        showToast("Share link copied");
      };

      const addComment = () => {
        const value = qs("#commentInput").value.trim();
        if (!value) return;
        const entry = `${new Date().toLocaleTimeString()} - ${value}`;
        state.comments.unshift(entry);
        state.comments = state.comments.slice(0, 50);
        localStorage.setItem("nebula-comments", JSON.stringify(state.comments));
        qs("#commentInput").value = "";
        renderComments();
      };

      const renderComments = () => {
        qs("#commentList").innerHTML = state.comments
          .map((item) => `<div class="glass panel p-2 mb-2">${item}</div>`)
          .join("");
      };

      const parseImport = () => {
        const value = qs("#importInput").value.trim();
        if (!value) return;
        if (value.startsWith("curl")) {
          const urlMatch = value.match(/"(https?:[^"]+)"/);
          const url = urlMatch ? urlMatch[1] : "";
          const methodMatch = value.match(/-X\s+(\w+)/);
          const method = methodMatch ? methodMatch[1] : "GET";
          state.collections.push({
            id: Date.now(),
            type: "request",
            name: "Imported cURL",
            method,
            url,
          });
          saveCollections();
          renderCollections();
        } else {
          try {
            const data = JSON.parse(value);
            if (data.item) {
              const folder = {
                id: Date.now(),
                type: "folder",
                name: data.info?.name || "Postman Import",
                children: data.item.map((item) => ({
                  id: Date.now() + Math.random(),
                  type: "request",
                  name: item.name,
                  method: item.request?.method || "GET",
                  url: item.request?.url?.raw || "",
                })),
              };
              state.collections.push(folder);
              saveCollections();
              renderCollections();
            }
          } catch (err) {
            showToast("Import failed", "error");
          }
        }
        closeModal("#importModal");
      };

      const applyShortcuts = (event) => {
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "p") {
          event.preventDefault();
          openModal("#commandPalette");
        }
        if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
          event.preventDefault();
          sendRequest();
        }
        if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key.toLowerCase() === "c") {
          event.preventDefault();
          qs("#responseContent").textContent = "";
        }
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "s") {
          event.preventDefault();
          saveCurrentToCollection();
        }
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "l") {
          event.preventDefault();
          qs("#urlInput").focus();
        }
        if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key.toLowerCase() === "f") {
          event.preventDefault();
          formatBody();
        }
        if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "i") {
          event.preventDefault();
          toggleInterceptor();
        }
        if (event.key === "F10") {
          if (!qs("#breakpointModal").classList.contains("hidden")) {
            handleBreakpointResume();
          }
        }
        if (event.key === " ") {
          if (state.mode === "load") {
            event.preventDefault();
            state.loadTest.running ? stopLoadTest() : startLoadTest();
          }
        }
        if (event.key === "Escape") {
          if (state.loadTest.running) stopLoadTest();
        }
      };

      const saveCurrentToCollection = () => {
        const config = buildRequestConfig();
        state.collections.push({
          id: Date.now(),
          type: "request",
          name: config.url || "Untitled",
          method: config.method,
          url: config.url,
        });
        saveCollections();
        renderCollections();
        updateCollectionsAudit("Saved request");
        showToast("Saved to collection");
      };

      const formatBody = () => {
        const editor = qs("#bodyEditor");
        try {
          editor.value = JSON.stringify(JSON.parse(editor.value), null, 2);
          setupEditors();
        } catch (err) {
          editor.classList.add("shake");
          showToast("Invalid JSON to format", "error");
          setTimeout(() => editor.classList.remove("shake"), 400);
        }
      };

      const toggleInterceptor = () => {
        state.interceptor.enabled = !state.interceptor.enabled;
        qs("#interceptorIndicator").style.opacity = state.interceptor.enabled ? 1 : 0;
        showToast(`Interceptor ${state.interceptor.enabled ? "enabled" : "disabled"}`);
      };

      const setupTabs = () => {
        qsa(".tabs").forEach((tabGroup) => {
          tabGroup.addEventListener("click", (event) => {
            const btn = event.target.closest(".tab-btn");
            if (!btn) return;
            const tab = btn.dataset.tab;
            const panelPrefix = tab.startsWith("resp") ? "tab-resp" : "tab";
            qsa(".tab-btn", tabGroup).forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            const container = tabGroup.parentElement;
            qsa(".tab-panel", container).forEach((panel) => panel.classList.add("hidden"));
            const panel = qs(`#${panelPrefix}-${tab.replace("resp-", "")}`) || qs(`#tab-${tab}`);
            if (panel) panel.classList.remove("hidden");
          });
        });
      };

      const copyResponse = () => {
        navigator.clipboard.writeText(state.lastResponse.body || "");
        showToast("Response copied");
      };

      const handleFileDrop = () => {
        const dropZone = qs("#fileDropZone");
        dropZone.addEventListener("dragover", (event) => {
          event.preventDefault();
          dropZone.classList.add("dragover");
        });
        dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
        dropZone.addEventListener("drop", (event) => {
          event.preventDefault();
          dropZone.classList.remove("dragover");
          const file = event.dataTransfer.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = () => {
              qs("#bodyEditor").value = reader.result;
              setupEditors();
            };
            reader.readAsText(file);
            showToast(`Loaded ${file.name}`);
          }
        });
      };

      const setupGraphql = () => {
        qs("#graphqlIntrospectBtn").addEventListener("click", async () => {
          const url = qs("#graphqlUrl").value.trim();
          if (!url) return showToast("Enter GraphQL URL", "error");
          const query = `query IntrospectionQuery {
            __schema {
              queryType { name }
              mutationType { name }
              subscriptionType { name }
              types { name kind fields { name } }
            }
          }`;
          try {
            const res = await fetch(url, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ query }),
            });
            const data = await res.json();
            const types = data.data?.__schema?.types || [];
            qs("#gqlSchemaList").innerHTML = types
              .filter((t) => t.fields && t.fields.length)
              .map((t) => `<div class="glass panel p-2 mb-2"><div class="font-semibold">${t.name}</div><div class="text-[10px] text-[var(--muted)]">${t.fields
                .map((f) => f.name)
                .join(", ")}</div></div>`)
              .join("");
            qs("#gqlSchemaStatus").textContent = "Loaded";
            showToast("Schema loaded");
          } catch (err) {
            showToast("Schema load failed", "error");
          }
        });
        qs("#graphqlSendBtn").addEventListener("click", async () => {
          const url = qs("#graphqlUrl").value.trim();
          if (!url) return showToast("Enter GraphQL URL", "error");
          const query = qs("#gqlQueryEditor").value;
          const variables = parseJsonSafe(qs("#gqlVarsEditor").value, {});
          try {
            const res = await fetch(url, {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ query, variables }),
            });
            const data = await res.json();
            qs("#gqlResult").textContent = JSON.stringify(data, null, 2);
          } catch (err) {
            qs("#gqlResult").textContent = err.message;
          }
        });
      };

      const setupEvents = () => {
        qs("#methodSelect").addEventListener("change", updateMethodStyle);
        qs("#sendBtn").addEventListener("click", sendRequest);
        qs("#clearUrlBtn").addEventListener("click", () => (qs("#urlInput").value = ""));
        qs("#saveRequestBtn").addEventListener("click", saveCurrentToCollection);
        qs("#copyResponseBtn").addEventListener("click", copyResponse);
        qs("#clearResponseBtn").addEventListener("click", () => (qs("#responseContent").textContent = ""));
        qs("#formatBodyBtn").addEventListener("click", formatBody);
        qs("#interceptorToggle").addEventListener("click", toggleInterceptor);
        qs("#interceptorMode").addEventListener("change", (event) => {
          state.interceptor.mode = event.target.value;
        });
        qs("#commandBtn").addEventListener("click", () => openModal("#commandPalette"));
        qs("#shortcutBtn").addEventListener("click", () => showToast("Shortcuts panel is in sidebar"));
        qs("#envSelect").addEventListener("change", (event) => {
          state.env.current = event.target.value;
          qs("#envIndicator").textContent = state.env.current;
        });
        qs("#editEnvBtn").addEventListener("click", openEnvModal);
        qs("#envSaveBtn").addEventListener("click", saveEnvModal);
        qs("#envCloseBtn").addEventListener("click", () => closeModal("#envModal"));
        qs("#importBtn").addEventListener("click", () => openModal("#importModal"));
        qs("#importCloseBtn").addEventListener("click", () => closeModal("#importModal"));
        qs("#importSubmitBtn").addEventListener("click", parseImport);
        qs("#clearHistoryBtn").addEventListener("click", () => {
          state.history = [];
          sessionStorage.removeItem("nebula-history");
          renderHistory();
        });
        qs("#bpResumeBtn").addEventListener("click", handleBreakpointResume);
        qs("#bpDropBtn").addEventListener("click", handleBreakpointDrop);
        qs("#bpAbortBtn").addEventListener("click", closeBreakpointModal);
        qs("#loadStartBtn").addEventListener("click", startLoadTest);
        qs("#loadCancelBtn").addEventListener("click", stopLoadTest);
        qs("#exportCsvBtn").addEventListener("click", () => {
          const rows = qsa("#loadResultsTable tr");
          const csv = rows.map((row) => Array.from(row.children).map((c) => c.textContent).join(",")).join("\n");
          navigator.clipboard.writeText(csv);
          showToast("CSV copied");
        });
        qs("#wsConnectBtn").addEventListener("click", initWebSocket);
        qs("#wsDisconnectBtn").addEventListener("click", () => state.ws.socket?.close());
        qs("#wsSendBtn").addEventListener("click", sendWsMessage);
        qs("#wsClearLog").addEventListener("click", () => (qs("#wsLog").innerHTML = ""));
        qs("#wsPingBtn").addEventListener("click", () => {
          qs("#wsEditor").value = '{ "type": "ping" }';
          sendWsMessage();
        });
        qsa(".ws-template").forEach((btn) => {
          btn.addEventListener("click", () => {
            qs("#wsEditor").value = btn.dataset.template;
            setupEditors();
          });
        });
        qs("#docsGenerateBtn").addEventListener("click", generateDocs);
        qs("#docsExportMdBtn").addEventListener("click", () => {
          navigator.clipboard.writeText(qs("#docsEditor").value || "");
          showToast("Markdown copied");
        });
        qs("#docsExportHtmlBtn").addEventListener("click", () => {
          const html = `<html><body><pre>${escapeHtml(qs("#docsEditor").value || "")}</pre></body></html>`;
          navigator.clipboard.writeText(html);
          showToast("HTML copied");
        });
        qs("#diffCompareBtn").addEventListener("click", compareDiff);
        qs("#diffSaveBtn").addEventListener("click", () => showToast("Snapshot saved"));
        qs("#chainAddBtn").addEventListener("click", addChainStep);
        qs("#chainRunBtn").addEventListener("click", runChain);
        qs("#scanBtn").addEventListener("click", runSecurityScan);
        qs("#dataGenerateBtn").addEventListener("click", generateData);
        qs("#mockAddBtn").addEventListener("click", addMock);
        qs("#shareBtn").addEventListener("click", generateShareLink);
        qs("#commentAddBtn").addEventListener("click", addComment);
        qs("#sidebarToggle").addEventListener("click", () => qs("#sidebar").classList.toggle("open"));
        document.addEventListener("keydown", applyShortcuts);
        qsa(".mode-switcher button").forEach((btn) => {
          btn.addEventListener("click", () => setMode(btn.dataset.mode));
        });
        qsa(".add-var-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.dataset.scope;
            const map = target === "globals" ? state.env.globals : target === "env" ? state.env.environments[state.env.current] : state.env.session;
            map[`key${Object.keys(map).length + 1}`] = "";
            renderEnvTables();
          });
        });
        qs("#commandSearch").addEventListener(
          "input",
          debounce((event) => {
            const query = event.target.value.toLowerCase();
            renderCommandList(query);
          }, 100)
        );
        qs("#commandSearch").addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            executeCommand(event.target.value);
          }
        });
        handleFileDrop();
      };

      const renderCommandList = (query = "") => {
        const commands = [
          { label: "Send Request", action: sendRequest },
          { label: "Toggle Interceptor", action: toggleInterceptor },
          { label: "Open Env Manager", action: openEnvModal },
          { label: "Generate Docs", action: generateDocs },
          { label: "Start Load Test", action: startLoadTest },
        ];
        qs("#commandList").innerHTML = commands
          .filter((cmd) => cmd.label.toLowerCase().includes(query))
          .map((cmd) => `<button class="btn btn-secondary">${cmd.label}</button>`)
          .join("");
        qsa("#commandList button").forEach((btn, idx) => {
          btn.addEventListener("click", () => {
            commands[idx].action();
            closeModal("#commandPalette");
          });
        });
      };

      const executeCommand = (input) => {
        const lower = input.toLowerCase();
        if (lower.includes("send")) sendRequest();
        if (lower.includes("interceptor")) toggleInterceptor();
        if (lower.includes("docs")) generateDocs();
        closeModal("#commandPalette");
      };

      const initFromShare = () => {
        if (!window.location.hash) return;
        try {
          const decoded = atob(window.location.hash.slice(1));
          const config = JSON.parse(decoded);
          qs("#methodSelect").value = config.method || "GET";
          qs("#urlInput").value = config.url || "";
          qs("#headersEditor").value = JSON.stringify(config.headers || {}, null, 2);
          qs("#bodyEditor").value = config.body || "";
          setupEditors();
          updateMethodStyle();
          showToast("Loaded shared request");
        } catch (err) {
          showToast("Invalid share link", "error");
        }
      };

      const init = () => {
        loadStorage();
        renderCollections();
        renderHistory();
        renderFavorites();
        renderMocks();
        renderAudit();
        renderComments();
        setupEditors();
        setupTabs();
        setupEvents();
        initAutocomplete();
        initCharts();
        updateMethodStyle();
        updateCounts();
        renderCommandList();
        setupGraphql();
        initFromShare();
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
-->
